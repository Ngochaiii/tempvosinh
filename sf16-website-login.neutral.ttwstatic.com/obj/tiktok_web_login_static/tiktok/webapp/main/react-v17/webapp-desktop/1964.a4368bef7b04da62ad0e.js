"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[1964],{19145:(e,t,s)=>{s.d(t,{US:()=>c,n4:()=>u,pt:()=>d});var i=s(35762),n=s(17384),o=s(1183),r=s(64388),a=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const d=(0,o.p)("conversationTagAtom@tiktok/webapp-atoms",{allConversationTagGroupList:[],allConversationTagList:[],selectedConversationTagList:[],unreadOnly:!1,isLoading:!0}),{useServiceState:l,useServiceDispatchers:c,useAtomService:u,getStaticApi:g}=(0,r.i)(d,(e,t)=>({setSelectedConversationTagList(e){t(d,t=>Object.assign(Object.assign({},t),{selectedConversationTagList:e}))},setAllConversationTagGroupList(e){t(d,t=>Object.assign(Object.assign({},t),{allConversationTagGroupList:e}))},setAllConversationTagList(e){t(d,t=>Object.assign(Object.assign({},t),{allConversationTagList:e}))},setUnreadOnly(e){t(d,t=>Object.assign(Object.assign({},t),{unreadOnly:e}))},setLoading(e){t(d,t=>Object.assign(Object.assign({},t),{isLoading:e}))},getAllConversationTags(){var e;return a(this,void 0,void 0,function*(){try{t(d,e=>Object.assign(Object.assign({},e),{isLoading:!0}));const s=yield a(void 0,void 0,void 0,function*(){return i.h.get("/api/ba/business/suite/contact/label/mapping",{baseUrlType:n.Z4.FixedWww})}),o=null!==(e=s.label_groups)&&void 0!==e?e:[],r=o.filter(e=>e.labels&&e.labels.length>0).map(e=>e.labels).flat(2);this.setAllConversationTagGroupList(o),this.setAllConversationTagList(r)}catch(e){}finally{t(d,e=>Object.assign(Object.assign({},e),{isLoading:!1}))}})}}))},19578:(e,t,s)=>{s.d(t,{EL:()=>v,L_:()=>h,Sk:()=>p,YK:()=>g,py:()=>f});var i=s(1183),n=s(64388),o=s(46833),r=s(16356),a=s(35762),d=s(17384),l=s(48156),c=s(38335),u=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const g=(0,i.p)("messageUserAtom@tiktok/webapp-atoms",{users:{}}),{useServiceState:v,useServiceDispatchers:h,useAtomService:p,getStaticApi:f}=(0,n.i)(g,(e,t)=>({getUser(t){const s=e(g),{users:i}=s;return i[t]},multiSetUsers(s){const i=e(g),{users:n}=i;t(g,{users:Object.assign(Object.assign({},n),s)})},setUserRelation({uid:s,relation:i}){const n=e(g),{users:o}=n,r=n.users[s];if(!r)return;const a=Object.assign(Object.assign({},r),{relation:i}),d=Object.assign({},o);d[s]=a,t(g,{users:Object.assign({},d)})},blockUser(t){var s;return u(this,void 0,void 0,function*(){try{const{uid:n,isBlock:v}=t,h=e(g),{users:p}=h,{uniqueId:f=""}=null!==(s=p[n])&&void 0!==s?s:{},y=(0,c.T)(),m=yield(i={user_id:n,block_type:v?1:0},u(void 0,void 0,void 0,function*(){return a.h.post("/aweme/v1/user/block/",{query:Object.assign(Object.assign({},i),{source:3}),baseUrlType:d.Z4.FixedWww,headers:{[d.nk]:a.h.csrfToken}})})),{status_code:M}=m;if(0!==M)return void l.F.open({content:y("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"});const b=v?o.yf.BLOCK:o.yf.NONE;this.setUserRelation({uid:n,relation:b}),(0,r.Gp)().setUserRelation({uniqueId:f,relation:b})}catch(e){console.log("block has error",e);const t=(0,c.T)();l.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"})}var i})}}))},41221:(e,t,s)=>{s.d(t,{A5:()=>v,I9:()=>h,Ye:()=>p,fI:()=>m,rp:()=>f});var i=s(1183),n=s(64388),o=s(48156),r=s(38335),a=s(79161),d=s(19145),l=s(85214),c=s(73976),u=s(2232),g=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const v=1,h=(0,i.p)("imSdkAtom@tiktok/webapp-atoms",{instance:void 0,options:void 0,friendsCursor:"0",groupCursor:"0",strangerCursor:"0",conversationTagCursor:"0",hasMoreFriends:!0,hasMoreGroup:!0,hasMoreStranger:!0,hasMoreConversationTag:!0,isFromBusiness:!1}),{useServiceState:p,useServiceDispatchers:f,useAtomService:y,getStaticApi:m}=(0,n.i)(h,(e,t)=>({getInstance(){const{instance:t}=e(h);return t},initSdk(i,n){var a,d;return g(this,void 0,void 0,function*(){try{{const o=yield Promise.all([s.e(4488),s.e(6489),s.e(3305),s.e(6706),s.e(8904),s.e(1960),s.e(4835),s.e(6483),s.e(759),s.e(4685),s.e(694),s.e(4714),s.e(1377),s.e(1798)]).then(s.bind(s,15226)),{instance:r}=e(h);if(r)return;const l="v2"===(null!==(a=(0,u.V7)(n,"web_dm_share_panel_fix"))&&void 0!==a?a:"v1"),p=null!==(d=(0,u.V7)(n,"web_dm_combo"))&&void 0!==d?d:"v1",{BytedIM:f,ExtensionPlugin:y,StrangerPlugin:m,MultimediaPlugin:M,ComboPlugin:b,im_proto:S,IMEvent:C,InitResult:O}=o;i.authType=S.AuthType.SESSION_AUTH;const _=[y,m,M];"v2"===p&&(_.push(b),i.enableOptimizedPull=!0),"v3"===p&&(_.push(b),i.enableOptimizedPull=!0,i.enablePassivePullControl=!0),t(h,e=>Object.assign(Object.assign({},e),{options:i,instance:new f(i,_)}));const{options:I,instance:L}=e(h);if(!(null==L?void 0:L.event))throw new Error("[IM SDK] init failed!");[C.ConversationChange,C.MessageSend,C.ReceiveNewMessage,C.MessageDelete,C.MessagePropertyUpsert,C.ConversationLeave,C.MessageUpsert,C.RefreshMessage,C.ConversationUpsert,C.StrangerUpgrade,C.ConversationDelete].forEach(e=>{L.event.subscribe(e,t=>g(this,void 0,void 0,function*(){yield null==I?void 0:I.eventListener({event:e,params:t,uid:I.userId})}))});const T=yield L.init();return T===O.Succeeded&&((0,c.YJ)().setListLoading(!0),l?(this.loadFullFriendConversationV2(),this.loadFullStrangerConversationV2(),Array.isArray(null==I?void 0:I.inboxType)&&(null==I?void 0:I.inboxType.includes(v))&&this.loadFullGroupConversation()):yield Promise.all([this.loadFullFriendConversationV1(),this.loadFullStrangerConversationV1()]),(0,c.YJ)().setInitialized(!0),yield(0,c.YJ)().startConversationChange()),T}}catch(e){const t=(0,r.T)();o.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"}),console.error(`[IM SDK] init failed, e=${e}`)}})},getConversationparticipants(t){var s;const{instance:i}=e(h),n=null==i?void 0:i.getConversationParticipants({conversation:t});return null!==(s=null==n?void 0:n.map(e=>e.userId))&&void 0!==s?s:[]},getLocalConversationList(t){var s;const{instance:i}=e(h);return null!==(s=null==i?void 0:i.getConversationList({filter:t}))&&void 0!==s?s:[]},getConversationListOnline(t){return g(this,void 0,void 0,function*(){try{const{instance:s}=e(h);if(!s)throw new Error("sdk is not defined");return yield s.getConversationListOnline({filter:t})}catch(e){const t=(0,r.T)();o.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"}),console.error(e)}})},loadMoreFriendConversation(){return g(this,void 0,void 0,function*(){try{const{instance:s,friendsCursor:i,hasMoreFriends:n}=e(h);if(n){const e=yield null==s?void 0:s.getMessagesByUserInit({inboxType:0,cursor:i}),n=null==e?void 0:e.cursor.toString(),o=null==e?void 0:e.hasMore;t(h,e=>Object.assign(Object.assign({},e),{friendsCursor:null!=n?n:"0",hasMoreFriends:null!=o&&o}))}}catch(e){const t=(0,r.T)();o.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"}),console.error(e)}})},loadMoreGroupConversation(){return g(this,void 0,void 0,function*(){try{const{instance:s,groupCursor:i,hasMoreGroup:n}=e(h);if(n){const e=yield null==s?void 0:s.getMessagesByUserInit({inboxType:v,cursor:i}),n=null==e?void 0:e.cursor.toString(),o=null==e?void 0:e.hasMore;t(h,e=>Object.assign(Object.assign({},e),{groupCursor:null!=n?n:"0",hasMoreGroup:null!=o&&o}))}}catch(e){const t=(0,r.T)();o.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"}),console.error(e)}})},loadMoreStrangerConversation(){return g(this,void 0,void 0,function*(){try{const{instance:s,strangerCursor:i,hasMoreStranger:n}=e(h);if(n){const e=yield null==s?void 0:s.getMessagesByUserInit({inboxType:3,cursor:i}),n=null==e?void 0:e.cursor.toString(),o=null==e?void 0:e.hasMore;t(h,e=>Object.assign(Object.assign({},e),{strangerCursor:null!=n?n:"0",hasMoreStranger:null!=o&&o}))}}catch(e){const t=(0,r.T)();o.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"}),console.error(e)}})},createConversation({uid:t,inboxType:s}){return g(this,void 0,void 0,function*(){const{instance:i}=e(h);return yield null==i?void 0:i.createConversation({participants:t,inboxType:s})})},createMessage({type:t,content:s,conversation:i,referenceMessage:n,fileInfo:o}){return g(this,void 0,void 0,function*(){const{instance:r}=e(h);let a,d;if(n&&(a=JSON.stringify({content:n.content,refmsg_content:JSON.stringify(n.content||{}),refmsg_sec_uid:n.secSender,refmsg_type:n.type,refmsg_uid:n.sender,refmsg_sub_type:"",refmsg_template_quote:""})),o){const{fileType:e,fileHandler:s,width:l,height:c,onUploadProcess:u,onUploadComplete:g,onUploadError:v}=o,h=e.startsWith("image");d=yield null==r?void 0:r.createFileMessage({conversation:i,type:t,referenceMessage:n,referenceHint:a,fileInfo:{type:h?"image":"video",fileHandler:s,displayType:"media",encrypt:!0,imagePreviewWidth:l,imagePreviewHeight:c,ext:h?{}:{"s:file_ext_key_video_width":`${l||0}`,"s:file_ext_key_video_height":`${c||0}`},onUploadProcess:e=>{var t;null==u||u(null!==(t=null==d?void 0:d.clientId)&&void 0!==t?t:"",e)},onUploadComplete:e=>{var t;null==g||g(null!==(t=null==d?void 0:d.clientId)&&void 0!==t?t:"",e)},onUploadError:e=>{var t;null==v||v(null!==(t=null==d?void 0:d.clientId)&&void 0!==t?t:"",e)}},scene:"private_"+(h?"image":"video")})}else d=yield null==r?void 0:r.createMessage({conversation:i,type:t,content:s,referenceMessage:n,referenceHint:a});return d})},sendMessage({message:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);return yield null==s?void 0:s.sendMessage({message:t})})},setConversationSettingInfo({conversation:t,mute:s,stickOnTop:i}){return g(this,void 0,void 0,function*(){const{instance:n}=e(h);return yield null==n?void 0:n.setConversationSettingInfo({conversation:t,mute:s,stickOnTop:i})})},deleteConversation({conversation:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);return yield null==s?void 0:s.deleteConversation({conversation:t})})},markConversationRead({conversation:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);return yield null==s?void 0:s.markConversationRead({conversation:t})})},getStrangerPreview(){return g(this,void 0,void 0,function*(){const{instance:t}=e(h);return yield null==t?void 0:t.getStrangerPreview({})})},getMessagesByConversation({conversation:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);if(!s)throw new Error("sdk is not defined");return yield s.getMessagesByConversation({conversation:t})})},getStrangerConversationMessage({conversation:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);return yield null==s?void 0:s.getStrangerConversationMessage({conversation:t})})},deleteMessage({message:t}){return g(this,void 0,void 0,function*(){const{instance:s}=e(h);return yield null==s?void 0:s.deleteMessage({message:t})})},decryptMedia({message:t,fetchIndex:s}){return g(this,void 0,void 0,function*(){const{instance:i}=e(h);return yield null==i?void 0:i.decryptMedia({message:t,fetchIndex:s})})},getConversationByMessage({message:t}){const{instance:s}=e(h);return null==s?void 0:s.getConversation({conversationId:t.conversationId})},getMessages({messages:t,conversation:s,upsert:i}){return g(this,void 0,void 0,function*(){const{instance:n}=e(h);return yield null==n?void 0:n.getMessages({messages:t,conversation:s,upsert:i})})},loadMoreConversationsWithTags({isReset:s}){return g(this,void 0,void 0,function*(){s&&t(h,e=>Object.assign(Object.assign({},e),{hasMoreConversationTag:!0,conversationTagCursor:"0"}));const{hasMoreConversationTag:i,conversationTagCursor:n,instance:o}=e(h),{selectedConversationTagList:r}=e(d.pt);if(i){const e=yield null==o?void 0:o.getMessagesAndConversationsByTags({limit:20,cursor:n,tags:r.map(e=>e.label_id),inboxType:0});e&&t(h,t=>Object.assign(Object.assign({},t),{hasMoreConversationTag:e.hasMore,conversationTagCursor:e.nextCursor.toString()}))}})},getConversationListByTags(){var t,s;const{instance:i}=e(h),{selectedConversationTagList:n}=e(d.pt),{conversationListType:o}=e(l.G7);return o===a.om.Friends?(null!==(t=null==i?void 0:i.getConversationList({filter:e=>!e.isStrangerConversation}))&&void 0!==t?t:[]).filter(e=>{for(const t of n.map(e=>e.label_id))if(!e.userConversationTags.includes(String(t)))return!1;return!0}):(null!==(s=null==i?void 0:i.getConversationList({filter:e=>e.isStrangerConversation}))&&void 0!==s?s:[]).filter(e=>{for(const t of n.map(e=>e.label_id))if(!e.userConversationTags.includes(String(t)))return!1;return!0})},loadFullFriendConversationV1(){return g(this,void 0,void 0,function*(){const{options:t}=e(h);let{hasMoreFriends:s,hasMoreGroup:i}=e(h);if(Array.isArray(null==t?void 0:t.inboxType)&&(null==t?void 0:t.inboxType.includes(v)))for(;s||i;)s&&(yield this.loadMoreFriendConversation()),i&&(yield this.loadMoreGroupConversation()),s=e(h).hasMoreFriends,i=e(h).hasMoreGroup;else for(;s;)yield this.loadMoreFriendConversation(),s=e(h).hasMoreFriends})},loadFullStrangerConversationV1(){return g(this,void 0,void 0,function*(){let{hasMoreStranger:t}=e(h);for(;t;)yield this.loadMoreStrangerConversation(),t=e(h).hasMoreStranger})},loadFullFriendConversationV2(){const t=()=>g(this,void 0,void 0,function*(){e(h).hasMoreFriends?(yield this.loadMoreFriendConversation(),setTimeout(()=>{t()},0)):yield(0,c.YJ)().startConversationChange()});t()},loadFullGroupConversation(){const t=()=>g(this,void 0,void 0,function*(){e(h).hasMoreGroup?(yield this.loadMoreGroupConversation(),setTimeout(()=>{t()},0)):yield(0,c.YJ)().startConversationChange()});t()},loadFullStrangerConversationV2(){const t=()=>g(this,void 0,void 0,function*(){e(h).hasMoreStranger&&(yield this.loadMoreStrangerConversation(),setTimeout(()=>{t()},0))});t()}}))},52066:(e,t,s)=>{s.d(t,{nU:()=>I,IA:()=>w,VI:()=>j,Yl:()=>T,by:()=>L});var i=s(1183),n=s(64388),o=s(79161),r=s(53900),a=s(41221),d=s(37783),l=s(1941),c=s(26225),u=s(83692);const g=(0,c.y)(u.$);var v=s(38335),h=s(48156),p=s(35762),f=s(17384),y=s(2232),m=s(73653),M=s(54133),b=s(73976),S=s(19578),C=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const O=(e,t)=>C(void 0,void 0,void 0,function*(){return p.h.get("/api/im/item_detail/",{query:{itemId:e,coverFormat:t},baseUrlType:f.Z4.FixedWww})}),_={[o.om.Friends]:{},[o.om.Strangers]:{},hasProcessedGroupChatUserMap:{},selectedConversation:void 0,currentMessage:{list:[],refMsgMap:new Map,hasMore:!0},isLoadingMoreMessage:!1,failedMessageMap:{},hasFeedbackMap:{},fetchingVideoCodeMap:{},failedVideoCodeMap:{},itemListByMessageId:[],recordedFocusOrigin:"",moderationResultMap:{},sendingProgressMap:{},lastUpdatedMap:{}},I=(0,i.p)("conversationAtom@tiktok/webapp-atoms",_),{useServiceState:L,useServiceDispatchers:T,useAtomService:j,getStaticApi:w}=(0,n.i)(I,(e,t)=>({setSelectedConversation(e){t(I,t=>Object.assign(Object.assign({},t),{selectedConversation:e,refMessage:void 0}))},setActionOpenedConversation(e){t(I,t=>Object.assign(Object.assign({},t),{actionOpenedConversation:e}))},setUser(s){const{item:i,isStranger:n}=s,o=e(I);t(I,n?Object.assign(Object.assign({},o),{strangers:Object.assign(Object.assign({},o.strangers),{[i.id]:i})}):Object.assign(Object.assign({},o),{friends:Object.assign(Object.assign({},o.friends),{[i.id]:i})}))},addFailedMessage(e){t(I,t=>Object.assign(Object.assign({},t),{failedMessageMap:Object.assign(Object.assign({},t.failedMessageMap),e)}))},setModerationResult(e){t(I,t=>Object.assign(Object.assign({},t),{moderationResultMap:e}))},setProcessedGroupChatUsers(e){t(I,t=>Object.assign(Object.assign({},t),{hasProcessedGroupChatUserMap:Object.assign(Object.assign({},t.hasProcessedGroupChatUserMap),{[e]:!0})}))},setLastUpdated(e){t(I,t=>Object.assign(Object.assign({},t),{lastUpdatedMap:e}))},setSendingProgress(s){const{messageId:i,sendingProgress:n}=s,o=e(I).sendingProgressMap,r=Object.assign({},o);r[i]=n,t(I,e=>Object.assign(Object.assign({},e),{sendingProgressMap:r}))},multiSetConversation(s){const{list:i,isStranger:n}=s,o=e(I),r={};i.forEach(e=>{r[e.id]=e}),t(I,n?Object.assign(Object.assign({},o),{strangers:Object.assign(Object.assign({},o.strangers),r)}):Object.assign(Object.assign({},o),{friends:Object.assign(Object.assign({},o.friends),r)}))},setMessageListAction(e){t(I,t=>{const{refMsgMap:s}=t.currentMessage;return null==e||e.forEach(e=>{if(!e.referenceInfo)return;const t=e.referenceInfo.referenced_message_id.toString();s.has(t)||s.set(t,null)}),null==e||e.forEach(e=>{null===s.get(e.serverId)&&s.set(e.serverId,e)}),Object.assign(Object.assign({},t),{currentMessage:Object.assign(Object.assign({},t.currentMessage),{list:null!=e?e:[]})})})},setRecordedFocusOrigin(e){t(I,t=>Object.assign(Object.assign({},t),{recordedFocusOrigin:e}))},setMessageHasMore(e){t(I,t=>Object.assign(Object.assign({},t),{currentMessage:Object.assign(Object.assign({},t.currentMessage),{hasMore:e})}))},setIsLoadingMoreMessage(e){t(I,t=>Object.assign(Object.assign({},t),{isLoadingMoreMessage:e}))},setHasFeedbackMap(e){t(I,t=>Object.assign(Object.assign({},t),{hasFeedbackMap:Object.assign(Object.assign({},t.hasFeedbackMap),{[e]:!0})}))},setFailedVideoCodeMap(e){t(I,t=>Object.assign(Object.assign({},t),{failedVideoCodeMap:Object.assign(Object.assign({},t.failedVideoCodeMap),e)}))},setItemListByMessageId(e){t(I,t=>Object.assign(Object.assign({},t),{itemListByMessageId:e}))},setRefMessage(e){t(I,t=>Object.assign(Object.assign({},t),{refMessage:e}))},removeRefMessage(){t(I,e=>Object.assign(Object.assign({},e),{refMessage:void 0}))},setMessageList(e){return C(this,void 0,void 0,function*(){const t=(0,y.d)("web_dm_quote_message");return"v2"===t||"v3"===t?this.setMessageListV2(e):this.setMessageListV1(e)})},setMessageListV1(t){return C(this,void 0,void 0,function*(){const{list:s,shouldHandleVideoMessage:i,abTestVersion:n}=t,{items:r}=e(d.Pu),{failedVideoCodeMap:a}=e(I);if(!i)return void this.setMessageListAction(s);const l=[],c=[],u=[];s.forEach(e=>{const{type:t,content:s,clientId:i}=e;if(t!==o.Go.Video&&t!==o.Go.Story)return;let n={};try{n=JSON.parse(s)}catch(e){return null}const d=n.itemId;a[d]||(c.push(d),u.push(i),(null==r?void 0:r[d])||l.push(d))}),this.setMessageListAction(s),yield this.getVideoListV1({needRequestList:l,allList:c,allListByMessageId:u,abTestVersion:n})})},setMessageListV2(t){return C(this,void 0,void 0,function*(){const{list:s,shouldHandleVideoMessage:i,abTestVersion:n}=t,{failedVideoCodeMap:r,fetchingVideoCodeMap:a}=e(I);if(!i)return void this.setMessageListAction(s);const l=[],c=[],u=[];s.forEach(e=>{const{type:t,content:s,clientId:i}=e;if(t!==o.Go.Video&&t!==o.Go.Story)return;let n={};try{n=JSON.parse(s)}catch(e){return null}const g=n.itemId;r[g]||(c.push(g),u.push(i),(0,d.ud)().getStaticItem(g)||a[g]||l.push(g))}),this.setMessageListAction(s),yield this.getVideoListV2({needRequestList:l,allList:c,allListByMessageId:u,abTestVersion:n})})},handleMessageUpsert(t){return C(this,void 0,void 0,function*(){const{message:s,abTestVersion:i}=t,{selectedConversation:n}=e(I);n&&[o.Go.MsgTypeTemplatePictureCard,o.Go.MsgTypeTemplateVideoCard].includes(s.type)&&7===s.source&&(yield this.getMessageList({id:null==n?void 0:n.id,shouldHandleVideoMessage:!1,abTestVersion:i}))})},handleConversationLeave(t){return C(this,void 0,void 0,function*(){const{selectedConversation:s}=e(I);(null==s?void 0:s.id)===t.id&&this.setSelectedConversation(void 0),yield(0,a.fI)().deleteConversation({conversation:t})})},handleConversationUpsert(e){return C(this,void 0,void 0,function*(){yield this.getMessageList({id:e.id,shouldHandleVideoMessage:!1})})},handleConversationDelete(t){var s,i;const{selectedConversation:n}=e(I);if((null==n?void 0:n.id)===t.id){if(!n.isGroupChat){var r;const e=null!==(s=n.toParticipantUserId)&&void 0!==s?s:"",t=null!==(i=null==(r=(0,S.py)().getUser(e))?void 0:r.uniqueId)&&void 0!==i?i:"";(0,b.Hz)(o.jh.UserDelete,{uid:e,uniqueId:t,conversationShortId:n.shortId})}this.setSelectedConversation(void 0)}},getMessageList(t){var s;return C(this,void 0,void 0,function*(){try{const{id:i,shouldHandleVideoMessage:n,abTestVersion:o}=t,{friends:r,strangers:a,selectedConversation:d}=e(I),l=null!==(s=r[i])&&void 0!==s?s:a[i];if(!l)return;if(i!==(null==d?void 0:d.id))return;const c=l.getMessageList(m.U);yield this.setMessageList({list:c,shouldHandleVideoMessage:n,abTestVersion:o})}catch(e){}})},loadMoreMessage(s){return C(this,void 0,void 0,function*(){try{t(I,e=>Object.assign(Object.assign({},e),{isLoadingMoreMessage:!0}));const{conversation:i,abTestVersion:n}=s,{selectedConversation:o}=e(I);if((null==o?void 0:o.id)!==i.id)return;const{hasMore:r}=yield(0,a.fI)().getMessagesByConversation({conversation:i}),d=i.getMessageList(m.U);this.setMessageHasMore(r),yield this.setMessageList({list:d,shouldHandleVideoMessage:!0,abTestVersion:n})}catch(e){}finally{t(I,e=>Object.assign(Object.assign({},e),{isLoadingMoreMessage:!1}))}})},setConversationSettingInfo(t){var s,i;return C(this,void 0,void 0,function*(){const{friends:n,strangers:o}=e(I),{id:r,mute:d,stickOnTop:l}=t,c=null!==(i=null!==(s=n[r])&&void 0!==s?s:o[r])&&void 0!==i?i:{};yield(0,a.fI)().setConversationSettingInfo({conversation:c,mute:d,stickOnTop:l})})},deleteConversation(t){var s,i,n;return C(this,void 0,void 0,function*(){const{id:r}=t,{friends:d,selectedConversation:l}=e(I),c=null!==(s=d[r])&&void 0!==s?s:{};if(yield(0,a.fI)().deleteConversation({conversation:c}),(null==l?void 0:l.shortId)===c.shortId){if(!l.isGroupChat){var u;const e=null!==(i=l.toParticipantUserId)&&void 0!==i?i:"",t=null!==(n=null==(u=(0,S.py)().getUser(e))?void 0:u.uniqueId)&&void 0!==n?n:"";(0,b.Hz)(o.jh.UserDelete,{uid:e,uniqueId:t,conversationShortId:l.shortId})}this.setSelectedConversation(void 0)}})},markConversationRead(t){var s,i;return C(this,void 0,void 0,function*(){const{id:n}=t,{friends:o,strangers:r}=e(I),d=null!==(i=null!==(s=o[n])&&void 0!==s?s:r[n])&&void 0!==i?i:{};yield(0,a.fI)().markConversationRead({conversation:d})})},handleMessageSend(t){return C(this,void 0,void 0,function*(){const{selectedConversation:s}=e(I);if(!s)return;const i=t.type===o.Go.Video||t.type===o.Go.Story;yield this.getMessageList({id:s.id,shouldHandleVideoMessage:i,abTestVersion:t.abTestVersion})})},handleReceiveNewMessage(t){return C(this,void 0,void 0,function*(){const{selectedConversation:s}=e(I);if(!s)return;const i=t.type===o.Go.Video||t.type===o.Go.Story;yield this.getMessageList({id:s.id,shouldHandleVideoMessage:i,abTestVersion:t.abTestVersion})})},handleMessageDelete(t){var s,i;return C(this,void 0,void 0,function*(){const{selectedConversation:n}=e(I);if(!n)return;const r=t.type===o.Go.Video||t.type===o.Go.Story;if(yield this.getMessageList({id:n.id,shouldHandleVideoMessage:r,abTestVersion:t.abTestVersion}),0===n.getMessageList(m.U).length&&(this.setSelectedConversation(void 0),!n.isGroupChat)){var a;const e=null!==(s=n.toParticipantUserId)&&void 0!==s?s:"",t=null!==(i=null==(a=(0,S.py)().getUser(e))?void 0:a.uniqueId)&&void 0!==i?i:"";(0,b.Hz)(o.jh.UserDelete,{uid:e,uniqueId:t,conversationShortId:n.shortId})}})},deleteMessage(e){return C(this,void 0,void 0,function*(){const{message:t}=e;yield(0,a.fI)().deleteMessage({message:t})})},likeMessage(e){return C(this,void 0,void 0,function*(){const{message:t,isLiked:i}=e;{const{im_proto:e}=yield Promise.all([s.e(4488),s.e(6489),s.e(3305),s.e(6706),s.e(8904),s.e(1960),s.e(4835),s.e(6483),s.e(759),s.e(4685),s.e(694),s.e(4714),s.e(1377),s.e(1798)]).then(s.bind(s,15226)),n=(0,a.fI)().getInstance();return yield null==n?void 0:n.modifyMessageProperty({message:t,modifyContent:[{operation:i?e.OPERATION_TYPE.REMOVE_PROPERTY_ITEM:e.OPERATION_TYPE.ADD_PROPERTY_ITEM,key:"e:love"}]})}})},reactToMessage({message:e,currentReaction:t,newReaction:i}){return C(this,void 0,void 0,function*(){{const{im_proto:n}=yield Promise.all([s.e(4488),s.e(6489),s.e(3305),s.e(6706),s.e(8904),s.e(1960),s.e(4835),s.e(6483),s.e(759),s.e(4685),s.e(694),s.e(4714),s.e(1377),s.e(1798)]).then(s.bind(s,15226)),o=(0,a.fI)().getInstance();let r;return!t&&i&&(r=[{operation:n.OPERATION_TYPE.ADD_PROPERTY_ITEM,key:i},{operation:n.OPERATION_TYPE.ADD_PROPERTY_ITEM,key:"e:love"}]),t&&i&&(r="e:love"===t?[{operation:n.OPERATION_TYPE.ADD_PROPERTY_ITEM,key:i}]:[{operation:n.OPERATION_TYPE.REMOVE_PROPERTY_ITEM,key:t},{operation:n.OPERATION_TYPE.ADD_PROPERTY_ITEM,key:i}]),(t&&!i||t===i)&&(r=[{operation:n.OPERATION_TYPE.REMOVE_PROPERTY_ITEM,key:t},{operation:n.OPERATION_TYPE.REMOVE_PROPERTY_ITEM,key:"e:love"}]),r?yield null==o?void 0:o.modifyMessageProperty({message:e,modifyContent:r}):void console.warn("invalid operation",{currentReaction:t,newReaction:i})}})},handleMessagePropertyUpsert(t){var s,i,n;return C(this,void 0,void 0,function*(){const{friends:o,strangers:r,selectedConversation:a}=e(I),d=null!==(s=t.uid)&&void 0!==s?s:"",l=t.conversationId,c="v2"===(0,y.d)("web_dm_message_reaction"),u=null!==(n=null!==(i=o[l])&&void 0!==i?i:r[l])&&void 0!==n?n:{};if(c)if(t.property["e:love"]){const{sender:e}=t;if(e!==d)return;const s=t.property,{"e:love":i}=s,n=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(s,["e:love"]);let o="",r=[];const l=Object.keys(n);l.length>0?(o=l[0].split(":")[1],r=n[l[0]]):(o="❤️",r=i);const c=[];for(let e=0;e<r.length;e++){const s=r[e];if(s.userId!==d){c.push(s.userId);const e=a===u;!u.customLocalLike||u.customLocalLike.date<s.createTime?u.customLocalLike={like:!0,date:s.createTime,hasRead:e,likedMessage:t,senderUid:s.userId,reaction:o}:u.customLocalLike=null,this.multiSetConversation({list:[u],isStranger:u.isStrangerConversation})}}yield(0,b.YJ)().getMultiUsersByUids({uidList:c})}else u.customLocalLike=null;else if(t.property["e:love"]){const{sender:e}=t;if(e!==d)return;const s=t.property["e:love"],{length:i}=s,n=[];for(let e=0;e<i;e++){const i=s[e];if(i.userId!==d){n.push(i.userId);const e=a===u;(!u.customLocalLike||u.customLocalLike.date<i.createTime)&&(u.customLocalLike={like:!0,date:i.createTime,hasRead:e,likedMessage:t,reaction:"❤️",senderUid:i.userId}),this.multiSetConversation({list:[u],isStranger:u.isStrangerConversation})}}yield(0,b.YJ)().getMultiUsersByUids({uidList:n})}else u.customLocalLike=null})},handleRefreshMessage(e){let t=Number(e.ext["a:moderation_result"]);if("true"===e.ext["a:is_violative"]&&(t=3),t>1){const{content:s}=e,i=s.match(/"server_message_id":(\d+)/);if(!i)return;const n=i[1];this.setModerationResult({[n]:t})}},updateMessageFromServer(e){return C(this,void 0,void 0,function*(){const t=(0,a.fI)().getConversationByMessage({message:e});if(t){const s=yield(0,a.fI)().getMessages({messages:[e],conversation:t,upsert:!0});this.setLastUpdated({[e.clientId]:{timestamp:Date.now(),success:Boolean(s&&s.length>0)}})}})},handleLoadMediaFail(e){const{message:t,mediaType:s,mediaUrl:i,error:n,scene:o}=e;console.log(t,i,n),r.w.handleMediaMessageShowFail({media_type:s,scene:o})},handleMediaModerationTimeout(e){const{message:t,mediaType:s,mediaUrl:i}=e;console.log(t,s,i)},feedbackMessage(t){return C(this,void 0,void 0,function*(){const s=(0,v.T)(),i=s("direct_meaasge_sending_ban_feedback_again"),n=s("Sorry, something wrong with the server, please try again.");try{const{hasFeedbackMap:s}=e(I),{conversationId:o,shortId:r,uid:a,selfUid:d,content:l,messageId:c,serverMsgId:u,decisionRuleId:g,checkMessageStatusCode:v}=t;if(s[c])return void h.F.open({content:i,duration:3,widthType:"half"});const y=yield(({conversationId:e,shortId:t,uid:s,selfUid:i,content:n,messageId:o,serverMsgId:r,decisionRuleId:a,checkMessageStatusCode:d})=>C(void 0,void 0,void 0,function*(){const l=M.stringify({conv_id:e,con_short_id:t,receiver_uid:s,content:n,msg_type:"7",biz_app_id:1988,scene:"sending_ban",msg_id:o,event:"tt_web_im",content_pb:"",server_msg_id:r,decision_rule_id:a,check_message_status_code:d,sending_ban_messages:`[${JSON.stringify({msg_id:o,server_msg_id:r,msg_type:"7",sender_uid:i,content:n,content_pb:"",banned:!1})}]`});return p.h.post("/aweme/v1/im/msg/feedback/",{query:{report_type:"im",appId:1233},headers:{"Content-Type":f.Ty.FORM_ENCODE},body:l})}))({conversationId:o,shortId:r,uid:a,selfUid:d,content:l,messageId:c,serverMsgId:u,decisionRuleId:g,checkMessageStatusCode:v}),{status_code:m}=y;0===m?(h.F.open({content:i,duration:3,widthType:"half"}),this.setHasFeedbackMap(c)):h.F.open({content:n,duration:3,widthType:"half"})}catch(e){h.F.open({content:n,duration:3,widthType:"half"})}})},getVideoListV1(t){return C(this,void 0,void 0,function*(){try{const s=e(g),{needRequestList:i,allList:n,allListByMessageId:o}=t;i.length||((0,l.Cg)().setItemListById({list:n}),this.setItemListByMessageId(o));const r=i.map(e=>C(this,void 0,void 0,function*(){var t,i;return yield O(e,null==(i=s.bizContext)||null==(t=i.videoCoverSettings)?void 0:t.format)})),a=yield Promise.all(r),c={},u=[];a.forEach(({statusCode:e,itemInfo:t},s)=>{const r=i[s];if(0!==e){c[r]=e;const t=n.indexOf(r);t>-1&&(n.splice(t,1),o.splice(t,1))}else u.push(null==t?void 0:t.itemStruct)}),this.setFailedVideoCodeMap(c),(0,d.ud)().addItems(u),(0,l.Cg)().setItemListById({list:n}),this.setItemListByMessageId(o)}catch(e){console.error(e)}})},getVideoListV2(t){return C(this,void 0,void 0,function*(){try{const{failedVideoCodeMap:s}=e(I),{needRequestList:i,allList:n,allListByMessageId:o}=t;i.length||((0,l.Cg)().setItemListById({list:n}),this.setItemListByMessageId(o));const r=i.map(e=>this.getSingleItem(e)),a=yield Promise.all(r),d=[];a.forEach(({statusCode:e,itemStruct:t},r)=>{const a=i[r];if(0!==e){s[a]=e;const t=n.indexOf(a);t>-1&&(n.splice(t,1),o.splice(t,1))}else d.push(t)}),(0,l.Cg)().setItemListById({list:n}),this.setItemListByMessageId(o)}catch(e){console.error(e)}})},getSingleItem(t){return C(this,void 0,void 0,function*(){const{fetchingVideoCodeMap:s,failedVideoCodeMap:i}=e(I),n=e(g);if((0,d.ud)().getStaticItem(t))return{itemStruct:(0,d.ud)().getStaticItem(t),statusCode:0};if(i[t])return{itemStruct:void 0,statusCode:i[t]};let o;var r,a;s[t]||(s[t]=O(t,null==(a=n.bizContext)||null==(r=a.videoCoverSettings)?void 0:r.format)),o=yield s[t];const{statusCode:l,itemInfo:c}=o;return 0!==l?(i[t]=l,this.setFailedVideoCodeMap(i)):(0,d.ud)().addItems([c.itemStruct]),delete s[t],{itemStruct:null==c?void 0:c.itemStruct,statusCode:l}})}}))},73653:(e,t,s)=>{s.d(t,{U:()=>i});const i=e=>!(!e.visible||e.scene&&/streak/.test(e.scene)||e.content&&1===e.type&&/\{\{[0-9]\}\}/.test(e.content))},73976:(e,t,s)=>{s.d(t,{YJ:()=>E,lU:()=>P,Hz:()=>U,D1:()=>V,_q:()=>F,VB:()=>R});var i=s(1183),n=s(64388),o=s(79161),r=s(35762),a=s(17384),d=s(20434),l=s(25961),c=s(8094),u=s(46833),g=s(41221),v=s(52066),h=s(53900),p=s(11096),f=s(19578),y=s(16356),m=s(43258);const M=e=>{var t,s;return null!==(t=null==e||null==(s=e.url_list)?void 0:s.find(e=>!/\.webp/.test(e)))&&void 0!==t?t:""},b=({is_block:e,is_blocked:t,follow_status:s})=>{if(null!=s)return e?u.yf.BLOCK:t?u.yf.BLOCKED:m.i[s]},S=e=>{const{avatar_medium:t,avatar_thumb:s,uid:i,short_id:n,unique_id:o,sec_uid:r,nickname:a,is_block:d,follow_status:l,signature:c,custom_verify:u,enterprise_verify_reason:g,follower_status:v}=e;return{avatarLarger:"",avatarMedium:M(t),avatarThumb:M(s),id:i,shortId:n,uniqueId:null!=o?o:"",secUid:null!=r?r:"",nickname:a,relation:b({is_block:d,is_blocked:void 0,follow_status:l}),signature:c,verified:Boolean(u||g),createTime:0,extraInfo:{followerStatus:v}}},C=e=>{const{users:t=[]}=e;return t.map(e=>{var t,s,i,n,o;return{avatar_medium:e.im_user_profile.avatars.avatar_medium,avatar_thumb:null!==(t=e.im_user_profile.avatars.avatar_small)&&void 0!==t?t:{},uid:e.im_user_profile.user_id.toString(),short_id:"",unique_id:e.im_user_profile.unique_id,nickname:e.im_user_profile.nick_name,is_block:null!==(s=null==(o=e.im_user_profile.block_info)?void 0:o.block)&&void 0!==s&&s,follow_status:e.im_user_profile.follow_status,signature:"",custom_verify:null!==(i=e.im_user_profile.user_verify_reason)&&void 0!==i?i:"",enterprise_verify_reason:null!==(n=e.im_user_profile.enterprise_verify_reason)&&void 0!==n?n:"",follower_status:e.im_user_profile.follower_status}}).map(e=>S(e))},O=(e,t,s)=>{const i=JSON.parse((0,d._S)(e));i[t]=s,(0,d.AP)(e,JSON.stringify(i))};var _=s(19145),I=s(85214),L=s(96266),T=s.n(L),j=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const w="web_dm_storage_",U=(e,t)=>{try{if(new URLSearchParams(window.location.search).get("scene")!==o.Z5.Business)return;window.parent.postMessage({type:e,params:t},window.location.origin)}catch(e){console.error("postMessage error",e)}},k=e=>j(void 0,void 0,void 0,function*(){try{const t=new URLSearchParams({aid:"1988",user_ids:`[${e.map(e=>`"${e}"`).join(",")}]`}),s=yield window.fetch.call(null,`/tiktok/v1/im/user/profile/?${t}`,{method:"GET"}),i=yield s.text();return T().parse(i)}catch(e){return console.log("err when parsing regex",e),{statusCode:"400"}}}),P=(0,i.p)("messageAtom@tiktok/webapp-atoms",{initialized:!1,messageCount:0,recentUserList:[],recentUserNameList:[],recentUidList:[],allUidList:[],followingUser:{list:[],nicknameList:[],uidList:[],hasMore:!0,maxCursor:0,minCursor:0},isFollowingLoading:!1,isSendMessageFailed:!1,isSendMessageLoading:!1,conversationMap:{},allConversationList:[],conversationList:[],strangerConversationList:[],successSentMessageCount:0,isListLoading:!0,recentUids:"",otherUid:"",isFirstTimeLoadHistory:!0,isFirstTimeLoadStranger:!0,isMediaSafeTipShown:!0,isMediaSelectionTipShown:!0,videoPlayerVolume:0}),{useServiceState:R,useServiceDispatchers:F,useAtomService:V,getStaticApi:E}=(0,n.i)(P,(e,t)=>({setMessageCount(e){t(P,t=>Object.assign(Object.assign({},t),{messageCount:e})),U(o.jh.MessageCountChange,{count:e})},setConversationMap(e){t(P,t=>Object.assign(Object.assign({},t),{conversationMap:e}))},setConversationList(e){e.sort((e,t)=>{if(e.isStickOnTop&&t.isStickOnTop||!e.isStickOnTop&&!t.isStickOnTop){const s=Math.max(e.customLocalLike?e.customLocalLike.date.getTime():-1,e.lastVisibleMessage?e.lastVisibleMessage.createdAt.getTime():-1);return Math.max(t.customLocalLike?t.customLocalLike.date.getTime():-1,t.lastVisibleMessage?t.lastVisibleMessage.createdAt.getTime():-1)-s}return 0}),t(P,t=>Object.assign(Object.assign({},t),{conversationList:e}))},setAllConversationList(e){t(P,t=>Object.assign(Object.assign({},t),{allConversationList:e}))},setStrangerConversationList(e){t(P,t=>Object.assign(Object.assign({},t),{strangerConversationList:e}))},setListLoading(e){t(P,t=>Object.assign(Object.assign({},t),{isListLoading:e}))},setRecentUids(e){t(P,t=>Object.assign(Object.assign({},t),{recentUids:e}))},updateRecentUserList(e){const{uniqueIdList:s,nicknameList:i,uidList:n}=e;t(P,e=>Object.assign(Object.assign({},e),{recentUserList:[...s],recentUserNameList:[...i],recentUidList:[...n]}))},updateFollowingUserList(e){t(P,t=>Object.assign(Object.assign({},t),{followingUser:e}))},setFollowingLoading(e){t(P,t=>Object.assign(Object.assign({},t),{isFollowingLoading:e}))},setUidList(e){t(P,t=>Object.assign(Object.assign({},t),{allUidList:e}))},addSentMessageSuccessCount(){const{successSentMessageCount:s}=e(P);t(P,e=>Object.assign(Object.assign({},e),{successSentMessageCount:s+1}))},setSendMessageStatus(e){const{isFailed:s,isLoading:i,successCount:n}=e;t(P,e=>Object.assign(Object.assign({},e),{isSendMessageFailed:null!=s&&s,isSendMessageLoading:null!=i&&i,successSentMessageCount:null!=n?n:e.successSentMessageCount}))},setOtherUid(e){t(P,t=>Object.assign(Object.assign({},t),{otherUid:e}))},setInitialized(e){t(P,t=>Object.assign(Object.assign({},t),{initialized:e}))},setIsMediaSafeTipShown(e){t(P,t=>Object.assign(Object.assign({},t),{isMediaSafeTipShown:e}))},setIsMediaSelectionTipShown(e){t(P,t=>Object.assign(Object.assign({},t),{isMediaSelectionTipShown:e}))},setVideoPlayerVolume(e){t(P,t=>Object.assign(Object.assign({},t),{videoPlayerVolume:e}))},initWebDMLocalStorage(e){const t=`${w}${e}`;let s=!0;try{localStorage.getItem(t)}catch(e){s=!1}if(!s)return;const i=(0,d._S)(t);let n={},o=!1;try{i&&(n=JSON.parse(i))}catch(e){o=!0}i&&!o&&"object"==typeof n||((0,d.AP)(t,"{}"),n={}),n.isMediaSafeTipShown||this.setIsMediaSafeTipShown(!1),n.isMediaSelectionTipShown||this.setIsMediaSelectionTipShown(!1),"number"==typeof n.videoPlayerVolume&&this.setVideoPlayerVolume(n.videoPlayerVolume)},closeMediaSafeTip(e){O(`${w}${e}`,"isMediaSafeTipShown",!0),this.setIsMediaSafeTipShown(!0)},closeMediaSelectionTip(e){O(`${w}${e}`,"isMediaSelectionTipShown",!0),this.setIsMediaSelectionTipShown(!0)},saveVideoPlayerVolume(e){const{uid:t,volume:s}=e;O(`${w}${t}`,"videoPlayerVolume",s),this.setVideoPlayerVolume(s)},handleIMEvent(e){return j(this,void 0,void 0,function*(){{const{IMEvent:t}=yield Promise.all([s.e(4488),s.e(6489),s.e(3305),s.e(6706),s.e(8904),s.e(1960),s.e(4835),s.e(6483),s.e(759),s.e(4685),s.e(694),s.e(4714),s.e(1377),s.e(1798)]).then(s.bind(s,15226)),{event:i,params:n,abTestVersion:o,uid:r}=e;switch(i){case t.ConversationChange:yield this.startConversationChange();break;case t.MessageSend:yield(0,v.IA)().handleMessageSend(Object.assign(Object.assign({},n),{abTestVersion:o}));break;case t.ReceiveNewMessage:yield(0,v.IA)().handleReceiveNewMessage(Object.assign(Object.assign({},n),{abTestVersion:o}));break;case t.MessageDelete:yield(0,v.IA)().handleMessageDelete(Object.assign(Object.assign({},n),{abTestVersion:o}));break;case t.MessagePropertyUpsert:yield(0,v.IA)().handleMessagePropertyUpsert(Object.assign(Object.assign({},n),{uid:r}));break;case t.RefreshMessage:(0,v.IA)().handleRefreshMessage(Object.assign({},n));break;case t.MessageUpsert:yield(0,v.IA)().handleMessageUpsert({message:n,abTestVersion:o});break;case t.ConversationLeave:yield(0,v.IA)().handleConversationLeave(n);break;case t.ConversationDelete:(0,v.IA)().handleConversationDelete(n);break;case t.ConversationUpsert:yield(0,v.IA)().handleConversationUpsert(n);break;case t.StrangerUpgrade:yield this.getStrangerConversationList({isLoadMore:!1,forceRefresh:!0});break;default:return}}})},startConversationChange(){var t;return j(this,void 0,void 0,function*(){try{const{initialized:s}=e(P),{friendsCursor:i,groupCursor:n,hasMoreFriends:o,hasMoreGroup:r,options:a}=e(g.I9),d=Array.isArray(null==a?void 0:a.inboxType)&&(null==a?void 0:a.inboxType.includes(g.A5));if(!s||!d&&"0"===i&&o||d&&"0"===i&&o&&"0"===n&&r)return;this.setListLoading(!0);const l=null!==(t=yield(0,g.fI)().getConversationListOnline(e=>!e.isStrangerConversation))&&void 0!==t?t:[],{selectedConversation:c}=e(v.nU),{otherUid:u,recentUserNameList:h}=e(P),p=new Set,f=[],y={};u&&p.add(u);const m=l.reduce((e,t)=>{const{id:s,toParticipantUserId:i,unreadCount:n,isMuted:o}=t;if(t.isGroupChat){var r;(null==(r=t.lastMessage)?void 0:r.sender)&&p.add(t.lastMessage.sender)}else{const e=i;e&&e!==u&&(p.add(e),f.push(e),y[e]=t)}return 0===n||o||s===(null==c?void 0:c.id)?e:e+n},0),{selectedConversationTagList:M,unreadOnly:b}=e(_.pt),S=Array.from(p),C=f.slice(0,20),O=[this.setConversationMap(y),this.setUidList(S),this.getMultiUsersByUids({uidList:S}),(0,v.IA)().multiSetConversation({list:l,isStranger:!1}),this.getStrangerConversationList({isLoadMore:!1,forceRefresh:!0}),this.setAllConversationList(l)];b||M.length>0?O.push(this.getConversationListWithFilter()):O.push(this.setConversationList(l)),yield Promise.all(O);const{strangerConversationList:I}=e(P);this.setMessageCount(m+I.length),b||0!==M.length||(yield this.getStrangerPreview()),h.length<C.length&&(yield this.getMultiUsersByUids({uidList:C,isGetRecentUsers:!0})),this.setListLoading(!1)}catch(e){this.setListLoading(!1)}})},getConversationListWithFilter(){return j(this,void 0,void 0,function*(){const{unreadOnly:t,selectedConversationTagList:s}=e(_.pt),{conversationListType:i}=e(I.G7),{selectedConversation:n}=e(v.nU),r=(0,g.fI)().getConversationListByTags();if(t){const e=r.filter(e=>e.unreadCount>0||(null==n?void 0:n.shortId)===e.shortId);i===o.om.Friends?this.setConversationList(e):this.setStrangerConversationList(e)}else i===o.om.Friends?(this.setConversationList(r),0===s.length&&(yield this.getStrangerPreview())):this.setStrangerConversationList(r)})},getStrangerPreview(){var t;return j(this,void 0,void 0,function*(){try{var s;const{users:i}=e(f.YK),{options:n}=e(g.I9);if(!n)return;const{allConversationList:o}=e(P),r=o.findIndex(e=>e.isStrangerConversation);r>-1&&o.splice(r,1);const a=yield(0,g.fI)().getStrangerPreview(),d=null==a?void 0:a.conversation,l=d.toParticipantUserId;if(!l)return;const c=[...o],u=null!==(t=null==(s=d.lastVisibleMessage)?void 0:s.createdAt.getTime())&&void 0!==t?t:-1;c.some((e,t)=>{var s,i;return(null!==(s=null==(i=e.lastVisibleMessage)?void 0:i.createdAt.getTime())&&void 0!==s?s:-1)<u&&!e.isStickOnTop?(c.splice(t,0,d),!0):t===c.length-1&&(c.splice(t+1,0,d),!0)}),c.length||c.splice(0,0,d),this.setAllConversationList(c),this.setConversationList(c),(0,v.IA)().multiSetConversation({list:[d],isStranger:!0}),i[l]||(yield this.getMultiUsersByUids({uidList:[l]}))}catch(e){}})},getStrangerConversationList(s){var i;return j(this,void 0,void 0,function*(){const{isLoadMore:n,forceRefresh:o=!1}=s,{strangerConversationList:r,isFirstTimeLoadStranger:a,conversationMap:d}=e(P),{strangers:l}=e(v.nU);if(n||a||o){const e=null!==(i=yield(0,g.fI)().getConversationListOnline(e=>e.isStrangerConversation))&&void 0!==i?i:[],t=r.reduce((e,t)=>(e[t.id]=t,e),{}),s=e.filter(e=>!l[e.id]||!t[e.id]),n=s.map(e=>{var t;return null!==(t=e.toParticipantUserId)&&void 0!==t?t:""});this.setConversationMap(Object.assign(Object.assign({},t),d)),(0,v.IA)().multiSetConversation({list:s,isStranger:!0}),yield this.getMultiUsersByUids({uidList:n}),this.setStrangerConversationList(e)}a&&t(P,e=>Object.assign(Object.assign({},e),{isFirstTimeLoadStranger:!1}))})},getMultiUsersByUids(t){return j(this,void 0,void 0,function*(){try{const{uidList:s,isGetRecentUsers:i}=t,{users:n}=e(f.YK),{otherUid:r}=e(P),{pathname:a}=location;if(!(0,l.tO)(a)&&(0,l.M5)(a)===c.g.Trending)return;const d=s.filter(e=>void 0===n[e]);if(!s.length)return;const u=String(d);this.setRecentUids(u);const g=[];for(let e=0;e<Math.ceil(d.length/99);e++){const t=yield k(d.slice(99*e,99*(e+1)));if(void 0===t||0!==t.status_code)return void console.log("error when calling multi user api",t);g.push(t)}const v={};let h=[];for(let e=0;e<g.length;e++)h=[...h,...C(g[e])];if(h.forEach(e=>{v[e.id]=e}),d.forEach(e=>{v[e]||n[e]?(r===e&&U(o.jh.UserSelect,{uid:e,uniqueId:v[e].uniqueId,from:"message-init"}),v[e].id=e):v[e]=null}),(0,f.py)().multiSetUsers(v),i){const e=[],t=[],i=[];s.forEach(s=>{var o;const r=null!==(o=v[s])&&void 0!==o?o:n[s];r&&(e.push(r.uniqueId),t.push(r.nickname),i.push(s))}),this.updateRecentUserList({uniqueIdList:e,nicknameList:t,uidList:i})}}catch(e){}})},getFollowingUserListWithCanShare(s){return j(this,void 0,void 0,function*(){try{this.setFollowingLoading(!0);const{count:n}=s,{followingUser:o}=e(P),{list:d,nicknameList:l,uidList:c}=o,u=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(o,["list","nicknameList","uidList"]),g=yield(i=Object.assign(Object.assign({},u),{count:n}),j(void 0,void 0,void 0,function*(){const{minCursor:e=0,count:t=30}=i;return r.h.get("/api/im/spotlight/relation",{query:{source:"web",with_fstatus:1,device_platform:"webapp_pc",count:t,max_time:e,min_time:0},baseUrlType:a.Z4.FixedWww})})),{status_code:v,max_time:h,min_time:p,followings:f=[],has_more:m}=g,M=[],b=[],C=[];if(0===v){let e=[];e=f.map(e=>{var t;return M.push(null!==(t=e.unique_id)&&void 0!==t?t:""),b.push(e.nickname),C.push(e.uid),S(e)}),this.updateFollowingUserList({list:[...d,...M],nicknameList:[...l,...b],uidList:[...c,...C],maxCursor:h,minCursor:p,hasMore:Boolean(m)}),(0,y.Gp)().multiSetUser(e)}else t(P,e=>Object.assign(Object.assign({},e),{followingUser:Object.assign(Object.assign({},e.followingUser),{hasMore:!1})}))}catch(e){}finally{this.setFollowingLoading(!1)}var i})},sendMessage(t){var s,i,n,r,a;return j(this,void 0,void 0,function*(){try{const{uid:d,relation:l=u.yf.NONE,type:c,content:f,hasConversation:y,chatType:m,messageType:M,convId:b,fileInfo:S,referenceMessage:C}=t,{friends:O,strangers:_}=e(v.nU);let I;if(y){const e=null!==(s=O[b])&&void 0!==s?s:_[b];I=yield(0,g.fI)().createMessage({conversation:e,type:c,content:JSON.stringify(f),referenceMessage:C,fileInfo:S})}else{const e=yield(0,g.fI)().createConversation({uid:d,inboxType:0}),t=null!==(i=null==e?void 0:e.payload)&&void 0!==i?i:{};I=yield(0,g.fI)().createMessage({conversation:t,type:c,content:JSON.stringify(f),referenceMessage:C,fileInfo:S})}if(c===o.Go.Placeholder)return;if(void 0===I)throw new Error("create message response is undefined");const L=yield(0,g.fI)().sendMessage({message:I});if(void 0===L)throw new Error("send message response is undefined");const{success:T,checkMsg:j,serverMessageId:w,payload:k}=L;this.setSendMessageStatus({isFailed:!1,isLoading:!1}),this.addSentMessageSuccessCount(),T?(h.w.handleSendMessage({chat_type:null!=m?m:p.H.Private,conversation_id:null!==(n=null==k?void 0:k.conversationId)&&void 0!==n?n:"",relation_tag:l,to_user_id:d,message_type:null!=M?M:"share_video",if_contain_quote:C?1:0,quote_message_type:null==C?void 0:C.type}),U(o.jh.MessageSend,{uid:d})):(h.w.handleFailSendMessage({chat_type:null!=m?m:p.H.Private,conversation_id:null!==(r=null==k?void 0:k.conversationId)&&void 0!==r?r:"",message_type:null!=M?M:"share_video",error_code:null!==(a=JSON.parse(null!=j?j:"{}").status_code)&&void 0!==a?a:-1,relation_tag:l,to_user_id:d,if_contain_quote:C?1:0,quote_message_type:null==C?void 0:C.type}),(null==k?void 0:k.clientId)&&(0,v.IA)().addFailedMessage({[k.clientId]:{checkMsg:null!=j?j:"null",serverMessageId:w}}))}catch(e){const{uid:s,relation:i=u.yf.NONE,chatType:n,messageType:o,convId:r,referenceMessage:a}=t;console.error(e),h.w.handleFailSendMessage({chat_type:null!=n?n:p.H.Private,conversation_id:r,message_type:null!=o?o:"share_video",error_code:-1,relation_tag:i,to_user_id:s,if_contain_quote:a?1:0,quote_message_type:null==a?void 0:a.type}),this.setSendMessageStatus({isFailed:!0,isLoading:!1})}})},batchSendMessages(t){var s,i,n;return j(this,void 0,void 0,function*(){const{uid:r,relation:a=u.yf.NONE,hasConversation:d,chatType:l,convId:c,batchList:f}=t,{friends:y,strangers:m}=e(v.nU);let M;if(this.setSendMessageStatus({isFailed:!1,isLoading:!0}),d)M=null!==(i=null!==(s=y[c])&&void 0!==s?s:m[c])&&void 0!==i?i:{};else try{const e=yield(0,g.fI)().createConversation({uid:r,inboxType:0});M=null!==(n=null==e?void 0:e.payload)&&void 0!==n?n:{}}catch(e){console.log(e)}const b=f.map(e=>j(this,void 0,void 0,function*(){var t,s;try{const{type:i,content:n,fileInfo:d,messageType:u}=e,f=yield(0,g.fI)().createMessage({conversation:M,type:i,content:JSON.stringify(n),fileInfo:d});if(f){const e=yield(0,g.fI)().sendMessage({message:f});if(e){const{success:i,checkMsg:n,payload:d,statusCode:g,statusMsg:f,serverMessageId:y}=e,m={chat_type:null!=l?l:p.H.Private,conversation_id:c,message_type:null!=u?u:"default",relation_tag:a,to_user_id:r,if_contain_quote:0};if(i)this.addSentMessageSuccessCount(),(0,v.IA)().setSendingProgress({messageId:null!==(t=null==d?void 0:d.clientId)&&void 0!==t?t:"",sendingProgress:{finished:!0}}),h.w.handleSendMessage(m),U(o.jh.MessageSend,{uid:r});else{(null==d?void 0:d.clientId)&&(0,v.IA)().addFailedMessage({[d.clientId]:{checkMsg:null!=n?n:"null",serverMessageId:y}});const e=Object.assign(Object.assign({},m),{error_code:null!==(s=JSON.parse(null!=n?n:"{}").status_code)&&void 0!==s?s:-1,status_code:null!=g?g:-1,status_msg:null!=f?f:-1});h.w.handleFailSendMessage(e)}}}}catch(e){h.w.handleFailSendMessage({chat_type:null!=l?l:p.H.Private,conversation_id:c,message_type:"media",error_code:-1,relation_tag:a,to_user_id:r,if_contain_quote:0})}}));try{yield Promise.allSettled(b),this.setSendMessageStatus({isFailed:!1,isLoading:!1})}catch(e){this.setSendMessageStatus({isFailed:!0,isLoading:!1})}})},loadFullFriendConversations(){return j(this,void 0,void 0,function*(){let{hasMoreFriends:t,hasMoreGroup:s}=e(g.I9);for(;t||s;)yield(0,g.fI)().loadMoreConversation(),t=e(g.I9).hasMoreFriends,s=e(g.I9).hasMoreGroup})},loadFullStrangerConversation(){return j(this,void 0,void 0,function*(){let{hasMoreStranger:t}=e(g.I9);for(;t;)yield(0,g.fI)().loadMoreStrangerConversation(),t=e(g.I9).hasMoreStranger})}}))},79161:(e,t,s)=>{s.d(t,{BR:()=>o,Go:()=>d,M5:()=>n,Z5:()=>l,eh:()=>r,hr:()=>i,jh:()=>c,om:()=>a});var i=function(e){return e[e.OpenPrivacySetting=0]="OpenPrivacySetting",e[e.Report=1]="Report",e[e.Feedback=2]="Feedback",e}({}),n=function(e){return e[e.Default=0]="Default",e[e.Report=1]="Report",e}({});const o="webapp-dm-accepted-list",r=1022;var a=function(e){return e.Friends="friends",e.Strangers="strangers",e}({}),d=function(e){return e[e.None=0]="None",e[e.StartChatTip=1]="StartChatTip",e[e.Text=7]="Text",e[e.Video=8]="Video",e[e.Story=1025]="Story",e[e.Inline=1031]="Inline",e[e.BusinessInvitation=1037]="BusinessInvitation",e[e.GroupNoticeGuide=1039]="GroupNoticeGuide",e[e.Placeholder=49999]="Placeholder",e[e.Sticker=1805]="Sticker",e[e.LEGACY_MESSAGE_TYPE_EMOJI=5]="LEGACY_MESSAGE_TYPE_EMOJI",e[e.MsgTypeTemplatePictureCard=1802]="MsgTypeTemplatePictureCard",e[e.MsgTypeTemplateVideoCard=1803]="MsgTypeTemplateVideoCard",e}({}),l=function(e){return e.EcomEmail="ecom_email",e.Business="business",e}({}),c=function(e){return e.MessageSend="message-send",e.UserSelect="user-select",e.MessageCountChange="new-message",e.OnLoad="on-load",e.UserDelete="user-delete",e}({})},85214:(e,t,s)=>{s.d(t,{G7:()=>m,Ks:()=>S,Xq:()=>b,g9:()=>M});var i=s(1183),n=s(64388),o=s(35762),r=s(17384),a=s(54133),d=function(e){return e.Video="video",e.PhotoMode="photo_mode",e.Comment="comment",e.LiveComment="live_comment",e.Null="",e.Challenge="hashtag",e.User="user",e.Music="music",e.Effect="effect",e.Question="ques_ans",e.FtcUser="kid_mode_video",e.Live="live",e.Im="im",e.Suggestion="suggestion",e.SugRecommend="sug_recommend",e.LIVE="live",e.VideoItemTag="video_page_tag",e}({}),l=s(73976),c=s(41221),u=s(79161),g=s(48156),v=s(38335),h=s(52066),p=s(19578),f=function(e,t,s,i){return new(s||(s=Promise))(function(n,o){function r(e){try{d(i.next(e))}catch(e){o(e)}}function a(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}d((i=i.apply(e,t||[])).next())})};const y={conversationListType:u.om.Friends,chatMode:u.M5.Default,notice:"",clickableNotice:null,showSettingModal:!1,acceptedStrangerList:[],reportResons:[],selectedReportReasons:[],isShowReportSelectModal:!1,isShowReportSuccessModal:!1,isShowContactButton:!1,isUsingV3Reasons:!0},m=(0,i.p)("messagePageAtom@tiktok/webapp-atoms",y),{useServiceState:M,useServiceDispatchers:b,useAtomService:S,getStaticApi:C}=(0,n.i)(m,(e,t)=>({setIsUsingV3Reasons(e){t(m,t=>Object.assign(Object.assign({},t),{isUsingV3Reasons:e}))},setConversationListType(e){t(m,t=>Object.assign(Object.assign({},t),{conversationListType:e}))},setChatMode(e){t(m,t=>Object.assign(Object.assign({},t),{chatMode:e}))},setNotice(e){t(m,t=>Object.assign(Object.assign({},t),{notice:e}))},setClickableNotice(e){t(m,t=>Object.assign(Object.assign({},t),{clickableNotice:e}))},addAcceptedStranger(e){t(m,t=>Object.assign(Object.assign({},t),{acceptedStrangerList:[...t.acceptedStrangerList,e]}))},setReportReasons(e){t(m,t=>Object.assign(Object.assign({},t),{reportResons:e}))},setSelectedReportReasons(e){t(m,t=>Object.assign(Object.assign({},t),{selectedReportReasons:e}))},setIsShowReportSelectModal(e){t(m,t=>Object.assign(Object.assign({},t),{isShowReportSelectModal:e}))},setIsShowContactButton(e){t(m,t=>Object.assign(Object.assign({},t),{isShowContactButton:e}))},setIsShowReportSuccessModal(e){t(m,t=>Object.assign(Object.assign({},t),{isShowReportSuccessModal:e}))},getConversationNotice(e){return f(this,void 0,void 0,function*(){try{const{secUid:s,conversationId:i}=e;if(!s||!i)return this.setNotice(""),void this.setClickableNotice(null);const n=yield(t={secUid:s,conversationId:i},f(void 0,void 0,void 0,function*(){const{secUid:e,conversationId:s}=t;return o.h.get("/api/im/chat/notice",{query:{sec_to_user_id:e,conversation_id:s,aid:1988},baseUrlType:r.Z4.FixedWww})})),{data:a}=n;if(a.msg_type===u.eh){const{tips:e,template:t}=a.msg_content;if(t){const{key:s,name:i}=t[0]||{};this.setClickableNotice({desc:e,clickText:i,template:`{{${s}}}`,action:u.hr.OpenPrivacySetting})}else this.setNotice(e),this.setClickableNotice(null)}else this.setNotice(""),this.setClickableNotice(null)}catch(e){this.setNotice(""),this.setClickableNotice(null)}var t})},acceptStranger(e){return f(this,void 0,void 0,function*(){const{id:t,uid:s}=e,i=yield(({id:e,uid:t})=>f(void 0,void 0,void 0,function*(){return o.h.post("/api/im/stranger/unlimit",{query:{aid:1988},headers:{[r.nk]:o.h.csrfToken},body:a.stringify({conversation_id:e,to_user_id:t}),baseUrlType:r.Z4.FixedWww})}))({id:t,uid:s}),{status_code:n}=i;if(0===n){const e=(()=>{var e;let t=[];try{const s=null!==(e=localStorage.getItem(u.BR))&&void 0!==e?e:"";t=Array.isArray(JSON.parse(s))?JSON.parse(s):[]}catch(e){t=[]}return t})();e.push(t),localStorage.setItem(u.BR,JSON.stringify(e)),this.addAcceptedStranger(t)}else{const e=(0,v.T)();g.F.open({content:e("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"})}return i})},deleteStranger(t){var s,i;return f(this,void 0,void 0,function*(){const{conversation:n}=t,{selectedConversation:o}=e(h.nU);yield(0,c.fI)().deleteConversation({conversation:n});const{strangerConversationList:r}=e(l.lU);if((0,l.YJ)().setStrangerConversationList(r.filter(e=>e.id!==n.id)),(null==o?void 0:o.shortId)===n.shortId){var a;const e=null!==(s=n.toParticipantUserId)&&void 0!==s?s:"",t=null!==(i=null==(a=(0,p.py)().getUser(e))?void 0:a.uniqueId)&&void 0!==i?i:"";(0,l.Hz)(u.jh.UserDelete,{uid:e,uniqueId:t,conversationShortId:n.shortId}),(0,h.IA)().setSelectedConversation(void 0)}})},getReportReasons(t){return f(this,void 0,void 0,function*(){const{isUsingV3Reasons:s}=e(m),i=yield((e,t)=>f(void 0,void 0,void 0,function*(){return o.h.get("/node/report/reasons",{query:{report_type:d.Im,lang:e,api_version:t?3:2},baseUrlType:r.Z4.FixedWww})}))(t,s),{body:n=[]}=i;this.setReportReasons(n)})},postReport(e){return f(this,void 0,void 0,function*(){const t=(0,v.T)();try{const i=yield(s=e,f(void 0,void 0,void 0,function*(){return o.h.post("/aweme/v2/aweme/feedback/",{query:s,baseUrlType:r.Z4.FixedWww})})),{status_code:n}=i;if(0!==n)return void g.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"});this.setChatMode(u.M5.Default),this.setIsShowReportSuccessModal(!0)}catch(e){g.F.open({content:t("Sorry, something wrong with the server, please try again."),duration:3,widthType:"half"})}var s})}}))}}]);