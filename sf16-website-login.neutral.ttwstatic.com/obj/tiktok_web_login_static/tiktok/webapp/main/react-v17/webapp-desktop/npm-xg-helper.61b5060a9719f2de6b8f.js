"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[5817],{4682:(e,t,i)=>{function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function s(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var i,n=o(e);if(t){var a=o(this).constructor;i=Reflect.construct(n,arguments,a)}else i=n.apply(this,arguments);return function(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t,i){return t&&l(e.prototype,t),i&&l(e,i),e}i.d(t,{Ay:()=>h,Dc:()=>f,IT:()=>d});var h=function(){function e(){u(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return c(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"destroy",value:function(){this.reset(),this.id=-1}}]),e}(),d=function(e){n(i,e);var t=s(i);function i(){var e;return u(this,i),(e=t.call(this)).TAG="AudioTrack",e.type="audio",e}return i}(h),f=function(e){n(i,e);var t=s(i);function i(){var e;return u(this,i),(e=t.call(this)).TAG="VideoTrack",e.type="video",e.dropped=0,e.sequenceNumber=0,e}return c(i,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),i}(h)},16216:(e,t,i)=>{function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}i.d(t,{A:()=>s});var a=function e(){n(this,e),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0};const s=function(){function e(){n(this,e),this.sources={}}var t,i;return t=e,(i=[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new a,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.clear()}}])&&r(t.prototype,i),e}()},25202:(e,t,i)=>{i.d(t,{A:()=>Le});var r=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.filtered=-1,this.tagType=-1,this.datasize=-1,this.dts=-1};function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}var o=function(){function e(t){n(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return s(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),u=function(){function e(t){n(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return s(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}();function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return t=e,r=[{key:"getDefault",value:function(){return{dts:-1,pts:void 0,isKeyframe:!1,originDts:-1,data:new Uint8Array,nals:[]}}}],(i=null)&&l(t.prototype,i),r&&l(t,r),e;var t,i,r}();function h(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const d=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}var t,i,r;return t=e,r=[{key:"readByte",value:function(e,t,i){var r;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}],(i=[{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",get:function(){return this.dataview.position},set:function(e){this.dataview.position=e}},{key:"back",value:function(e){this.position-=e}},{key:"getUint8",value:function(e){return this.dataview.getUint8(e)}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}}])&&h(t.prototype,i),r&&h(t,r),e}();function f(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const p=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var t,i;return t=e,(i=[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e;for(e=0;e<this._currentWordBitsLeft;e++)if(this._currentWord&2147483648>>>e)return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}])&&f(t.prototype,i),e}();function y(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var v=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new p(i);r.readByte();var n=r.readByte();r.readByte();var a=r.readByte();r.readUEG();var s=e.getProfileString(n),o=e.getLevelString(a),u=1,l=420,c=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(3===(u=r.readUEG())&&r.readBits(1),u<=3&&(l=[0,420,422,444][u]),c=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var h=3!==u?8:12,d=0;d<h;d++)r.readBool()&&(d<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var f=r.readUEG();if(0===f)r.readUEG();else if(1===f){r.readBits(1),r.readSEG(),r.readSEG();for(var y=r.readUEG(),v=0;v<y;v++)r.readSEG()}r.readUEG(),r.readBits(1);var _=r.readUEG(),g=r.readUEG(),m=r.readBits(1);0===m&&r.readBits(1),r.readBits(1);var E=0,b=0,k=0,A=0;r.readBool()&&(E=r.readUEG(),b=r.readUEG(),k=r.readUEG(),A=r.readUEG());var T=1,S=1,w=0,D=!0,R=0,L=0;if(r.readBool()){if(r.readBool()){var B=r.readByte();B>0&&B<16?(T=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][B-1],S=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][B-1]):255===B&&(T=r.readByte()<<8|r.readByte(),S=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var O=r.readBits(32),C=r.readBits(32);D=r.readBool(),w=(R=C)/(L=2*O)}}var U=1;1===T&&1===S||(U=T/S);var x=0,P=0;0===u?(x=1,P=2-m):(x=3===u?1:2,P=(1===u?2:1)*(2-m));var I=16*(_+1),M=16*(g+1)*(2-m);I-=(E+b)*x,M-=(k+A)*P;var G=Math.ceil(I*U);return r.destroy(),r=null,{profile_string:s,level_string:o,bit_depth:c,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:D,fps:w,fps_den:L,fps_num:R},par_ratio:{width:T,height:S},codec_size:{width:I,height:M},present_size:{width:G,height:M}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,r=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/r)),t}}],null&&y(t.prototype,null),i&&y(t,i),e}();const _=v;function g(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const m=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}],null&&g(t.prototype,null),i&&g(t,i),e}();function E(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var b=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t};const k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_resolveNalu",value:function(e){return e.length>=1?m.EBSP2SODB(m.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);if(5===n)return e.user_data_unregistered(s);var o=e.getPayloadLength(s),u=o.payloadLength,l=o.offset;return{code:n,content:s.slice(l),size:u}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:b(a.slice(0,16)),content:b(a.slice(16,r)),size:r}}}],null&&E(t.prototype,null),i&&E(t,i),e}();function A(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var T=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};e.analyseNal(s),s.type<=9&&0!==s.type&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:try{e.sei=k.parse(e.body)}catch(e){}break;case 7:e.sps=_.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=r:(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),r),r+=2,i.set(e,r),i[r+=e.byteLength]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),r+=2,i.set(t,r),i}}],null&&A(t.prototype,null),i&&A(t,i),e}();const S=T;function w(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const D=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var t,i;return t=e,(i=[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e;for(e=0;e<this._currentWordBitsLeft;e++)if(this._currentWord&2147483648>>>e)return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}])&&w(t.prototype,i),e}();function R(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var L=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i,r,n,a,s,o,u=e._ebsp2rbsp(t),l=new D(u),c=0,h=0,d=0,f=0,p=0,y=0,v=0,_=0,g=0;return l.readByte(),l.readByte(),l.readBits(4),i=l.readBits(3),l.readBits(1),o=e._readProfileTierLevel(l,i),l.readUEG(),3===(r=l.readUEG())&&(c=l.readBits(1)),h=l.readUEG(),d=l.readUEG(),1===(n=l.readBits(1))&&(f=l.readUEG(),p=l.readUEG(),y=l.readUEG(),v=l.readUEG()),a=l.readUEG(),s=l.readUEG(),1===n&&(h-=(_=1!==r&&2!==r||0!==c?1:2)*p+_*f,d-=(g=1===r&&0===c?2:1)*v+g*y),l.destroy(),l=null,{width:h,height:d,general_profile_space:o.general_profile_space,general_tier_flag:o.general_tier_flag,general_profile_idc:o.general_profile_idc,general_level_idc:o.general_level_idc,chromaFormatIdc:r,bitDepthLumaMinus8:a,bitDepthChromaMinus8:s}}},{key:"_readProfileTierLevel",value:function(e,t){var i,r,n,a;i=e.readBits(2)||0,r=e.readBits(1)||0,n=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var s=[],o=[],u=0;u<t;u++)s[u]=e.readBits(1),o[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==s[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:r,general_profile_idc:n,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}],null&&R(t.prototype,null),i&&R(t,i),e}();const B=L;function O(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const C=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}],null&&O(t.prototype,null),i&&O(t,i),e}();function U(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var x=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t};const P=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_resolveNalu",value:function(e){return e.length>=1?C.EBSP2SODB(C.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);if(5===n)return e.user_data_unregistered(s);var o=e.getPayloadLength(s),u=o.payloadLength,l=o.offset;return{code:n,content:s.slice(l),size:u}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:x(a.slice(0,16)),content:x(a.slice(16,r)),size:r}}}],null&&U(t.prototype,null),i&&U(t,i),e}();function I(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var M=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=40&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getHvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};try{e.analyseNal(s)}catch(e){continue}s.type<=40&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=B.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:default:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:try{e.sei=P.parse(e.body.slice(1))}catch(e){}break;case 40:e.sei=P.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=r:(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}}],null&&I(t.prototype,null),i&&I(t,i),e}();const G=M;var F,V=(F=new ArrayBuffer(2),new DataView(F).setInt16(0,256,!0),256===new Int16Array(F)[0]),N={get device(){var e=N.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=window.navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(function(i){return t[i].test(e)}))[0]},get os(){var e=window.navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:r,isPc:!s&&!r&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:n}},get isLe(){return V}};const j=N;function H(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const z=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"decode",value:function(t){for(var i=[],r=t,n=0,a=t.length;n<a;)if(r[n]<128)i.push(String.fromCharCode(r[n])),++n;else{if(r[n]<192);else if(r[n]<224){if(e._checkContinuation(r,n,1)){var s=(31&r[n])<<6|63&r[n+1];if(s>=128){i.push(String.fromCharCode(65535&s)),n+=2;continue}}}else if(r[n]<240){if(e._checkContinuation(r,n,2)){var o=(15&r[n])<<12|(63&r[n+1])<<6|63&r[n+2];if(o>=2048&&55296!=(63488&o)){i.push(String.fromCharCode(65535&o)),n+=3;continue}}}else if(r[n]<248&&e._checkContinuation(r,n,3)){var u=(7&r[n])<<18|(63&r[n+1])<<12|(63&r[n+2])<<6|63&r[n+3];if(u>65536&&u<1114112){u-=65536,i.push(String.fromCharCode(u>>>10|55296)),i.push(String.fromCharCode(1023&u|56320)),n+=4;continue}}i.push(String.fromCharCode(65533)),++n}return i.join("")}},{key:"_checkContinuation",value:function(e,t,i){var r=e;if(t+i<r.length){for(;i--;)if(128!=(192&r[++t]))return!1;return!0}return!1}}],null&&H(t.prototype,null),i&&H(t,i),e}();function W(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var X=j.isLe,Y=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.offset=0,this.readOffset=this.offset}var t,i;return t=e,(i=[{key:"resolve",value:function(e,t){if(t<3)throw new Error("not enough data for metainfo");var i={};try{var r=this.parseValue(e),n=this.parseValue(e,t-r.bodySize);i[r.data]=n.data}catch(e){}return this.resetStatus(),i}},{key:"resetStatus",value:function(){this.offset=0,this.readOffset=this.offset}},{key:"parseString",value:function(e){var t,i=new DataView(e,this.readOffset).getUint16(0,!X);t=i>0?z.decode(new Uint8Array(e,this.readOffset+2,i)):"";var r=i+2;return this.readOffset+=r,{data:t,bodySize:i+2}}},{key:"parseDate",value:function(e,t){var i=new DataView(e,this.readOffset,t),r=i.getFloat64(0,!X);return r+=60*i.getInt16(8,!X)*1e3,this.readOffset+=10,{data:new Date(r),bodySize:10}}},{key:"parseObject",value:function(e,t){var i=this.parseString(e,t),r=this.parseValue(e,t-i.bodySize);return{data:{name:i.data,value:r.data},bodySize:i.bodySize+r.bodySize,isObjEnd:r.isObjEnd}}},{key:"parseLongString",value:function(e){var t,i=new DataView(e,this.readOffset).getUint32(0,!X);return t=i>0?z.decode(new Uint8Array(e,this.readOffset+2,i)):"",this.readOffset+=i+4,{data:t,bodySize:i+4}}},{key:"parseValue",value:function(e,t){var i=new ArrayBuffer;i=e instanceof ArrayBuffer?e:e.buffer;var r=new DataView(i,this.readOffset,t),n=!1,a=r.getUint8(0),s=1;this.readOffset+=1;var o=null;switch(a){case 0:o=r.getFloat64(1,!X),this.readOffset+=8,s+=8;break;case 1:o=!!r.getUint8(1),this.readOffset+=1,s+=1;break;case 2:var u=this.parseString(i);o=u.data,s+=u.bodySize;break;case 3:o={};var l=0;for(16777215&r.getUint32(t-4,!X)&&(l=3);s<t-4;){var c=this.parseObject(i,t-s-l);if(c.isObjectEnd)break;o[c.data.name]=c.data.value,s+=c.bodySize}s<=t-3&&9==(16777215&r.getUint32(s-1,!X))&&(this.readOffset+=3,s+=3);break;case 8:o={},s+=4,this.readOffset+=4;var h=0;for(9==(16777215&r.getUint32(t-4,!X))&&(h=3);s<t-8;){var d=this.parseObject(i,t-s-h);if(d.isObjectEnd)break;o[d.data.name]=d.data.value,s+=d.bodySize}s<=t-3&&9==(16777215&r.getUint32(s-1,!X))&&(s+=3,this.readOffset+=3);break;case 9:o=null,n=!0;break;case 10:o=[];var f=r.getUint32(1,!X);s+=4,this.readOffset+=4;for(var p=0;p<f;p++){var y=this.parseValue(i,t-s);o.push(y.data),s+=y.bodySize}break;case 11:var v=this.parseDate(i,t-1);o=v.data,s+=v.bodySize;break;case 12:var _=this.parseLongString(i,t-1);o=_.data,s+=_.bodySize;break;default:s=t}return{data:o,bodySize:s,isObjEnd:n}}}])&&W(t.prototype,i),e}(),K=i(42990),q=i.n(K);function Q(e){var t=[],i=e.length;if(i<=48)return e;for(var r=0;r<i-4;)0===e[r]&&0===e[r+1]&&3===e[r+2]&&e[r+3]<=3?(t.push(r+2),r+=3):r+=1;if(t.length){var n=new Uint8Array(i-t.length),a=0;return t.map(function(r,s){var o=t[s-1]||-1,u=e.slice(o+1,r);n.set(u,a),a+=u.length,s===t.length-1&&r+1<i&&n.set(e.slice(r+1),a)}),n}return e}function Z(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var J=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),$(this,"_bytesAvailable",void 0),$(this,"_bitsAvailable",0),$(this,"_word",0),!t)throw new Error("ExpGolomb data params is required");this._data=t,this._bytesAvailable=t.byteLength,this._bytesAvailable&&this._loadWord()}var t,i;return t=e,(i=[{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(0===t)throw new Error("No bytes available");var i=new Uint8Array(4);i.set(this._data.subarray(e,e+t)),this._word=new DataView(i.buffer).getUint32(0),this._bitsAvailable=8*t,this._bytesAvailable-=t}},{key:"bitsPos",value:function(){return 8*this._bytesAvailable-this._bitsAvailable}},{key:"bitsLeft",value:function(){return 8*this._data.length-this.bitsPos()}},{key:"byteAligned",value:function(){return 0===this.bitsPos()||this.bitsPos()%8==0}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{e-=this._bitsAvailable;var t=Math.floor(e/8);e-=8*t,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw new Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),i=this._word>>>32-t;return this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),(t=e-t)>0&&this._bitsAvailable?i<<t|this.readBits(t):i}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if(this._word&2147483648>>>e)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,i=8,r=0;r<e;r++)0!==i&&(i=(t+this.readEG()+256)%256),t=0===i?t:i}}])&&Z(t.prototype,i),e}();function ee(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function te(e){for(var t=e.byteLength,i=[],r=1;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(!i.length)return e;var n=t-i.length,a=new Uint8Array(n),s=0;for(r=0;r<n;s++,r++)s===i[0]&&(s++,i.shift()),a[r]=e[s];return a}var ie=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"parseHEVCDecoderConfigurationRecord",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!(t.length<23)){i=i||{};for(var r,n,a,s,o,u=1+(3&t[21]),l=[],c=[],h=[],d=23,f=t[22],p=0;p<f;p++){a=63&t[d],s=t[d+1]<<8|t[d+2],d+=3;for(var y=0;y<s;y++)if(o=t[d]<<8|t[d+1],d+=2,o){switch(a){case 32:var v=t.subarray(d,d+o);r||(r=e.parseVPS(te(v),i)),h.push(v);break;case 33:var _=t.subarray(d,d+o);n||(n=e.parseSPS(te(_),i)),l.push(_);break;case 34:c.push(t.subarray(d,d+o))}d+=o}}return{hvcC:i,sps:n,spsArr:l,ppsArr:c,vpsArr:h,nalUnitSize:u}}}},{key:"parseVPS",value:function(t,i){i=i||{};var r=new J(t);r.readUByte(),r.readUByte(),r.readBits(12);var n=r.readBits(3);return i.numTemporalLayers=Math.max(i.numTemporalLayers||0,n+1),r.readBits(17),e._parseProfileTierLevel(r,n,i),i}},{key:"parseSPS",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i=i||{};var r=new J(t);r.readUByte(),r.readUByte(),r.readBits(4);var n=r.readBits(3);i.numTemporalLayers=Math.max(n+1,i.numTemporalLayers||0),i.temporalIdNested=r.readBits(1),e._parseProfileTierLevel(r,n,i),r.readUEG();var a=i.chromaFormatIdc=r.readUEG(),s=420;a<=3&&(s=[0,420,422,444][a]);var o=0;3===a&&(o=r.readBits(1));var u,l,c,h,d=r.readUEG(),f=r.readUEG(),p=r.readBits(1);return 1===p&&(u=r.readUEG(),l=r.readUEG(),c=r.readUEG(),h=r.readUEG()),i.bitDepthLumaMinus8=r.readUEG(),i.bitDepthChromaMinus8=r.readUEG(),1===p&&(d-=(1!==a&&2!==a||0!==o?1:2)*(l+u),f-=(1===a&&0===o?2:1)*(h+c)),{codec:"hev1.1.6.L93.B0",width:d,height:f,chromaFormat:s,hvcC:i}}},{key:"_parseProfileTierLevel",value:function(e,t,i){var r=i.generalTierFlag||0;i.generalProfileSpace=e.readBits(2),i.generalTierFlag=Math.max(e.readBits(1),r),i.generalProfileIdc=Math.max(e.readBits(5),i.generalProfileIdc||0),i.generalProfileCompatibilityFlags=e.readBits(32),i.generalConstraintIndicatorFlags=[e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8),e.readBits(8)];var n=e.readBits(8);r<i.generalTierFlag?i.generalLevelIdc=n:i.generalLevelIdc=Math.max(n,i.generalLevelIdc||0);for(var a=[],s=[],o=0;o<t;o++)a[o]=e.readBits(1),s[o]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var u=0;u<t;u++)0!==a[u]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==s[u]&&e.readBits(8)}}],null&&ee(t.prototype,null),i&&ee(t,i),e}();function re(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ne(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ae(e,t,i){return t&&ne(e.prototype,t),i&&ne(e,i),e}var se=k,oe=function(){function e(t){re(this,e),this._buffer=t,this._offset=0,this._heldBits=0,this._numHeldBits=0}return ae(e,[{key:"readUint8",value:function(){return this._buffer[this._offset++]}},{key:"readUint16",value:function(){return this._buffer[this._offset++]<<8|this._buffer[this._offset++]}},{key:"readUint32",value:function(){return this._buffer[this._offset++]<<24|this._buffer[this._offset++]<<16|this._buffer[this._offset++]<<8|this._buffer[this._offset++]}},{key:"readUint8Array",value:function(e){var t=this._buffer.slice(this._offset,this._offset+e);return this._offset+=e,t}},{key:"streamRead1Bytes",value:function(){this._heldBits=this.readUint8(),this._numHeldBits=8}},{key:"streamRead2Bytes",value:function(){this._heldBits=this.readUint16(),this._numHeldBits=16}},{key:"extractBits",value:function(e){var t=this._heldBits>>this._numHeldBits-e&(1<<e)-1;return this._numHeldBits-=e,t}}]),e}(),ue=function(){function e(){re(this,e)}return ae(e,null,[{key:"parseVVCDecoderConfigurationRecord",value:function(t){var i=new oe(t);i.streamRead1Bytes(),i.extractBits(5);var r,n,a,s,o,u,l,c,h=i.extractBits(2)+1,d=i.extractBits(1),f={};d&&(i.streamRead2Bytes(),r=i.extractBits(9),n=i.extractBits(3),a=i.extractBits(2),s=i.extractBits(2),i.streamRead1Bytes(),o=i.extractBits(3),i.extractBits(5),f=e.parseVVCPTLRecord(i,n),u=i.readUint16(),l=i.readUint16(),c=i.readUint16());for(var p=i.readUint8(),y=[],v=[],_=[],g=null,m=0;m<p;m++){i.streamRead1Bytes(),i.extractBits(1),i.extractBits(2);var E=i.extractBits(5),b=1;13!==E&&12!==E&&(b=i.readUint16());for(var k=0;k<b;k++){var A=i.readUint16();switch(E){case 14:y.push(i.readUint8Array(A));break;case 15:var T=i.readUint8Array(A);g||(g=e.parseSPS(e.removeEPB(T))),v.push(T);break;case 16:_.push(i.readUint8Array(A))}}}var S={vvcC:t,nalUnitSize:h,ptlPresentFlag:d,olsIdx:r,numSublayers:n,constantFrameRate:a,chromaFormatIdc:s,bitDepthLumaMinus8:o,ptlRecord:f,maxPictrueWidth:u,maxPictureHeight:l,avgFrameRate:c,numOfArrays:p,vpsArr:y,spsArr:v,ppsArr:_,spsParsed:g};return console.log("parseVVCDecoderConfigurationRecord:",t),console.log(S),S}},{key:"parseVVCPTLRecord",value:function(e,t){e.streamRead2Bytes(),e.extractBits(2);var i=e.extractBits(6),r=e.extractBits(7),n=e.extractBits(1),a=e.readUint8();e.streamRead1Bytes();var s=e.extractBits(1),o=e.extractBits(1),u=new Uint8Array(i);if(i){for(var l=0;l<i-1;l++){var c=e.extractBits(6);e.streamRead1Bytes();var h=e.extractBits(2);u[l]=c<<2|h}u[i-1]=e.extractBits(6)}else e.extractBits(6);var d=[];if(t>1){e.streamRead1Bytes();for(var f=0,p=t-2;p>=0;--p)f|=e.extractBits(1)<<p;for(var y=t;y<=8&&t>1;++y)e.extractBits(1);for(var v=t-2;v>=0;--v)f&1<<v&&(d[v]=e.readUint8())}var _=e.readUint8(),g=[];if(_)for(var m=0;m<_;m++)g.push(e.readUint32());return{generalProfileIdc:r,generalTierFlag:n,generalLevelIdc:a,ptlFrameOnlyConstraintFlag:s,ptlMultilayerEnabledFlag:o,generalConstraintInfo:u,subLayerLevelIdc:d,generalSubProfileIdc:g,ptlNumSubProfiles:_,numBytesConstraintInfo:i}}},{key:"getAvccNals",value:function(e){for(var t=[];e.position<e.length-4;){var i=e.dataview.getInt32(e.dataview.position);if(!(e.length-e.position>=i))break;var r=e.buffer.slice(e.position,e.position+4);e.skip(4);var n=new Uint8Array(e.buffer.slice(e.position,e.position+i));e.skip(i),t.push({header:r,body:n})}return t}},{key:"analyseNal",value:function(e){var t=(248&e.body[1])>>3;switch(e.type=t,t){case 23:case 24:try{e.sei=se.parse(e.body.slice(1))}catch(e){}break;case 7:case 8:e.key=!0;break;case 14:e.vps=!0;break;case 15:e.sps=!0;break;case 16:e.pps=!0;break;case 17:e.aps=!0}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,i=[],r=1;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(!i.length)return e;var n=t-i.length,a=new Uint8Array(n),s=0;for(r=0;r<n;s++,r++)s===i[0]&&(s++,i.shift()),a[r]=e[s];return a}},{key:"parseVps",value:function(){}},{key:"parseSPS",value:function(t){console.log(t);var i=new J(t);i.readUByte(),i.readUByte(),i.skipBits(4);var r=i.readBits(4),n=i.readBits(3),a=i.readBits(2),s=420;a<=3&&(s=[0,420,422,444][a]),i.readBits(2),i.readBits(1);var o=e._parseProfileTierLevel(i,1,n);return i.readBits(1),i.readBits(1)&&i.readBits(1),{width:i.readUEG(),height:i.readUEG(),spsMaxSubLayerMinus1:n,spsVideoParameterSetId:r,chromaFormatIdc:a,chromaFormat:s,ptlInfo:o}}},{key:"_parseProfileTierLevel",value:function(t,i,r){var n,a=t.readBits(7),s=t.readBits(1),o=t.readBits(8),u=t.readBits(1),l=t.readBits(1);i&&(n=e._parseGeneralConstraintsInfo(t));for(var c=r-1,h=[],d=[],f=[],p=c;p>=0;--p)h[p]=t.readBits(1);for(;!t.byteAligned();)t.readBits(1);for(var y=c;y>=0;--y)h[y]&&(d[y]=t.readUByte());if(i)for(var v=t.readUByte(),_=0;_<v;_++)f[_]=t.readBits(32);return{generalProfileIdc:a,generalTierFlag:s,generalLevelIdc:o,ptlFrameOnlyConstraintFlag:u,ptlMultilayerEnabledFlag:l,ptlSublayerLevelPresentFlags:h,ptlSublayerLevelIdcs:d,ptlSubProfileIdcs:f,gciInfo:n}}},{key:"_parseGeneralConstraintsInfo",value:function(e){var t=e.readBits(1);if(t){e.skipBits(71);var i=e.readBits(8);i&&e.skipBits(i)}var r=8-e.bitsPos()%8;return e.skipBits(r),{gciPresentFlag:t}}}]),e}();function le(e){return le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},le(e)}function ce(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function he(e,t,i){return he="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=fe(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}},he(e,t,i||e)}function de(e,t){return de=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},de(e,t)}function fe(e){return fe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},fe(e)}var pe=_,ye=S,ve=B,_e=G,ge=[19,20,21],me=[5],Ee=[0,1,2,3,4,5,6,7,8,9,16,17,18,19,20,21],be=[1,5],ke=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&de(e,t)}(h,e);var t,i,n,a,s,l=(a=h,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=fe(a);if(s){var i=fe(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==le(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function h(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(t=l.call(this))._headerParsed=!1,t._gopId=0,t._cfg=e,t._videoRecentMetadata=null,t._isEncrypt=0,t._decryptorReady=!1,e.keyStr&&e.Decryptor&&(t._decryptor=new e.Decryptor,t._decryptor.descryptKey(e.keyStr).then(function(){t._decryptorReady=!0}).catch(function(e){t.emit(h.EVENTS.PARSE_ERROR,new Error(e&&e.message||"decryptor init error"))})),t._onMetaData=null,t._audioMetaParsed=!1,t._vSeqHeaderIndex=0,t._userAgent="undefined"==typeof window?"":window.navigator.userAgent.toLowerCase()||"",t}return t=h,i=[{key:"foundAudioMetaFromScriptTag",get:function(){var e,t;return(null===(e=this._onMetaData)||void 0===e?void 0:e.audiosamplerate)&&(null===(t=this._onMetaData)||void 0===t?void 0:t.audiochannels)}},{key:"demux",value:function(e){if(this._headerParsed){if(e.length<11)return;var t,i=1e4;do{t=this._parseFlvTag(e)}while(t&&i-- >0)}else{if(this._decryptor&&!this._decryptorReady)return;if(e.length<13)return;var r=e.shift(13);this.parseFlvHeader(r),this.demux(e)}}},{key:"parseFlvHeader",value:function(e){if(!h.isFlvFile(e))throw new Error("invalid flv file,".concat(e.join(",")));this._headerParsed=!0;var t=e[4]>>>2==1,i=!(1&~e[4]);this.emit(h.EVENTS.FILE_HEADER_PARSED,{hasVideo:i,hasAudio:t})}},{key:"_parseFlvTag",value:function(e){var t=e.toInt(1,3);if(e.length<11+t+4)return null;var i=this._parseFlvTagHeader(e);if(i&&(this._processTagData(i,e),!this._datasizeValidator(i.datasize,e)))throw new Error("TAG length error at "+i.datasize);return i}},{key:"_parseFlvTagHeader",value:function(e){var t=0,i=new r,n=e.toInt(t,1);if(t+=1,i.filtered=(32&n)>>>5,i.tagType=31&n,i.datasize=e.toInt(t,3),t+=3,8!==i.tagType&&9!==i.tagType&&11!==i.tagType&&18!==i.tagType)throw e&&e.length>0&&e.shift(1),new Error("tagType "+i.tagType);if(e.length<i.datasize+15)return null;e.shift(4);var a=e.toInt(0,3);e.shift(3);var s=e.shift(1)[0];return s>0&&(a+=16777216*s),i.dts=a,e.shift(3),i}},{key:"_processTagData",value:function(e,t){switch(e.tagType){case 18:this._parseScriptData(e,t);break;case 8:this._parseAudioTag(e,t);break;case 9:this._parseVideoData(e,t);break;case 11:t.shift(3);break;default:t.shift(1)}}},{key:"_parseScriptData",value:function(e,t){e.data=t.shift(e.datasize);var i=(new Y).resolve(e.data,e.data.length);if(this._onMetaData=i?i.onMetaData:void 0,this.emit(h.EVENTS.SCRIPT_TAG_PARSED,this._onMetaData),!this._isEncrypt){var r=this._onMetaData.encrypt_method;if(r){if("SAMPLE-AES"!==r)throw new Error("invalid encrypt method: ".concat(r));if(!this._cfg.keyStr)throw new Error("no decrypt key found");this._isEncrypt=1}}}},{key:"_aacSequenceHeaderParser",value:function(e){var t,i,r={hasSpecificConfig:!0};r.objectType=e[1]>>>3,r.originObjectType=r.objectType,r.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,r.audiosamplerate=this._switchAudioSampleRate(r.sampleRateIndex),r.channelCount=(120&e[2])>>>3,r.frameLength=(4&e[2])>>>2,r.dependsOnCoreCoder=(2&e[2])>>>1,r.extensionFlagIndex=1&e[2];var n=r.sampleRateIndex;return this._userAgent&&-1!==this._userAgent.indexOf("firefox")?r.sampleRateIndex>=8?(r.objectType=5,i=new Array(4),t=n-3):(r.objectType=2,i=new Array(2),t=n):this._userAgent&&-1!==this._userAgent.indexOf("android")||this._userAgent&&-1!==this._userAgent.indexOf("iphone")?(r.objectType=2,i=new Array(2),t=n):(r.objectType=5,t=r.sampleRateIndex,i=new Array(4),r.sampleRateIndex>=6?t=r.sampleRateIndex-3:1===r.channelCount&&(r.objectType=2,i=new Array(2),t=r.sampleRateIndex)),r.codec="mp4a.40.".concat(r.objectType),i[0]=r.objectType<<3,i[0]|=(15&r.sampleRateIndex)>>>1,i[1]=(15&r.sampleRateIndex)<<7,i[1]|=(15&r.channelCount)<<3,5===r.objectType&&(i[1]|=(15&t)>>>1,i[2]=(1&t)<<7,i[2]|=8,i[3]=0),r.config=i,r}},{key:"_parseAudioTag",value:function(e,t){var i=new o,r=t.shift(1)[0];e.data=t.shift(e.datasize-1);var n=(240&r)>>>4;if(10!==n)throw new Error("invalid audio format: ".concat(n));10===n&&(i.sampleRate=this._switchAudioSamplingFrequency(r),i.sampleRateIndex=(12&r)>>>2,i.frameLenth=(2&r)>>>1,i.channelCount=1&r,i.refSampleDuration=Math.floor(1024/i.audioSampleRate*i.timescale));var a=i.audioSampleRate,s=i.sampleRateIndex,u=i.refSampleDuration;if(0===e.data[0]){var l=this._aacSequenceHeaderParser(e.data);a=l.audiosamplerate||i.audioSampleRate,s=l.sampleRateIndex||i.sampleRateIndex,u=Math.floor(1024/a*i.timescale),i.channelCount=l.channelCount,i.sampleRate=a,i.sampleRateIndex=s,i.refSampleDuration=u,i.duration=this._onMetaData?this._onMetaData.duration*i.timescale:0,i.config=l.config,i.objectType=l.objectType,i.originObjectType=l.originObjectType,this.emit(h.EVENTS.AUDIO_META_PARSED,i),this._audioMetaParsed=!0}else{if(!this._audioMetaParsed&&!this.foundAudioMetaFromScriptTag)throw new Error("flv stream without audio metadata detected");e.data=e.data.slice(1,e.data.length),this._isEncrypt&&this._decryptor&&(e.data=this._decryptor.decryptAudio(e.data)),this.emit(h.EVENTS.AUDIO_SAMPLE_PARSED,e)}}},{key:"_parseVideoData",value:function(e,t){var i=t.shift(1)[0],r=new c(e),n=(240&i)>>>4;r.isKeyframe=1===n;var a=15&i;if(e.avcPacketType=t.shift(1)[0],r.cts=t.toInt(0,3),r.cts=r.cts<<8>>8,t.shift(3),7!==a&&12!==a&&14!==a)throw new Error("video codeid is ".concat(a));var s,o=12===a,u=14===a,l=t.shift(e.datasize-5);if(0===l[4]&&0===l[5]&&0===l[6]&&1===l[7]){for(var f=0,p=0;p<4;p++)f=256*f+l[p];f-=4,(l=l.slice(4,l.length))[3]=f%256,f=(f-l[3])/256,l[2]=f%256,f=(f-l[2])/256,l[1]=f%256,l[0]=(f-l[1])/256}if(l.length)if(r.data=l,0===e.avcPacketType)(s=o?this._hevcSequenceHeaderParser(l):u?this._vvcSequenceHeaderParser(l):this._avcSequenceHeaderParser(l)).codecID=a,this._videoRecentMetadata=s,this._vSeqHeaderIndex++,this.emit(h.EVENTS.VIDEO_META_PARSED,s);else{for(var y=new d(l.buffer),v=u?ue.getAvccNals(y):o?_e.getHvccNals(y):ye.getAvccNals(y),_=o?ge:me,g=!1,m=0;m<v.length;m++){var E=v[m];u?ue.analyseNal(E):o?_e.analyseNal(E):ye.analyseNal(E),E.sps&&(g=!0),E.sei&&E.sei.size>10&&this.emit(h.EVENTS.VIDEO_SEI_PARSED,Object.assign(E.sei,{dts:e.dts})),_&&_.indexOf(E.type)>-1&&(r.firstInGop=!0,this._gopId++)}this._isEncrypt&&this._decryptor&&(r.data=this._doDecryptNals(v,o)),g||this._checkAppendMetadataNals(r),r.gopId=this._gopId,r.nals=v,this.emit(h.EVENTS.VIDEO_SAMPLE_PARSED,r)}}},{key:"_doDecryptNals",value:function(e,t){for(var i=0,r=[],n=0;n<e.length;n++){var a=e[n],s=t?a.body[0]>>>1&63:31&a.body[0];(t&&Ee.includes(s)||!t&&be.includes(s))&&(a.body=Q(a.body),a.body=this._decryptor.decryptVideo(a.body));var o=a.body.length;a.header=new Uint8Array([o>>24,o>>16,o>>8,o]),r.push(a.header),r.push(a.body),i+=o+4}var u=new Uint8Array(i),l=0;return r.forEach(function(e){u.set(e,l),l+=e.length}),u}},{key:"_checkAppendMetadataNals",value:function(e){if(this._vSeqHeaderIndex>1&&this._videoRecentMetadata&&e.firstInGop){var t,i,r,n=this._videoRecentMetadata.hvcCConfigParsed;n?(t=n.vpsArr[n.vpsArr.length-1],i=n.spsArr[n.spsArr.length-1],r=n.ppsArr[n.ppsArr.length-1]):(t=this._videoRecentMetadata.vps,i=this._videoRecentMetadata.sps,r=this._videoRecentMetadata.pps);var a=[t?[0,0,t.length>>8,t.length%256]:0,t,[0,0,i.length>>8,i.length%256],i,[0,0,r.length>>8,r.length%256],r,e.data].filter(Boolean),s=a.reduce(function(e,t){return e+t.length},0),o=new Uint8Array(s),u=0;a.forEach(function(e){o.set(e,u),u+=e.length}),this._videoRecentMetadata=null,e.data=o}}},{key:"_avcSequenceHeaderParser",value:function(e){var t,i=0,r=new u;r.configurationVersion=e[0],r.avcProfileIndication=e[1],r.profileCompatibility=e[2],r.avcLevelIndication=e[3]/10,r.nalUnitLength=1+(3&e[4]);var n=31&e[5];i=6;for(var a={},s=0;s<n;s++){var o=255*e[i]+e[i+1];i+=2;for(var l=new Uint8Array(o),c=0;c<o;c++)l[c]=e[i+c];for(var h="avc1.",d=1;d<4;d++){var f=l[d].toString(16);f.length<2&&(f="0"+f),h+=f}r.codec=h,i+=o,r.sps=l,a=pe.parseSPS(l)}var p=e[i];i++;for(var y=0;y<p;y++){var v=255*e[i]+e[i+1];i+=2;for(var _=new Uint8Array(v),g=0;g<v;g++)_[g]=e[i+g];i+=v,r.pps=_}return Object.assign(r,pe.toVideoMeta(a)),r.duration=(null===(t=this._onMetaData)||void 0===t?void 0:t.duration)*r.timescale,r.avcc=new Uint8Array(e.length),r.avcc.set(e),r.streamType=27,r}},{key:"_hevcSequenceHeaderParser",value:function(e){var t,i=new u;try{t=ie.parseHEVCDecoderConfigurationRecord(e)}catch(e){}var r=0;i.hvcCConfigParsed=t,i.configurationVersion=e[0],i.hevcProfileSpace=(192&e[1])>>>6,i.hevcTierFlag=(32&e[1])>>>5,i.hevcProfileIdc=31&e[1],i.hevcProfileCompatibilityFlags=[e[2],e[3],e[4],e[5]],i.hevcConstraintIndicatorFlags=[e[6],e[7],e[8],e[9],e[10],e[11]],i.hevcLevelIdc=e[12],i.minSpatialSegmentationIdc=e[13]&15+e[14]<<4,i.parallelismType=3&e[15],i.chromaFormat=3&e[16],i.bitDepthLumaMinus8=7&e[17],i.bitDepthChromaMinus8=7&e[18],i.avgFrameRate=256*e[19]+e[20],i.constantFrameRate=(192&e[21])>>>6,i.numTemporalLayers=(56&e[21])>>>3,i.temporalIdNested=(4&e[21])>>>2,i.lengthSizeMinusOne=3&e[21];var n=e[22];r=23;for(var a,s,o,l={},c=0,h=0,d=0,f=!1,p=!1,y=!1,v=0;v<n;v++){c=63&e[r],h=256*e[r+1]+e[r+2],r+=3;for(var _=0;_<h;_++){switch(d=256*e[r]+e[r+1],c){case 32:f||(f=!0,a=e.slice(r+2,r+2+d),i.vps=ve._ebsp2rbsp(a),i.rawVps=a);break;case 33:p||(p=!0,s=e.slice(r+2,r+2+d),i.sps=ve._ebsp2rbsp(s),i.rawSps=s,i.codec="hev1.1.6.L93.B0",l=ve.parseSPS(s));break;case 34:y||(y=!0,o=e.slice(r+2,r+2+d),i.pps=ve._ebsp2rbsp(o),i.rawPps=o)}r+=2+d}}return Object.assign(i,ve.toVideoMeta(l)),i.streamType=36,i}},{key:"_vvcSequenceHeaderParser",value:function(e){var t,i,r=ue.parseVVCDecoderConfigurationRecord(e),n=new u;return n.presentHeight=n.codecHeight=(null===(t=r.spsParsed)||void 0===t?void 0:t.height)||r.maxPictureHeight,n.presentWidth=n.codecWidth=(null===(i=r.spsParsed)||void 0===i?void 0:i.width)||r.maxPictrueWidth,n.sps=r.spsArr,n.pps=r.ppsArr,n.vps=r.vpsArr,n.codec="vvc1.1.6.L93.B0",n.vvcC=r.vvcC,n.vvcCConfigParsed=r,n}},{key:"_switchAudioSampleRate",value:function(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]}},{key:"_switchAudioSamplingFrequency",value:function(e){return[5500,11025,22050,44100,48e3][(12&e)>>>2]}},{key:"_switchAudioChannel",value:function(e){return[1,2][1&e]}},{key:"_datasizeValidator",value:function(e,t){var i=t.toInt(0,4);return t.shift(4),i===e+11}},{key:"destroy",value:function(){he(fe(h.prototype),"removeAllListeners",this).call(this),this._decryptor&&(this._decryptor.destroy(),this._decryptor=null)}}],n=[{key:"EVENTS",get:function(){return{FILE_HEADER_PARSED:"FILE_HEADER_PARSED",SCRIPT_TAG_PARSED:"SCRIPT_TAG_PARSED",AUDIO_META_PARSED:"AUDIO_META_PARSED",VIDEO_META_PARSED:"VIDEO_META_PARSED",VIDEO_SAMPLE_PARSED:"VIDEO_SAMPLE_PARSED",AUDIO_SAMPLE_PARSED:"AUDIO_SAMPLE_PARSED",VIDEO_SEI_PARSED:"VIDEO_SEI_PARSED",PARSE_ERROR:"PARSE_ERROR"}}},{key:"isFlvFile",value:function(e){return!(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])}},{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}],i&&ce(t.prototype,i),n&&ce(t,n),h}(q());const Ae=ke;var Te=i(4682);function Se(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var we=i(65907).A.DEMUX_EVENTS,De=Ae.EVENTS,Re=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="FLV_DEMUXER",this._cfg=t,this._firstFragmentLoaded=!1,this._trackNum=0,this._hasScript=!1,this._videoMetaChange=!1,this._audioMetaChange=!1,this._hasVideoSequence=!1,this._hasAudioSequence=!1,this._onMetaData=null,this.demuxer=new Ae(t)}var t,i,r;return t=e,r=[{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}],(i=[{key:"init",value:function(){this.on(we.DEMUX_START,this.demux.bind(this)),this.demuxer.on(De.FILE_HEADER_PARSED,this.handleFileHeaderParsed.bind(this)),this.demuxer.on(De.SCRIPT_TAG_PARSED,this.handleScriptTagParsed.bind(this)),this.demuxer.on(De.AUDIO_META_PARSED,this.handleAudioMetaParsed.bind(this)),this.demuxer.on(De.VIDEO_META_PARSED,this.handleVideoMetaParsed.bind(this)),this.demuxer.on(De.VIDEO_SAMPLE_PARSED,this.handleVideoSampleParsed.bind(this)),this.demuxer.on(De.AUDIO_SAMPLE_PARSED,this.handleAudioSampleParsed.bind(this)),this.demuxer.on(De.VIDEO_SEI_PARSED,this.handleSeiParsed.bind(this)),this.demuxer.on(De.VIDEO_SEI_PARSED,this.handleSeiParsed.bind(this)),this.demuxer.on(De.PARSE_ERROR,this.handlePraseError.bind(this))}},{key:"handleAudioMetaParsed",value:function(e){this._cfg.onlyVideo||this.tracks&&this.tracks.audioTrack&&(this._context.mediaInfo.hasAudio=!0,this.tracks.audioTrack.meta=e,this.tracks.audioTrack.hasSpecificConfig=!0,e.channelCount?this._hasAudioSequence?this.emit(we.AUDIO_METADATA_CHANGE,"audio"):this.emit(we.METADATA_PARSED,"audio"):this._context.mediaInfo.hasAudio=!1)}},{key:"handleVideoMetaParsed",value:function(e){this._cfg.onlyAudio||this.tracks&&this.tracks.videoTrack&&(this._onMetaData&&this._onMetaData.framerate&&e.frameRate&&(e.frameRate.fps=this._onMetaData.framerate),this._context.mediaInfo.hasVideo=!0,this.tracks.videoTrack.meta=e,this.tracks.videoTrack.hasSpecificConfig=!0,this._hasVideoSequence?this.emit(we.VIDEO_METADATA_CHANGE,"video"):(this.emit(we.METADATA_PARSED,"video"),this._hasVideoSequence=!0))}},{key:"handleSeiParsed",value:function(e){this.emit(we.SEI_PARSED,e)}},{key:"handleVideoSampleParsed",value:function(e){this._cfg.onlyAudio||this.tracks&&this.tracks.videoTrack&&(e.isKeyframe&&this.emit(we.ISKEYFRAME,e.dts+e.cts,e.cts),this.tracks.videoTrack.samples.push(e))}},{key:"handleAudioSampleParsed",value:function(e){var t;this._cfg.onlyVideo||this.tracks&&this.tracks.audioTrack&&null!==(t=this.tracks.audioTrack)&&void 0!==t&&t.meta.channelCount&&this.tracks.audioTrack.samples.push(e)}},{key:"handleScriptTagParsed",value:function(e){if(e){this._onMetaData=e;var t=this.tracks,i=t.videoTrack,r=t.audioTrack;if(this._context.mediaInfo.duration=e.duration,"boolean"==typeof e.hasAudio&&(this._context.mediaInfo.hsaAudio=!this._cfg.onlyVideo&&e.hasAudio),"boolean"==typeof e.hasVideo&&(this._context.mediaInfo.hasVideo=!this._cfg.onlyAudio&&e.hasVideo),this.emit(we.MEDIA_INFO),this._hasScript=!0,r&&!r.hasSpecificConfig){var n=r.meta;switch(e.audiosamplerate&&(n.sampleRate=e.audiosamplerate),e.audiochannels&&(n.channelCount=e.audiochannels),e.audiosamplerate){case 44100:n.sampleRateIndex=4;break;case 22050:n.sampleRateIndex=7;break;case 11025:n.sampleRateIndex=10}}if(i&&!i.hasSpecificConfig){var a=i.meta;if("number"==typeof e.framerate){var s=Math.floor(1e3*e.framerate);if(s>0){var o=s/1e3;a.frameRate||(a.frameRate={}),a.frameRate.fixed=!0,a.frameRate.fps=o,a.frameRate.fps_num=s,a.frameRate.fps_den=1e3}}}}}},{key:"handleFileHeaderParsed",value:function(e){var t=e.hasVideo,i=e.hasAudio;this._context.mediaInfo.hasVideo=!this._cfg.onlyAudio&&t,this._context.mediaInfo.hasAudio=!this._cfg.onlyVideo&&i,this.initVideoTrack(),this.initAudioTrack()}},{key:"handlePraseError",value:function(e){this.emit(we.DEMUX_ERROR,this.TAG,e)}},{key:"demux",value:function(){if(this.loaderBuffer){try{this.demuxer.demux(this.loaderBuffer)}catch(e){return void this.emit(we.DEMUX_ERROR,this.TAG,e)}this.emit(we.DEMUX_COMPLETE)}}},{key:"initVideoTrack",value:function(){this._trackNum++;var e=new Te.Dc;e.meta=new u,e.id=e.meta.id=this._trackNum,this.tracks.videoTrack=e}},{key:"initAudioTrack",value:function(){this._trackNum++;var e=new Te.IT;e.meta=new o,e.id=e.meta.id=this._trackNum,this.tracks.audioTrack=e}},{key:"loaderBuffer",get:function(){var e=this._context.getInstance("LOADER_BUFFER");if(e)return e;this.emit(we.DEMUX_ERROR,this.TAG,new Error("no found loaderBuffer"))}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"logger",get:function(){return this._context.getInstance("LOGGER")}},{key:"destroy",value:function(){this.demuxer&&this.demuxer.destroy()}}])&&Se(t.prototype,i),r&&Se(t,r),e}();const Le=Re},31146:(e,t,i)=>{i.r(t),i.d(t,{HlsLiveMobilePlayer:()=>xi,HlsLiveMsePlayer:()=>yi,default:()=>Pi});var r=i(36478),n=i(67083),a={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},s={SEEK:"SEEK"},o={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY",LOADER_TTFB:"LOADER_TTFB"},u={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO",ISKEYFRAME:"ISKEYFRAME"},l={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},c={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR",MSE_WRONG_TRACK_ADD:"MSE_WRONG_TRACK_ADD",MSE_CHANGE_CODEC_ERROR:"MSE_CHANGE_CODEC_ERROR"},h={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},d=Object.assign({},o,u,l,c,h,s,a),f=[],p=[];for(var y in d)d.hasOwnProperty(y)&&f.push(d[y]);for(var v in d)d.hasOwnProperty(v)&&p.push(d[v]);const _={ALLEVENTS:d,HLS_EVENTS:h,REMUX_EVENTS:l,DEMUX_EVENTS:u,MSE_EVENTS:c,LOADER_EVENTS:o,FlvAllowedEvents:f,HlsAllowedEvents:p,CRYPTO_EVENTS:{START_DECRYPTOO:"START_DECRYPTO",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:s,BROWSER_EVENTS:a};function g(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var m=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},E=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.mimeType=null,this.duration=null,this.hasVideo=!1,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=!1,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}var t,i,r;return t=e,r=[{key:"isBaseInfoReady",value:function(e){return m(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||m(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||m(e.video)}}],(i=[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}])&&g(t.prototype,i),r&&g(t,r),e}(),b=i(42990),k=i.n(b);function A(e){return A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},A(e)}function T(e,t,i){return T="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=w(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}},T(e,t,i||e)}function S(e,t){return S=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},S(e,t)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function L(e,t,i){return t&&R(e.prototype,t),i&&R(e,i),e}var B="__TO__",O=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];D(this,e),this._emitter=new(k()),this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new E,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=r,this._configs=i,this._player=t,this._hooks={}}return L(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],a=i[1],s=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error("".concat(e,"未在context中注册"))}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),a=this,s=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&S(e,t)}(u,t);var i,s,o=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=w(i);if(s){var r=w(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==A(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function u(t,i,r){var n;return D(this,u),(n=o.call(this,t,i,r)).listeners={},n.onceListeners={},n.TAG=e,n._context=a,n}return L(u,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on("".concat(t).concat(B).concat(e),i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once("".concat(t).concat(B).concat(e),i),r.once(t,i)}},{key:"emit",value:function(e){n(e);for(var t=a._hooks?a._hooks[e]:null,i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];if(t)for(var u=0,l=t.length;u<l;u++)t[u].apply(void 0,s);return r.emit.apply(r,[e].concat(s))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return r.emit.apply(r,["".concat(t).concat(B).concat(e)].concat(a))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],a=0;a<n.length;a++){var s=n[a];r.off(i,s),r.off("".concat(i).concat(B).concat(e),s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var c=u[l];r.off(o,c),r.off("".concat(o).concat(B).concat(e),c)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],T(w(u.prototype),"destroy",this))return T(w(u.prototype),"destroy",this).call(this);this._context=null}},{key:"_player",get:function(){return this._context?this._context._player:null},set:function(e){this._context&&(this._context._player=e)}},{key:"_pluginConfig",get:function(){return this._context?this._context._configs:null}}]),u}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"seek",value:function(e){this._emitter.emit(_.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this.destroyInstances(),this._emitter&&this._emitter.removeAllListeners(),this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._hooks=null,this._player=null,this._configs=null}},{key:"_isMessageNameValid",value:function(e){if(this.allowedEvents&&this.allowedEvents.length&&!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: ".concat(e))}}]),e}();const C=O;function U(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function x(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const P=new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{var i=/xgd=(\d)/.exec(document.cookie);this._status=!!i,this._level=i&&i[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error","trace"].forEach(function(e){t[e]=function(i,r,n,a,s,o,u,l,c,h){var d,f;if(t._status){var p=i,y=[r,n,a,s,o,u,l,c,h].filter(function(e){return void 0!==e});(d=console)[e].apply(d,["["+p+"]:"].concat(function(e){if(Array.isArray(e))return U(e)}(f=y)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(f)||function(e,t){if(e){if("string"==typeof e)return U(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?U(e,t):void 0}}(f)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))}}})}var t,i;return t=e,(i=[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}])&&x(t.prototype,i),e}());function I(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var M=_.MSE_EVENTS,G=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.TAG="MSE",this.configs=Object.assign({},t),this.container=this.configs.container,this.format=this.configs.format,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1,this.videoCodec=""}var t,i,r;return t=e,i=[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(t,i){if(this._context=t,this.emit=t._emitter.emit.bind(t._emitter),!i)for(var r=0;r<Object.keys(this.sourceBuffers).length;r++){var n=this.sourceBuffers[Object.keys(this.sourceBuffers)[r]];n.updating||e.clearBuffer(n)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(M.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e,t=this._context.getInstance("PRE_SOURCE_BUFFER"),i=this._context.getInstance("TRACKS");if(t&&i){t=t.sources;for(var r=!1,n=0,a=Object.keys(t).length;n<a;n++){var s=Object.keys(t)[n];r=!1,"audio"===s?e=i.audioTrack:"video"===s&&(e=i.videoTrack),e&&null!==t[s].init&&t[s].data.length&&(r=!0)}if(r){if(Object.keys(this.sourceBuffers).length>1)return;for(var o=0,u=Object.keys(t).length;o<u;o++){var l=Object.keys(t)[o];if(!this.sourceBuffers[l]){var c=t[l],h="video"===l?"video/mp4;codecs="+c.mimetype:"audio/mp4;codecs="+c.mimetype;try{P.log(this.TAG,"add sourcebuffer",h);var d=this.mediaSource.addSourceBuffer(h);this.sourceBuffers[l]=d,d.addEventListener("updateend",this.onUpdateEnd),"video"===l&&(this.videoCodec=c.mimetype)}catch(e){if(22===e.code&&Object.keys(this.sourceBuffers).length>0)return this.emit(M.MSE_WRONG_TRACK_ADD,l);this.emit(M.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){if(this.mediaSource&&"closed"!==this.mediaSource.readyState){try{this._doCleanupSourceBuffer()}catch(e){}var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e&&!(Object.keys(this.sourceBuffers).length<this.sourceBufferLen))for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i];if(!r.updating){var n=e.sources[i];if(this["no".concat(i)])n.data=[],n.init.buffer=null;else if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var a=n.data.shift();if(a)try{r.appendBuffer(a.buffer.buffer)}catch(e){n.data.unshift(a)}}}}}}},{key:"changeVideoCodecType",value:function(e){var t=this.sourceBuffers.video;if(null!=t&&t.updating)throw new Error("source buffer in updating");t.changeType("video/mp4;codecs=".concat(e)),this.videoCodec=e}},{key:"endOfStream",value:function(){try{var e;"open"===this.mediaSource.readyState&&null!==(e=this.container)&&void 0!==e&&e.readyState&&this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||e>t&&r.remove(t,e)}}catch(e){}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var r=Object.keys(this.sourceBuffers)[i],n=this.sourceBuffers[r],a=n.buffered,s=!1,o=0;o<a.length;o++){var u=a.start(o),l=a.end(o);if(u<=e&&e<l+3){if(e-u>=180){s=!0;var c=e-180;t[r].push({start:u,end:c})}}else l<e&&e-u>=180&&(s=!0,t[r].push({start:u,end:l}))}s&&!n.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],r=e[t];r.length&&!i.updating;){var n=r.shift();try{n&&n.end>n.start&&i.remove(n.start,n.end)}catch(e){}}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],r=function(r){var n,a=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n=a.updating?new Promise(function(t){a.addEventListener("updateend",function i(){var r=3;setTimeout(function i(){a.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(a),a.addEventListener("updateend",function(){t()}))},200),a.removeEventListener("updateend",i)})}):new Promise(function(t){a.buffered.length?(e.clearBuffer(a),a.addEventListener("updateend",function(){t()})):t()}).catch(function(){}),i.push(n)},n=0;n<Object.keys(this.sourceBuffers).length;n++)r(n);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var a;a=n.updating?new Promise(function(t){n.addEventListener("updateend",function i(){var r=3;setTimeout(function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",function(){t()}))},200),n.removeEventListener("updateend",i)})}):new Promise(function(t){n.buffered.length?(e.clearBuffer(n),n.addEventListener("updateend",function(){t()})):t()}).catch(function(){}),i.push(a)},n=0;n<Object.keys(this.sourceBuffers).length;n++)r(n);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then(function(){for(var t=Object.keys(e.sourceBuffers),i=0;i<t.length;i++){var r=e.sourceBuffers[t[i]];delete e.sourceBuffers[t[i]],"open"===e.mediaSource.readyState&&e.mediaSource.removeSourceBuffer(r)}e.endOfStream();try{window.URL.revokeObjectURL(e.url)}catch(e){}e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1,e.onSourceOpen=null,e.onTimeUpdate=null,e.onUpdateEnd=null,e.onWaiting=null,e.noaudio=void 0,e.novideo=void 0})):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",get:function(){if(!this._url)try{this._url=window.URL.createObjectURL(this.mediaSource)}catch(e){}return this._url},set:function(e){this._url=e}}],r=[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);e.remove(0,i)}catch(e){}}}],i&&I(t.prototype,i),r&&I(t,r),e}();const F=G;function V(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function N(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var j=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),N(this,"_sampleQueue",[]),N(this,"_speed",0),N(this,"_recentSpeed",0),N(this,"_timer",0),N(this,"_dit",0),N(this,"_contentLength",0),N(this,"_totalByteSize",0),N(this,"_speedDown",!1)}var t,i;return t=e,(i=[{key:"recordLoading",value:function(e){var t=e.get("content-length")||0,i=e.get("Accept-Ranges"),r=e.get("Content-Range");if(t&&!i&&!r){this._contentLength=t;var n=Math.floor(t/this._speed*1e3);n<50||(this._dit=performance.now(),this._startTick(t,n))}}},{key:"recordLoaded",value:function(){this._cleanTimer();var e=performance.now()-this._dit;this._addSample(Math.floor(this._contentLength/e))}},{key:"recordChunk",value:function(e){if(!this._timer)return this._dit=performance.now(),void this._startTickForStream();this._totalByteSize+=e,this._contentLength+=e}},{key:"_startTick",value:function(e,t){var i=this;this._cleanTimer(),this._timer=setInterval(function(){var t=performance.now()-i._dit;i._addSample(Math.floor(e/t))},t)}},{key:"_startTickForStream",value:function(){var e=this;this._timer=setInterval(function(){e._addSample(e._calcSampleSpeed())},1e3)}},{key:"_calcSampleSpeed",value:function(){var e=performance.now()-this._dit,t=Math.floor(this._contentLength/e);return this._contentLength=0,this._dit=performance.now(),t}},{key:"_addSample",value:function(e){this._recentSpeed=1e3*e,this._sampleQueue.length>3&&(this._sampleQueue=[]),this._sampleQueue.push(e),this._calcAvgSpeed(this._sampleQueue)}},{key:"_calcAvgSpeed",value:function(e){var t=e.length,i=e.reduce(function(e,t){return e+t},0)/t;this._speed=1e3*Math.floor(i)}},{key:"_cleanTimer",value:function(){clearTimeout(this._timer),this._timer=0}},{key:"clean",value:function(){this._cleanTimer()}},{key:"destroy",value:function(){clearTimeout(this._timer)}},{key:"totalByteSize",get:function(){return this._totalByteSize}},{key:"avgSpeed",get:function(){return this._speed||this._addSample(this._calcSampleSpeed()),8*this._speed}},{key:"recentSpeed",get:function(){return this._recentSpeed||this._addSample(this._calcSampleSpeed()),8*this._recentSpeed}}])&&V(t.prototype,i),e}();function H(e){return H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},H(e)}function z(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var W=_.LOADER_EVENTS,X=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0,this._ttfbInfo=null,this._responseHeader=null,this._speed=new j,window.AbortController&&(this.abortControllerEnabled=!0)}var t,i,r;return t=e,i=[{key:"init",value:function(){this.on(W.LADER_START,this.load.bind(this))}},{key:"fetch",value:function(e){function t(t,i,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,i){var r=this,n=null;this.abortControllerEnabled&&(this.abortController=new window.AbortController),Object.assign(t,{signal:this.abortController?this.abortController.signal:void 0});var a=(new Date).getTime();return Promise.race([fetch(e,t),new Promise(function(e,t){n=setTimeout(function(){t({code:999,message:"fetch timeout"}),r.abortController&&r.abortController.abort()},i||1e4)})]).then(function(t){var i;n&&(clearTimeout(n),n=null),null===(i=r._speed)||void 0===i||i.recordLoading(t.headers);var s=(new Date).getTime();return r._ttfbInfo={url:e,responseUrl:t.url,start:a,end:s,elapsed:s-a,ok:t.ok},r.emit(W.LOADER_TTFB,r._ttfbInfo),t})})},{key:"internalLoad",value:function(e,t,i,r){var n=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;if(!this._destroyed)return this.loading=!0,this.fetch(this.url,t,s).then(function(u){if(!n._destroyed&&n.emit(W.LOADER_RESPONSE_HEADERS,n.TAG,u.headers),n._responseHeader=u.headers,u.ok)return n.status=u.status,Promise.resolve().then(function(){n._onFetchResponse(u,o)}),Promise.resolve(u);i-- >0?n._retryTimer=setTimeout(function(){return n.emit(W.LOADER_RETRY,n.TAG,{response:u,reason:"response not ok",retryTime:r-i}),n.internalLoad(e,t,i,r,a,s,o)},a):(n.loading=!1,n.emit(W.LOADER_ERROR,n.TAG,{code:u.status||21,message:"".concat(u.status," (").concat(u.statusText,")")}))}).catch(function(u){if(n._destroyed||u&&"AbortError"===u.name)n.loading=!1;else if(i-- >0)n._retryTimer=setTimeout(function(){return n.emit(W.LOADER_RETRY,n.TAG,{error:u,reason:"fetch error",retryTime:r-i}),n.internalLoad(e,t,i,r,a,s,o)},a);else{if(n.loading=!1,u&&"AbortError"===u.name)return;n.emit(W.LOADER_ERROR,n.TAG,Object.assign({code:21},u))}})}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=i.retryCount,n=i.retryDelay,a=i.loadTimeout,s=i.maxReaderInterval;if(e){r=void 0===r?3:r,this.url=e,this._canceled=!1;var o=this.getParams(t);return this.internalLoad(e,o,r,r,n,a,s)}this.emit(W.LOADER_ERROR,this.TAG,{code:0,message:"empty url"})}},{key:"_onFetchResponse",value:function(e,t){var i=this,r=this,n=this._context.getInstance(this.buffer);this._loaderTaskNo++;var a=this._loaderTaskNo;if(!0===e.ok){var s;switch(this.readtype){case 2:s=e.json();break;case 1:s=e.text();break;case 3:s=e.arrayBuffer();break;default:return this._onReader(e.body.getReader(),a,t)}if(!s)return;s.then(function(e){var t;null===(t=i._speed)||void 0===t||t.recordLoaded(),r.loading=!1,r._canceled||r._destroyed||(n?(n.push(e instanceof ArrayBuffer?new Uint8Array(e):e),r.emit(W.LOADER_COMPLETE,n)):r.emit(W.LOADER_COMPLETE,e))}).catch(function(){})}}},{key:"_onReader",value:function(e,t,i){var r=this,n=this._context.getInstance(this.buffer);if(!n&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&(this._noDataTimer=setTimeout(function(){!1!==r.loading&&r.emit(W.LOADER_COMPLETE,"nobuffer")},i||3e3),this._reader&&this._reader.read().then(function(a){var s,o;if(clearTimeout(r._noDataTimer),!r._canceled&&!r._destroyed)return a.done?(r.loading=!1,r.status=0,null===(o=r._speed)||void 0===o||o.destroy(),void Promise.resolve().then(function(){r.emit(W.LOADER_COMPLETE,"done")})):(n.push(a.value),null===(s=r._speed)||void 0===s||s.recordChunk(a.value.byteLength),Promise.resolve().then(function(){r.emit(W.LOADER_DATALOADED,n)}),r._onReader(e,t,i));if(r._reader)try{r._reader.cancel()}catch(e){}}).catch(function(e){clearTimeout(r._noDataTimer),r.loading=!1,(!e||"AbortError"!==e.name&&"network error"!==e.message)&&r.emit(W.LOADER_ERROR,r.TAG,e)}))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,r={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===H(this.configs.headers)){var n=this.configs.headers;for(var a in n)n.hasOwnProperty(a)&&i.append(a,n[a])}if("object"===H(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&i.append(o,s[o])}return!1===t.cors&&(r.mode="same-origin"),t.withCredentials&&(r.credentials="include"),r}},{key:"ttfbInfo",get:function(){return this._ttfbInfo}},{key:"avgSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.avgSpeed)||0}},{key:"recentSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.recentSpeed)||0}},{key:"currentSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.avgSpeed)/8e3}},{key:"totalByteSize",get:function(){var e;return null===(e=this._speed)||void 0===e?void 0:e.totalByteSize}},{key:"responseHeader",get:function(){return this._responseHeader}},{key:"cancel",value:function(){var e;if(this._reader){try{var t=this._reader.cancel();t.catch&&t.catch(function(e){})}catch(e){}this._reader=null,this.loading=!1}clearTimeout(this._noDataTimer),this._canceled=!0,this.abortController&&this.abortController.abort(),null===(e=this._speed)||void 0===e||e.clean()}},{key:"destroy",value:function(){var e;this._destroyed=!0,this._responseHeader=null,clearTimeout(this._retryTimer),clearTimeout(this._noDataTimer),this.cancel(),null===(e=this._speed)||void 0===e||e.destroy(),this._speed=null}}],r=[{key:"isSupported",value:function(){return!!window.fetch}},{key:"type",get:function(){return"loader"}}],i&&z(t.prototype,i),r&&z(t,r),e}();const Y=X;function K(e){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(e)}function q(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Q=_.LOADER_EVENTS,Z=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._xhr=null,this.configs=Object.assign({},t),this.loading=!1,this._readtype=this.configs.readtype,this._bufferType=this.configs.buffer||"LOADER_BUFFER",this._requestInfo=null,this._onReadyStateChange=this._onReadyStateChange.bind(this),this._onError=this._onError.bind(this),this._onAbort=this._onAbort.bind(this),this._onTimeout=this._onTimeout.bind(this)}var t,i,r;return t=e,i=[{key:"bufferIns",get:function(){return this._context.getInstance(this._bufferType)}},{key:"init",value:function(){this.on(Q.LADER_START,this.load.bind(this))}},{key:"_createXhr",value:function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=Object.assign({},t);this._requestInfo={url:e,options:n,retryTimes:i,totalRetry:i,delayTime:r},this._xhr=this._createXhr(),this.loading=!0;try{this._bindEvents(),this._loadInternal(e,n)}catch(e){this._whenError({code:this._xhr.status,message:e&&e.message})}}},{key:"_loadInternal",value:function(e,t){var i=this._xhr;i.open("GET",e,!0),this._setTimeout(i,t),this._setCredentails(i,t),this._setHeaders(i,t),this._setResponseType(i),i.send()}},{key:"_bindEvents",value:function(){var e=this._xhr;e.addEventListener("readystatechange",this._onReadyStateChange),e.addEventListener("timeout",this._onTimeout),e.addEventListener("error",this._onError),e.addEventListener("abort",this._onAbort)}},{key:"_setTimeout",value:function(e,t){e.timeout=t.timeout||2e3}},{key:"_setCredentails",value:function(e,t){t.withCredentials&&(e.withCredentials=!0)}},{key:"_setHeaders",value:function(e,t){if("object"===K(t.headers)){var i=t.headers;for(var r in i)i.hasOwnProperty(r)&&e.setRequestHeader(r,i[r])}}},{key:"_setResponseType",value:function(e){switch(this._readtype){case 3:e.responseType="arraybuffer";break;case 2:e.responseType="json";break;default:e.responseType=""}}},{key:"_onReadyStateChange",value:function(){var e=this._xhr,t=e.readyState,i=e.status;if(4===t){if(i>=200&&i<300)return void this._onComplete(this._xhr);if(0===i)return;this._onError()}}},{key:"_onComplete",value:function(e){var t;switch(this._readtype){case 2:try{t=JSON.parse(e.responseText)}catch(e){}break;case 3:var i=e.response;t=new Uint8Array(i);break;default:t=e.responseText}this.bufferIns?(this.bufferIns.push(t),this.emit(Q.LOADER_COMPLETE,this.bufferIns)):this.emit(Q.LOADER_COMPLETE,t),this.loading=!1}},{key:"_onError",value:function(){var e=this._xhr,t={code:e.status||21,message:e.statusText};this._whenError(t)}},{key:"_onTimeout",value:function(){console.warn("timeout"),this._whenError({code:999,message:"fetch timeout"})}},{key:"_onAbort",value:function(){console.warn("abort")}},{key:"_whenError",value:function(e){var t=this,i=this._requestInfo,r=i.url,n=i.options,a=i.totalRetry,s=i.retryTimes,o=i.delayTime;if(!s)return this.loading=!1,void this.emit(Q.LOADER_ERROR,this.TAG,e);s--,setTimeout(function(){t.emit(Q.LOADER_RETRY,t.TAG,{response:e,reason:"response not ok",retryTime:a-s}),t.load(r,n,s,o)},o)}},{key:"cancel",value:function(){4!==this._xhr.readyState&&this._xhr.abort()}},{key:"destroy",value:function(){this.cancel(),this._xhr&&(this._xhr.removeEventListener("readystatechange",this._onReadyStateChange),this._xhr.removeEventListener("timeout",this._onTimeout),this._xhr.removeEventListener("error",this._onError),this._xhr.removeEventListener("abort",this._onAbort),this._xhr=null)}}],r=[{key:"type",get:function(){return"loader"}}],i&&q(t.prototype,i),r&&q(t,r),e}();const $=Z;function J(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ee=_.CRYPTO_EVENTS,te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}var t,i;return t=e,i=[{key:"init",value:function(){this.on(ee.START_DECRYPTO,this.decrypto.bind(this))}},{key:"decrypto",value:function(){var e=this;this.aeskey?this.decryptoData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(t){e.aeskey=t,e.decryptoData()})}},{key:"decryptoData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=t.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then(function(t){i.push(new Uint8Array(t)),e.emit(ee.DECRYPTED),e.decryptoData(r)})}}],i&&J(t.prototype,i),e}();const ie=te;var re=i(23722),ne=i.n(re);function ae(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var se=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.buffer=t||new Uint8Array(0)}var t,i,r;return t=e,i=[{key:"write",value:function(){for(var e=this,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(function(t){e.buffer=ne()(Uint8Array,e.buffer,t)})}}],r=[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach(function(e){t+=e.toString(16).padStart(2,"0")}),parseInt(t,16)}}],i&&ae(t.prototype,i),r&&ae(t,r),e}();const oe=se;function ue(e){return function(e){if(Array.isArray(e))return le(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return le(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?le(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function le(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function ce(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var he=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"size",value:function(e){return oe.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var r=new oe,n=arguments.length,a=new Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return r.write.apply(r,[e.size(t),e.type(i)].concat(a)),r.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var i,r=t.type,n=t.meta,a=8,s=e.mvhd(n.duration,n.timescale);i="video"===r?e.videoTrak(n):e.audioTrak(n);var o=e.mvex(n.duration,n.timescale||1e3,n.id);return[s,i,o].forEach(function(e){a+=e.byteLength}),e.initBox(a,"moov",s,i,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+r.length,"mvhd",new Uint8Array(r))}},{key:"videoTrak",value:function(t){var i=8,r=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),n=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,vvcC:t.vvcC,hvcCConfigParsed:t.hvcCConfigParsed,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"audioTrak",value:function(t){var i=8,r=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),n=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration,n=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new oe,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,r=e.mdhd(t.timescale,t.duration),n=e.hdlr(t.type),a=e.minf(t);return[r,n,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"mdia",r,n,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments.length>1?arguments[1]:void 0,r=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+r.byteLength,"mdhd",e.extension(0,0),r)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,r="video"===t.type?e.vmhd():e.smhd(),n=e.dinf(),a=e.stbl(t);return[r,n,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"minf",r,n,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new oe;return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),t.buffer}},{key:"stbl",value:function(t){var i=8,r=e.stsd(t),n=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[r,n,a,s,o].forEach(function(e){i+=e.byteLength}),e.initBox(i,"stbl",r,n,a,s,o)}},{key:"stsd",value:function(t){var i;return i="audio"===t.type?e.mp4a(t):36===t.streamType||t.vvcC?e.hvc1vvc1(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),r=e.esds(t.config);return e.initBox(8+i.byteLength+r.byteLength,"mp4a",i,r)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new oe,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new oe,r=t.width,n=t.height,a=t.parRatio.width,s=t.parRatio.height,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>8&255,255&r,n>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),c=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),c),i.buffer}},{key:"hvc1vvc1",value:function(t){var i=new oe,r=[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17],n=!!t.vvcC,a=n?e.vvcC(t):e.hvcC(t),s=[e.type(n?"vvc1":"hvc1"),new Uint8Array(r)].concat(ue(a));t.parRatio&&s.push.apply(s,ue(e.pasp(t.parRatio)));var o=4+s.reduce(function(e,t){return e+t.byteLength},0);return s.unshift(e.size(o)),i.write.apply(i,ue(s)),i.buffer}},{key:"hvcC",value:function(t){var i;if(t.hvcCConfigParsed){var r=t.hvcCConfigParsed,n=r.vpsArr,a=r.spsArr,s=r.ppsArr,o=r.hvcC,u=o.generalProfileCompatibilityFlags,l=o.generalConstraintIndicatorFlags,c=(n.length&&1)+(a.length&&1)+(s.length&&1);i=[1,o.generalProfileSpace<<6|o.generalTierFlag<<5|o.generalProfileIdc,u>>>24,u>>>16,u>>>8,u,l[0],l[1],l[2],l[3],l[4],l[5],o.generalLevelIdc,240,0,252,252|o.chromaFormatIdc,248|o.bitDepthLumaMinus8,248|o.bitDepthChromaMinus8,0,0,o.numTemporalLayers<<3|o.temporalIdNested<<2|3,c];var h=function(e){var t;i.push(e.length>>8,e.length),(t=i).push.apply(t,ue(e))};n.length&&(i.push(160,0,n.length),n.forEach(h)),a.length&&(i.push(161,0,a.length),a.forEach(h)),s.length&&(i.push(162,0,s.length),s.forEach(h))}else i=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return[e.size(8+i.length),e.type("hvcC"),new Uint8Array(i)]}},{key:"vvcC",value:function(t){var i=t.vvcC;return[e.size(8+i.byteLength),e.type("vvcC"),i]}},{key:"fiel",value:function(){return[e.size(10),e.type("fiel"),new Uint8Array([1,0])]}},{key:"pasp",value:function(t){if(t.width&&t.height){var i=t.width,r=t.height;return[e.size(16),e.type("pasp"),new Uint8Array([i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r])]}return[]}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments.length>2?arguments[2]:void 0,r=new oe,n=oe.writeUint32(t);return r.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(i)),r.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,r=e.mfhd(),n=e.traf(t);return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"moof",r,n)}},{key:"mfhd",value:function(){var t=oe.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,r=e.tfhd(t.id),n=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[r,n,s,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"traf",r,n,s,a)}},{key:"tfhd",value:function(t){var i=oe.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),oe.writeUint32(t))}},{key:"trun",value:function(t,i){var r=new oe,n=oe.writeUint32(t.samples.length),a=oe.writeUint32(92+16*t.samples.length+i);return r.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),n,a),t.samples.forEach(function(e){var t=e.flags;r.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),r.buffer}},{key:"sdtp",value:function(t){var i=new oe;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,r=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([r]))}),i.buffer}},{key:"mdat",value:function(t){var i=new oe,r=8;t.samples.forEach(function(e){r+=e.size}),i.write(e.size(r),e.type("mdat"));var n=new Uint8Array(r),a=0;return n.set(i.buffer,a),a+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){n.set(e,a),a+=e.byteLength})}),n}}],null&&ce(t.prototype,null),i&&ce(t,i),e}();he.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},he.sequence=1;const de=he;function fe(e){return fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fe(e)}function pe(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ye(e,t){return ye=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},ye(e,t)}function ve(e){return ve=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},ve(e)}var _e=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ye(e,t)}(o,e);var t,i,r,n,a,s=(n=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=ve(n);if(a){var i=ve(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==fe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function o(e){var t,i=e.videoMeta,r=e.audioMeta,n=e.curTime;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=s.call(this)).TAG="Fmp4Remuxer",t._dtsBase=1e3*n,t._videoMeta=i,t._audioMeta=r,t._audioDtsBase=null,t._videoDtsBase=null,t._isDtsBaseInited=!1,t.isFirstVideo=!0,t.isFirstAudio=!0,t.videoAllDuration=0,t.audioAllDuration=0,t.audioRemuxed=0,t.videoRemuxed=0,t.mp4Durations={keys:[]};var a=/Chrome\/([^.]+)/.exec(navigator.userAgent);return t.forceFirstIDR=a&&Number(a[1])<50,t}return t=o,i=[{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1,this.mp4Durations={keys:[]},this.removeAllListeners()}},{key:"remux",value:function(e,t){!this._isDtsBaseInited&&this.calcDtsBase(e,t),this.remuxVideo(t),this.remuxAudio(e),P.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){P.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"remuxInitSegment",value:function(e,t){P.log(this.TAG,"remuxInitSegment: type=",e,t);var i=new oe,r=36===t.streamType?de.ftypHEVC():de.ftyp(),n=de.moov({type:e,meta:t});return i.write(r,n),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i,r=t.samples[0];return r.options&&r.options.start&&(i=r.options.start),this._videoDtsBase=r.dts-(i||this._dtsBase),void(this._isDtsBaseInited=!0)}if(e&&e.samples.length||t&&t.samples.length){var n=null,a=null,s=null;if(e&&e.samples&&e.samples.length){var o=e.samples[0];n=o.dts,o.options&&o.options.start&&(s=o.options.start)}if(t&&t.samples&&t.samples.length){var u=t.samples[0];a=u.dts,u.options&&u.options.start&&(s=u.options.start)}var l=n-a;l<0&&null!==s&&t.samples.forEach(function(e){e.dts-=l,e.pts&&(e.pts-=l)}),this._videoDtsBase=(a||n)-(s||this._dtsBase),this._audioDtsBase=(n||a)-(s||this._dtsBase),this._dtsBase=Math.min(a,n),this._isDtsBaseInited=!0,P.log(this.TAG,"calcDtsBase"),P.log(this.TAG,"video first dts: ".concat(a," , start:").concat(s," , _videoDtsBase:").concat(this._videoDtsBase," , _dtsBase:").concat(this._dtsBase)),P.log(this.TAG,"audio first dts: ".concat(n," , start:").concat(s," , _audioDtsBase:").concat(this._audioDtsBase,", _dtsBase:").concat(this._dtsBase))}}},{key:"remuxVideo",value:function(e){var t=this,i=e||{};if(e&&e.samples&&e.samples.length){var r=i.samples;if(i.meta){for(var n=-1,a=null,s=[],u={samples:[]},l=1e4,c=!0;r.length&&l-- >0;){var h=r.shift(),d=h.isKeyframe,f=h.options;if(!this.isFirstVideo&&f&&f.meta){a=this.remuxInitSegment("video",f.meta),f.meta=null,r.unshift(h),f.isContinue||(this._videoDtsBase=0);break}var p=Math.max(0,h.dts-this.videoDtsBase);-1===n&&(n=p);var y=void 0,v=void 0;void 0!==h.pts&&(y=(v=h.pts-this._dtsBase)-p),void 0!==h.cts&&(v=h.cts+p,y=h.cts);var _,g={buffer:[],size:0};_=h.duration?h.duration:r.length>=1?r[0].dts-this.videoDtsBase-p:s.length>=1?s[s.length-1].duration:this._videoMeta.refSampleDuration,this.videoAllDuration+=_,P.long&&P.log(this.TAG,"video dts ".concat(p),"pts ".concat(v),"cts: ".concat(y),d,"originDts ".concat(h.originDts),"duration ".concat(_),c),_>=0&&(u.samples.push(g),g.buffer.push(h.data),g.size+=h.data.byteLength,s.push({dts:p,cts:y,pts:v,data:h.data,size:h.data.byteLength,isKeyframe:d,duration:_,flags:{isLeading:0,dependsOn:d||this.forceFirstIDR&&c?2:1,isDependedOn:d?1:0,hasRedundancy:0,isNonSync:d||this.forceFirstIDR&&c?0:1},originDts:p,type:"video"}),c=!1,this.mp4Durations[v]=_,this.mp4Durations.keys.push(v)),d&&this.emit(o.EVENTS.RANDOM_ACCESS_POINT,v)}if(this.mp4Durations.keys.length>1e4){var m=this.mp4Durations;this.mp4Durations={},this.mp4Durations.keys=m.keys.slice(-100),this.mp4Durations.keys.forEach(function(e){t.mp4Durations[e]=m[e]})}s.length&&P.log(this.TAG,"remux to mp4 video:",[n/1e3,s[s.length-1].dts/1e3]);var E=new oe;if(s.length&&i.meta){var b=de.moof({id:i.meta.id,time:n,samples:s}),k=de.mdat(u);E.write(b,k),this.segmentRemuxed("video",E,s[s.length-1].pts-s[0].pts)}if(a&&(this.segmentRemuxed("video",a),r.length))return i.samples=r,this.remuxVideo(i);this.isFirstVideo=!1,this.emit(o.EVENTS.TRACK_REMUXED,"video",E),i.samples=[],i.length=0}}}},{key:"remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],n=null,a={samples:[]};if(t&&t.length){for(var s=1e4,u=!1;t.length&&s-- >0;){var l=t.shift(),c=l.data,h=l.options;if(!this.isFirstAudio&&h&&h.meta){n=this.remuxInitSegment("audio",h.meta),h.meta=null,t.unshift(l),h.isContinue||(this._audioDtsBase=0);break}var d=Math.max(0,l.dts-this.audioDtsBase),f=l.originDts;u||(i=d,u=!0);var p;p=l.duration?l.duration:this._audioMeta.refSampleDurationFixed?this._audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this.audioDtsBase-d:r.length>=1?r[r.length-1].duration:this._audioMeta.refSampleDuration,P.long&&P.log(this.TAG,"audio dts ".concat(d),"pts ".concat(d),"originDts ".concat(f),"duration ".concat(p)),this.audioAllDuration+=p;var y={dts:d,pts:d,cts:0,size:c.byteLength,duration:l.duration?l.duration:p,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:f,type:"audio"},v={buffer:[],size:0};p>=0&&(v.buffer.push(c),v.size+=c.byteLength,a.samples.push(v),r.push(y))}var _=new oe;if(r.length&&e.meta){P.log(this.TAG,"remux to mp4 audio:",[i/1e3,r[r.length-1].dts/1e3]);var g=de.moof({id:e.meta.id,time:i,samples:r}),m=de.mdat(a);_.write(g,m),this.segmentRemuxed("audio",_,r[r.length-1].dts-r[0].dts)}if(n&&(this.segmentRemuxed("audio",n),t.length))return e.samples=t,this.remuxAudio(e);this.isFirstAudio=!1,this.emit(o.EVENTS.TRACK_REMUXED,"audio",_),e.samples=[],e.length=0}}},{key:"segmentRemuxed",value:function(e,t,i){this.emit(o.EVENTS.MEDIA_SEGMENT,e,t,i)}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase},set:function(e){this._videoDtsBase=e}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],r=[{key:"EVENTS",get:function(){return{MEDIA_SEGMENT:"MEDIA_SEGMENT",INIT_SEGMENT:"INIT_SEGMENT",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",TRACK_REMUXED:"TRACK_REMUXED"}}}],i&&pe(t.prototype,i),r&&pe(t,r),o}(k());function ge(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var me=_.REMUX_EVENTS,Ee=_.PLAYER_EVENTS,be=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Mp4Remuxer",this._curTime=t,this.remuxer||this.initRemuxer()}var t,i;return t=e,(i=[{key:"init",value:function(){this.on(me.REMUX_MEDIA,this.remux.bind(this)),this.on(me.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(me.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(me.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(Ee.SEEK,this.seek.bind(this))}},{key:"initRemuxer",value:function(){this.remuxer=new _e({audioMeta:null,videoMeta:null,curTime:this._curTime}),this.remuxer.on(_e.EVENTS.MEDIA_SEGMENT,this.writeToSource.bind(this)),this.remuxer.on(_e.EVENTS.TRACK_REMUXED,this.onTrackRemuxed.bind(this))}},{key:"remux",value:function(){if(this.remuxer)try{this.remuxer._videoMeta||(this.remuxer._videoMeta=this.videoMeta,this.remuxer._audioMeta=this.audioMeta);var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;this.remuxer.remux(t,i)}catch(e){this.emit(me.REMUX_ERROR,this.TAG,e)}}},{key:"resetDtsBase",value:function(){this.remuxer&&this.remuxer.resetDtsBase()}},{key:"seek",value:function(e){this.remuxer&&this.remuxer.seek(e)}},{key:"onMetaDataReady",value:function(e,t){var i;this.remuxer||this.initRemuxer(),i="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.mimetype=i.meta.codec,n.init=this.remuxer.remuxInitSegment(e,i.meta),t&&this.writeToSource(e,n.init,0),this.emit(me.INIT_SEGMENT,e)}},{key:"onTrackRemuxed",value:function(e){this.emit(me.MEDIA_SEGMENT,e)}},{key:"writeToSource",value:function(e,t,i){var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.data.push(t),i&&(n.bufferDuration=i+(n.bufferDuration||0))}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}},{key:"destroy",value:function(){this.remuxer&&this.remuxer.destroy(),this.remuxer=null}}])&&ge(t.prototype,i),e}();function ke(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ae=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var i=Object.assign({},e.getDefault(),t);this.id=i.id,this.url=i.url,this.start=i.start,this.duration=i.duration,this.discontinue=i.discontinue,this.cc=i.cc}var t,i;return t=e,i=[{key:"getDefault",value:function(){return{id:-1,url:"",start:-1,duration:-1,discontinue:!1,cc:-1}}}],null&&ke(t.prototype,null),i&&ke(t,i),e}();function Te(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const Se=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r={duration:0};if(!t||!t.includes("#EXTM3U"))throw new Error("Invalid m3u8 file");var n=t.split(/\r|\n/);n=n.filter(function(e){return e});var a=n.shift();if(!a.match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');a=n.shift();for(var s=!1,o=0;a;){var u=a.match(/#(.[A-Z|-]*):(.*)/),l=a.match(/#(.[A-Z|-]*)/);if(l&&u&&u.length>2)switch(u[1]){case"EXT-X-VERSION":r.version=parseInt(u[2]);break;case"EXT-X-MEDIA-SEQUENCE":r.sequence=parseInt(u[2]);break;case"EXT-X-TARGETDURATION":r.targetduration=parseFloat(u[2]);break;case"EXTINF":o=e.parseFrag(u,n,r,i,s,o),s=!1;break;case"EXT-X-KEY":e.parseDecrypt(u[2],r)}if(l&&l.length>1)switch(l[1]){case"EXT-X-DISCONTINUITY":s=!0;break;case"EXT-X-ENDLIST":r.frags[r.frags.length-1].isLast=!0,r.end=!0}a=n[o++]}return r}},{key:"parseFrag",value:function(t,i,r,n,a,s){r.frags||(r.frags=[]);var o=new Ae({start:r.duration,duration:parseInt(1e3*parseFloat(t[2]))});if(o.duration<200)return s;r.duration+=o.duration;var u=i[s++];if((u.match(/#(.*):(.*)/)||u.match(/^#/))&&(u=i[s++]),u.length>0&&"/"===u.charAt(0)&&n.match(/.*\/\/.*\.\w+/g)&&(n=n.match(/.*\/\/.*\.\w+/g)[0]),u.match(/.*:\/\/.*/)){var l=e.isHTTPS;!e.envisHttps&&!(e.envisHttps=l(window.location.href))||l(u)||(u=u.replace("http:","https:")),o.url=u}else o.url=n+u;if(o.discontinue=a,r.frags.length){var c=r.frags[r.frags.length-1];o.id=c.id+1,o.cc=a?c.cc+1:c.cc}else o.id=r.sequence||1,o.cc=0;return r.frags.push(o),s}},{key:"parseURL",value:function(e){var t="",i=e.match(/(.*\/).*\.m3u8/);if(i&&i.length>0)for(var r=0;r<i.length;r++)i[r].match(/.*\/$/g)&&i[r].length>t.length&&(t=i[r]);return t}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i=e.split(",");for(var r in i){var n=i[r];if(n.match(/METHOD=(.*)/)&&(t.encrypt.method=n.match(/METHOD=(.*)/)[1]),n.match(/URI="(.*)"/)&&(t.encrypt.uri=n.match(/URI="(.*)"/)[1]),n.match(/IV=0x(.*)/)){var a=n.match(/IV=0x(.*)/)[1],s=Math.ceil(a.length/2);t.encrypt.ivb=new Uint8Array(s);for(var o=s-1;o>=0;o--){var u=parseInt(a.substr(2*o,2),16);t.encrypt.ivb[o]=u}t.encrypt.iv=a}}}},{key:"isHTTPS",value:function(e){return/^https:\/\//i.test(e)}}],null&&Te(t.prototype,null),i&&Te(t,i),e}();function we(e){return we="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},we(e)}function De(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Re(e,t)}function Re(e,t){return Re=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Re(e,t)}function Le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var i,r=Be(e);if(t){var n=Be(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function(e,t){return!t||"object"!==we(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,i)}}function Be(e){return Be=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Be(e)}function Oe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ce(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ue(e,t,i){return t&&Ce(e.prototype,t),i&&Ce(e,i),e}var xe=function(){function e(){Oe(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return Ue(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"destroy",value:function(){this.reset(),this.id=-1}}]),e}(),Pe=function(e){De(i,e);var t=Le(i);function i(){var e;return Oe(this,i),(e=t.call(this)).TAG="AudioTrack",e.type="audio",e}return i}(xe),Ie=function(e){De(i,e);var t=Le(i);function i(){var e;return Oe(this,i),(e=t.call(this)).TAG="VideoTrack",e.type="video",e.dropped=0,e.sequenceNumber=0,e}return Ue(i,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),i}(xe);function Me(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const Ge=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}var t,i,r;return t=e,r=[{key:"readByte",value:function(e,t,i){var r;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}],(i=[{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",get:function(){return this.dataview.position},set:function(e){this.dataview.position=e}},{key:"back",value:function(e){this.position-=e}},{key:"getUint8",value:function(e){return this.dataview.getUint8(e)}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}}])&&Me(t.prototype,i),r&&Me(t,r),e}();function Fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ve(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ne(e,t,i){return t&&Ve(e.prototype,t),i&&Ve(e,i),e}var je=function(){function e(t){Fe(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return Ne(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),He=function(){function e(t){Fe(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return Ne(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}();function ze(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function We(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Xe(e,t,i){return t&&We(e.prototype,t),i&&We(e,i),e}var Ye=function(){function e(t){ze(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return Xe(e,null,[{key:"getDefault",value:function(){return{dts:-1,pts:-1,originDts:-1,data:new Uint8Array}}}]),e}(),Ke=function(){function e(t){ze(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return Xe(e,null,[{key:"getDefault",value:function(){return{dts:-1,pts:void 0,isKeyframe:!1,originDts:-1,data:new Uint8Array,nals:[]}}}]),e}();function qe(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const Qe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var t,i;return t=e,(i=[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e;for(e=0;e<this._currentWordBitsLeft;e++)if(this._currentWord&2147483648>>>e)return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}])&&qe(t.prototype,i),e}();function Ze(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var $e=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new Qe(i);r.readByte();var n=r.readByte();r.readByte();var a=r.readByte();r.readUEG();var s=e.getProfileString(n),o=e.getLevelString(a),u=1,l=420,c=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(3===(u=r.readUEG())&&r.readBits(1),u<=3&&(l=[0,420,422,444][u]),c=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var h=3!==u?8:12,d=0;d<h;d++)r.readBool()&&(d<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var f=r.readUEG();if(0===f)r.readUEG();else if(1===f){r.readBits(1),r.readSEG(),r.readSEG();for(var p=r.readUEG(),y=0;y<p;y++)r.readSEG()}r.readUEG(),r.readBits(1);var v=r.readUEG(),_=r.readUEG(),g=r.readBits(1);0===g&&r.readBits(1),r.readBits(1);var m=0,E=0,b=0,k=0;r.readBool()&&(m=r.readUEG(),E=r.readUEG(),b=r.readUEG(),k=r.readUEG());var A=1,T=1,S=0,w=!0,D=0,R=0;if(r.readBool()){if(r.readBool()){var L=r.readByte();L>0&&L<16?(A=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][L-1],T=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][L-1]):255===L&&(A=r.readByte()<<8|r.readByte(),T=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var B=r.readBits(32),O=r.readBits(32);w=r.readBool(),S=(D=O)/(R=2*B)}}var C=1;1===A&&1===T||(C=A/T);var U=0,x=0;0===u?(U=1,x=2-g):(U=3===u?1:2,x=(1===u?2:1)*(2-g));var P=16*(v+1),I=16*(_+1)*(2-g);P-=(m+E)*U,I-=(b+k)*x;var M=Math.ceil(P*C);return r.destroy(),r=null,{profile_string:s,level_string:o,bit_depth:c,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:w,fps:S,fps_den:R,fps_num:D},par_ratio:{width:A,height:T},codec_size:{width:P,height:I},present_size:{width:M,height:I}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,r=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/r)),t}}],null&&Ze(t.prototype,null),i&&Ze(t,i),e}();const Je=$e;function et(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const tt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}],null&&et(t.prototype,null),i&&et(t,i),e}();function it(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var rt=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t};const nt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_resolveNalu",value:function(e){return e.length>=1?tt.EBSP2SODB(tt.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);return 5===n?e.user_data_unregistered(s):{code:n,content:s}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:rt(a.slice(0,16)),content:rt(a.slice(16,r))}}}],null&&it(t.prototype,null),i&&it(t,i),e}();function at(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const st=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};e.analyseNal(s),s.type<=9&&0!==s.type&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:try{e.sei=nt.parse(e.body)}catch(e){}break;case 7:e.sps=Je.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=r:(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),r),r+=2,i.set(e,r),i[r+=e.byteLength]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),r+=2,i.set(t,r),i}}],null&&at(t.prototype,null),i&&at(t,i),e}();function ot(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const ut=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}var t,i;return t=e,(i=[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e;for(e=0;e<this._currentWordBitsLeft;e++)if(this._currentWord&2147483648>>>e)return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}])&&ot(t.prototype,i),e}();function lt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var ct=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(r[n]=t[a],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i,r,n,a,s,o,u=e._ebsp2rbsp(t),l=new ut(u),c=0,h=0,d=0,f=0,p=0,y=0,v=0,_=0,g=0;return l.readByte(),l.readByte(),l.readBits(4),i=l.readBits(3),l.readBits(1),o=e._readProfileTierLevel(l,i),l.readUEG(),3===(r=l.readUEG())&&(c=l.readBits(1)),h=l.readUEG(),d=l.readUEG(),1===(n=l.readBits(1))&&(f=l.readUEG(),p=l.readUEG(),y=l.readUEG(),v=l.readUEG()),a=l.readUEG(),s=l.readUEG(),1===n&&(h-=(_=1!==r&&2!==r||0!==c?1:2)*p+_*f,d-=(g=1===r&&0===c?2:1)*v+g*y),l.destroy(),l=null,{width:h,height:d,general_profile_space:o.general_profile_space,general_tier_flag:o.general_tier_flag,general_profile_idc:o.general_profile_idc,general_level_idc:o.general_level_idc,chromaFormatIdc:r,bitDepthLumaMinus8:a,bitDepthChromaMinus8:s}}},{key:"_readProfileTierLevel",value:function(e,t){var i,r,n,a;i=e.readBits(2)||0,r=e.readBits(1)||0,n=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var s=[],o=[],u=0;u<t;u++)s[u]=e.readBits(1),o[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==s[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:r,general_profile_idc:n,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}],null&&lt(t.prototype,null),i&&lt(t,i),e}();const ht=ct;function dt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const ft=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}],null&&dt(t.prototype,null),i&&dt(t,i),e}();function pt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var yt=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t};const vt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"_resolveNalu",value:function(e){return e.length>=1?ft.EBSP2SODB(ft.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),r=e.switchPayloadType(i),n=r.payloadType,a=r.offset,s=i.slice(a);return 5===n?e.user_data_unregistered(s):{code:n,content:s}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadType:i+=t.getUint8(r++),offset:r}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,r=0;255===t.getUint8(r);)r++,i+=255;return{payloadLength:i+=t.getUint8(r++),offset:r}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),r=i.payloadLength,n=i.offset;if(r<16)return{uuid:"",content:null};var a=t.slice(n);return{code:5,uuid:yt(a.slice(0,16)),content:yt(a.slice(16,r))}}}],null&&pt(t.prototype,null),i&&pt(t,i),e}();function _t(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const gt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,a=n;n<t.length-4;){var s=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),a=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(n+s.byteLength,a))};e.analyseNal(o),o.type<=40&&i.push(o),t.skip(a-t.position),n=a}return i}},{key:"getHvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+r));t.skip(r);var s={header:n,body:a};try{e.analyseNal(s)}catch(e){continue}s.type<=40&&i.push(s)}return i}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=ht.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:default:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:try{e.sei=vt.parse(e.body.slice(1))}catch(e){}break;case 40:e.sei=vt.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,r=e.length;3!==i&&4!==i&&t<r-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===r-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=r:(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=r)),{pos:t,headerLength:i}}}],null&&_t(t.prototype,null),i&&_t(t,i),e}();function mt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Et=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"isHeader",value:function(t,i){return!!(i+1<t.length&&e.isHeaderPattern(t,i))}},{key:"getFrameDuration",value:function(e){return 9216e4/e}},{key:"isHeaderPattern",value:function(e,t){return 255===e[t]&&240==(246&e[t+1])}},{key:"getHeaderLength",value:function(e,t){return 1&e[t+1]?7:9}},{key:"getFullFrameLength",value:function(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}},{key:"parseFrameHeader",value:function(t,i,r,n,a){var s,o,u=t.length;if(s=e.getHeaderLength(t,i),o=e.getFullFrameLength(t,i),(o-=s)>0&&i+s+o<=u)return{headerLength:s,frameLength:o,stamp:r+n*a}}},{key:"appendFrame",value:function(t,i,r,n,a){var s=e.getFrameDuration(t),o=e.parseFrameHeader(i,r,n,a,s);if(o){var u=o.stamp,l=o.headerLength,c=o.frameLength;return{sample:{unit:i.subarray(r+l,r+l+c),pts:u,dts:u},length:c+l}}}}],null&&mt(t.prototype,null),i&&mt(t,i),e}();function bt(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function kt(e){return kt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},kt(e)}function At(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Tt(e,t){return Tt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Tt(e,t)}function St(e){return St=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},St(e)}var wt=st,Dt=gt,Rt={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],36:["video","HVC.H265"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},Lt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Tt(e,t)}(o,e);var t,i,r,n,a,s=(n=o,a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=St(n);if(a){var i=St(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==kt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function o(e){var t,i=e.videoTrack,r=e.audioTrack;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(t=s.call(this)).TAG="TsDemuxer",t.demuxing=!1,t.videoTrack=i,t.audioTrack=r,t.pat=[],t.pmt=[],t._hasVideoMeta=!1,t._hasAudioMeta=!1,t.gopId=0,t}return t=o,i=[{key:"demux",value:function(e,t,i){if(e&&P.log(this.TAG,"do demux: id=".concat(e.id,",demuxing=").concat(this.demuxing)),!this.demuxing){for(var r={pat:[],pmt:[]},n={};t.length>=188;){if(t.length>=1&&71!==t.array[0][t.offset])throw new Error("Untrust sync code: ".concat(t.array[0][t.offset],", try to recover;"));for(;t.length>=1&&71!==t.array[0][t.offset];)t.shift(1);if(!(t.length<188)){var a=t.shift(188),s=new Ge(a.buffer),u={};o.read(s,u,r);var l=n[u.header.pid];u.pes?(u.pes.codec=u.header.codec,u.pes.streamType=u.header.streamType,n[u.header.pid]||(n[u.header.pid]=[]),n[u.header.pid].push(u.pes),u.pes.ES.buffer=[u.pes.ES.buffer]):l&&l[l.length-1].ES.buffer.push(u.payload.stream)}}for(var c=Object.assign({},e),h=Object.assign({},e),d=i&&this._hasVideoMeta&&!this._hasAudioMeta,f=i&&this._hasAudioMeta&&!this._hasVideoMeta,p=0;p<Object.keys(n).length;p++)for(var y=n[Object.keys(n)[p]],v=0;v<y.length;v++){var _=y[v];_.id=Object.keys(n)[p];var g=15===_.streamType||17===_.streamType;"audio"===_.type&&!d&&g?(_.ES.buffer=o.mergeAudioES(_.ES.buffer),this.pushAudioSample(_,c),c={}):"video"!==_.type||f||(_.ES.buffer=o.mergeVideoES(_.ES.buffer),"HVC.H265"===_.codec?this.pushVideoSampleHEVC(y[v],h):this.pushVideoSample(y[v],h),h={})}}}},{key:"pushAudioSample",value:function(e,t){var i=new je({audioSampleRate:e.ES.frequence,sampleRate:e.ES.frequence,channelCount:e.ES.channel,codec:"mp4a.40."+e.ES.audioObjectType,originCodec:"mp4a.40."+e.ES.originAudioObjectType,originObjectType:e.ES.originAudioObjectType,config:e.ES.audioConfig,id:2,sampleRateIndex:e.ES.frequencyIndex});i.refSampleDuration=Math.floor(1024/i.audioSampleRate*i.timescale);var r=o.compareMeta(this.audioTrack.meta,i,!0);this._hasAudioMeta&&r||(this._hasAudioMeta=!0,t?t.meta=Object.assign({},i):t={meta:Object.assign({},i)},this.emit(o.EVENTS.METADATA_PARSED,"audio",i));var n=0;e.ES.buffer.skip(e.pesHeaderLength+9);for(var a=!1;e.ES.buffer.position<e.ES.buffer.length;)if(Et.isHeader(new Uint8Array(e.ES.buffer.buffer),e.ES.buffer.position)&&e.ES.buffer.position+5<e.ES.buffer.length){var s=Et.appendFrame(this.audioTrack.meta.sampleRate,new Uint8Array(e.ES.buffer.buffer),e.ES.buffer.position,e.pts,n);if(!s||!s.sample)break;e.ES.buffer.skip(s.length);var u=new Ye({dts:s.sample.dts,pts:s.sample.pts,data:s.sample.unit,options:a?{}:t});t.meta&&(a=!0),u.dts=u.pts=Math.ceil(u.pts/90),this.emit(o.EVENTS.AUDIO_SAMPLE_PARSED,u),n++}else e.ES.buffer.skip(1)}},{key:"pushVideoSample",value:function(e,t){for(var i=this,r=wt.getNalunits(e.ES.buffer),n=new He,a=0,s=!1,u=!1,l=[],c=0;c<r.length;c++){var h=r[c];if(h.sps){s=h,n.sps=h.body,n.chromaFormat=s.sps.chroma_format,n.codec="avc1.";for(var d=1;d<4;d++){var f=s.body[d].toString(16);f.length<2&&(f="0"+f),n.codec+=f}n.codecHeight=s.sps.codec_size.height,n.codecWidth=s.sps.codec_size.width,n.frameRate=s.sps.frame_rate,n.id=1,n.level=s.sps.level_string,n.presentHeight=s.sps.present_size.height,n.presentWidth=s.sps.present_size.width,n.profile=s.sps.profile_string,n.refSampleDuration=Math.floor(n.timescale*(s.sps.frame_rate.fps_den/s.sps.frame_rate.fps_num)),n.sarRatio=s.sps.sar_ratio?s.sps.sar_ratio:s.sps.par_ratio}else h.pps?(n.pps=h.body,u=h):h.sei?l.push(h.sei):h.type<9&&(a+=4+h.body.byteLength)}if(s&&u){n.avcc=wt.getAvcc(s.body,u.body);var p=o.compareMeta(this.videoTrack.meta,n,!0);this._hasVideoMeta&&p||(t?t.meta=Object.assign({},n):t={meta:Object.assign({},n)},this._hasVideoMeta=!0,this.emit(o.EVENTS.METADATA_PARSED,"video",n))}for(var y=new Uint8Array(a),v=0,_=!1,g=0;g<r.length;g++){var m=r[g];if(!(m.type&&m.type>=9)){var E=m.body.byteLength;m.idr&&(_=!0),m.pps||m.sps||m.sei||(y.set(new Uint8Array([E>>>24&255,E>>>16&255,E>>>8&255,255&E]),v),v+=4,y.set(m.body,v),v+=E)}}var b=parseInt(e.dts/90),k=parseInt(e.pts/90);l.length&&l.forEach(function(e){e.dts=b,i.emit(o.EVENTS.SEI_PARSED,e)});var A=new Ke({dts:b,pts:k,cts:k-b,originDts:e.dts,purePts:e.purePts,isKeyframe:_,data:y,nals:r,options:t,firstInGop:_,gopId:_?++this.gopId:this.gopId});this.emit(o.EVENTS.VIDEO_SAMPLE_PARSED,A)}},{key:"pushVideoSampleHEVC",value:function(e,t){var i=this,r=Dt.getNalunits(e.ES.buffer);r=r.filter(function(e){return e.body&&e.body.length});var n=new He;n.streamType=36;for(var a=0,s=!1,u=!1,l=!1,c=[],h=!1,d=!1,f=!1,p=!1,y=0;y<r.length;y++){var v=r[y];if(v.vps){if(h)continue;h=!0}else if(v.sps){if(d)continue;d=!0}else if(v.pps){if(f)continue;f=!0}else if(v.key)20!==v.type&&19!==v.type||(p=!0);else if(0===v.type);else if(35===v.type)continue;v.sps?(u=v,n.sps=v.body,n.presentWidth=u.sps.width,n.presentHeight=u.sps.height,n.general_profile_space=u.sps.general_profile_space,n.general_tier_flag=u.sps.general_tier_flag,n.general_profile_idc=u.sps.general_profile_idc,n.general_level_idc=u.sps.general_level_idc,n.codec="hev1.1.6.L93.B0",n.chromaFormatIdc=u.sps.chromaFormatIdc,n.bitDepthLumaMinus8=u.sps.bitDepthLumaMinus8,n.bitDepthChromaMinus8=u.sps.bitDepthChromaMinus8):v.pps?(n.pps=v.body,l=v):v.vps?(n.vps=v.body,s=v):v.sei&&c.push(v.sei),v.type<=40&&(a+=4+v.body.byteLength)}if(u&&l&&s){var _=o.compareMeta(this.videoTrack.meta,n,!0);this._hasVideoMeta&&_||(t?t.meta=Object.assign({},n):t={meta:Object.assign({},n)},n.streamType=36,this.videoTrack.meta=n,this._hasVideoMeta=!0,this.emit(o.EVENTS.METADATA_PARSED,"video",n))}var g=new Uint8Array(a),m=0,E=!1;h=!1,d=!1,f=!1;for(var b=0;b<r.length;b++){var k=r[b];if(!(k.type&&k.type>40)){if(k.vps){if(h)continue;h=!0}else if(k.sps){if(d)continue;d=!0}else if(k.pps){if(f)continue;f=!0}else if(k.key);else if(0===k.type);else if(35===k.type)continue;var A=k.body.byteLength;k.key&&(E=!0),g.set(new Uint8Array([A>>>24&255,A>>>16&255,A>>>8&255,255&A]),m),m+=4,g.set(k.body,m),m+=A}}var T=parseInt(e.dts/90),S=parseInt(e.pts/90);c&&c.forEach(function(e){e.dts=T,i.emit(o.EVENTS.SEI_PARSED,e)});var w=new Ke({dts:T,pts:S,cts:S-T,originDts:e.dts,purePts:e.purePts,isKeyframe:E,data:g,nals:r,options:t,firstInGop:p,gopId:p?++this.gopId:this.gopId});this.emit(o.EVENTS.VIDEO_SAMPLE_PARSED,w)}},{key:"destroy",value:function(){this.removeAllListeners(),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}}],r=[{key:"EVENTS",get:function(){return{DEMUX_COMPLETE:"DEMUX_COMPLETE",METADATA_PARSED:"METADATA_PARSED",VIDEO_SAMPLE_PARSED:"VIDEO_SAMPLE_PARSED",AUDIO_SAMPLE_PARSED:"AUDIO_SAMPLES_PARSED",SEI_PARSED:"SEI_PARSED"}}},{key:"compareArray",value:function(e,t,i){var r=0,n=0;if("Uint8Array"===i?(r=e.byteLength,n=t.byteLength):"Array"===i&&(r=e.length,n=t.length),r!==n)return!1;for(var a=0;a<r;a++)if(e[a]!==t[a])return!1;return!0}},{key:"compareMeta",value:function(e,t,i){if(!e||!t)return!1;for(var r=0,n=Object.keys(e).length;r<n;r++){var a=e[Object.keys(e)[r]],s=t[Object.keys(e)[r]];if(!a&&!s)return!0;if(null==a&&s||a&&void 0===s)return!1;if("object"!==kt(a)){if(i&&"duration"!==Object.keys(e)[r]&&"refSampleDuration"!==Object.keys(e)[r]&&"refSampleDurationFixed"!==Object.keys(e)[r]&&a!==s)return!1}else if(void 0!==a.byteLength){if(void 0===s.byteLength)return!1;if(!o.compareArray(a,s,"Uint8Array"))return!1}else if(void 0!==a.length){if(void 0===s.length)return!1;if(!o.compareArray(a,s,"Array"))return!1}else if(!o.compareMeta(a,s))return!1}return!0}},{key:"mergeVideoES",value:function(e){for(var t,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length-e[n].position;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer,s.position),r),r+=s.length-s.position}return new Ge(t.buffer)}},{key:"mergeAudioES",value:function(e){for(var t,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer),r),r+=s.length}return new Ge(t.buffer)}},{key:"read",value:function(e,t,i){o.readHeader(e,t),o.readPayload(e,t,i),"MEDIA"!==t.header.packet||1!==t.header.payload||t.unknownPIDs||(t.pes=o.PES(t))}},{key:"readPayload",value:function(e,t,i){var r=t.header.pid;switch(r){case 0:o.PAT(e,t,i);break;case 1:o.CAT(e,t,i);break;case 2:o.TSDT(e,t,i);break;case 8191:break;default:for(var n=!1,a=0,s=i.pat.length;a<s;a++)if(i.pat[a].pid===r){n=!0;break}if(n)o.PMT(e,t,i);else{for(var u=[],l=0,c=i.pmt.length;l<c;l++)if(i.pmt[l].pid===r){u.push(i.pmt[l]);break}if(u.length>0){var h=u[0].streamType;o.Media(e,t,h)}else t.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var r=e.readUint16();i.error=r>>>15,i.payload=r>>>14&1,i.priority=r>>>13&1,i.pid=8191&r,r=e.readUint8(),i.scrambling=r>>6&3,i.adaptation=r>>4&3,i.continuity=15&r,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var r={},n=e.readUint8();e.skip(n),n=e.readUint8(),r.tabelID=n,n=e.readUint16(),r.error=n>>>7,r.zero=n>>>6&1,r.sectionLength=4095&n,r.streamID=e.readUint16(),r.current=1&e.readUint8(),r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var a=(r.sectionLength-9)/4,s=[],o=0;o<a;o++){var u=e.readUint16(),l=8191&e.readUint16();s.push({program:u,pid:l,type:0===u?"network":"mapPID"})}s.length>0&&(i.pat=i.pat.concat(s)),r.list=s,r.program=e.readUint16(),r.pid=8191&e.readUint16(),t.payload=r}},{key:"PMT",value:function(e,t,i){t.header.packet="PMT";var r=e.position;r+=e.getUint8(r);var n=(r+=1)+3+((15&e.getUint8(r+1))<<8|e.getUint8(r+2))-4;r+=12+((15&e.getUint8(r+10))<<8|e.getUint8(r+11));for(var a=[];r<n;){var s=(31&e.getUint8(r+1))<<8|e.getUint8(r+2);a.push({streamType:e.getUint8(r),pid:s}),r+=5+((15&e.getUint8(r+3))<<8|e.getUint8(r+4))}i.pmt=a,e.skip(n+4)}},{key:"Media",value:function(e,t,i){var r=t.header,n={},a=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,a=[],s=!0,o=!1;try{for(i=i.call(e);!(s=(r=i.next()).done)&&(a.push(r.value),!t||a.length!==t);s=!0);}catch(e){o=!0,n=e}finally{try{s||null==i.return||i.return()}finally{if(o)throw n}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return bt(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?bt(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(Rt[i],2),s=a[0],o=a[1];if(r.streamType=i,r.type=s,r.codec=o,3===r.adaptation&&(n.adaptationLength=e.readUint8(),n.adaptationLength>0)){var u=e.readUint8();n.discontinue=u>>>7,n.access=u>>>6&1,n.priority=u>>>5&1,n.PCR=u>>>4&1,n.OPCR=u>>>3&1,n.splicePoint=u>>>2&1,n.transportPrivate=u>>>1&1,n.adaptationField=1&u;var l=e.position;if(1===n.PCR&&(n.programClockBase=e.readUint32()<<1,u=e.readUint16(),n.programClockBase|=u>>>15,n.programClockExtension=511&u),1===n.OPCR&&(n.originProgramClockBase=e.readUint32()<<1,u=e.readUint16(),n.originProgramClockBase+=u>>>15,n.originProgramClockExtension=511&u),1===n.splicePoint&&(n.spliceCountdown=e.readUint8()),1===n.transportPrivate)for(var c=e.readUint8(),h=[],d=0;d<c;d++)h.push(e.readUint8());if(1===n.adaptationField){var f=e.readUint8(),p=e.readUint8(),y=e.position,v=p>>>6&1,_=p>>>5&1;1==p>>>7&&(p=e.readUint16(),n.ltwValid=p>>>15,n.ltwOffset=61439&p),1===v&&(p=e.readUint24(),n.piecewiseRate=4194303&p),1===_&&(p=e.readInt8(),n.spliceType=p>>>4,n.dtsNextAU1=p>>>1&7,n.marker1=1&p,p=e.readUint16(),n.dtsNextAU2=p>>>1,n.marker2=1&p,p=e.readUint16(),n.dtsNextAU3=p),e.skip(f-1-(e.position-y))}var g=n.adaptationLength-1-(e.position-l);e.skip(g)}n.stream=new Ge(e.buffer.slice(e.position)),t.payload=n}},{key:"PES",value:function(e){var t={},i=e.payload.stream;if(1!==i.readUint24())t.ES={},t.ES.buffer=i;else{var r=i.readUint8();r>=224&&r<=239&&(t.type="video"),r>=192&&r<=223&&(t.type="audio");var n=i.readUint16();if(t.packetLength=n,"video"!==t.type&&"audio"!==t.type)throw new Error("format is not supported");var a=i.readUint8();if(2!=a>>>6)throw new Error("error when parse pes header");a=i.readUint8(),t.ptsDTSFlag=a>>>6,t.escrFlag=a>>>5&1,t.esRateFlag=a>>>4&1,t.dsmFlag=a>>>3&1,t.additionalFlag=a>>>2&1,t.crcFlag=a>>>1&1,t.extensionFlag=1&a,t.pesHeaderLength=i.readUint8();var s=t.pesHeaderLength,u=[];u.push(i.readUint8()),u.push(i.readUint8()),u.push(i.readUint8()),u.push(i.readUint8()),u.push(i.readUint8());var l=536870912*(14&u[0])+4194304*(255&u[1])+16384*(254&u[2])+128*(255&u[3])+(254&u[4])/2;if(t.purePts=l,i.dataview.position-=5,u=[],a=i.readUint8(),u.push(a>>>1&7),a=i.readUint16(),u.push(a>>>1),a=i.readUint16(),u.push(a>>>1),t.pts=u[0]<<30|u[1]<<15|u[2],s-=5,"video"===t.type&&(t.dts=t.pts),3===t.ptsDTSFlag){var c=[];a=i.readUint8(),c.push(a>>>1&7),a=i.readUint16(),c.push(a>>>1),a=i.readUint16(),c.push(a>>>1),t.dts=c[0]<<30|c[1]<<15|c[2],s-=5}if(1===t.escrFlag){var h=[],d=[];a=i.readUint8(),h.push(a>>>3&7),h.push(3&a),a=i.readUint16(),h.push(a>>>13),h.push(3&a),a=i.readUint16(),h.push(a>>>13),d.push(3&a),a=i.readUint8(),d.push(a>>>1),t.escr=300*(h[0]<<30|h[1]<<28|h[2]<<15|h[3]<<13|h[4])+(d[0]<<7|d[1]),s-=6}if(1===t.esRateFlag&&(a=i.readUint24(),t.esRate=a>>>1&4194303,s-=3),1===t.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===t.additionalFlag&&(a=i.readUint8(),t.additionalCopyInfo=127&a,s-=1),1===t.crcFlag&&(t.pesCRC=i.readUint16(),s-=2),1===t.extensionFlag)throw new Error("not support extension");s>0&&i.skip(s),t.dts>t.pts&&(t.dts=t.pts),t.ES=o.ES(i,t.type,e.header.streamType)}return t}},{key:"ES",value:function(e,t,i){var r={};if("video"===t)r.buffer=e;else{if("audio"!==t)throw new Error("ES ".concat(t," is not supported"));15!==i&&17!==i||(r=o.parseADTSHeader(e)),r.buffer=e}return r}},{key:"parseADTSHeader",value:function(e){var t={},i=e.readUint16();if(i>>>4!=4095)throw new Error("aac ES parse Error");return t.id=i>>>3&1?"MPEG-2":"MPEG-4",t.layer=i>>>1&3,t.absent=1&i,i=e.readUint16(),t.audioObjectType=1+(i>>>14&3),t.profile=t.audioObjectType-1,t.frequencyIndex=i>>>10&15,t.frequence=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][t.frequencyIndex],t.channel=i>>>6&7,t.frameLength=(3&i)<<11|e.readUint16()>>>5,o.getAudioConfig(t),e.skip(1),t.buffer=e,t}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var r={};r.tableID=e.readUint8();var n=e.readUint16();r.sectionIndicator=n>>>7,r.sectionLength=4095&n,e.skip(2),n=e.readUint8(),r.version=n>>>3,r.currentNextIndicator=1&n,r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var a=(this.sectionLength-9)/4,s=[],o=0;o<a;o++)s.push({});r.crc32=e.readUint32(),t.payload=r}},{key:"getAudioConfig",value:function(e){var t,i,r=window.navigator.userAgent.toLowerCase()||"";e.originAudioObjectType=e.audioObjectType,/firefox/i.test(r)?e.frequencyIndex>=8?(e.audioObjectType=5,t=new Array(4),i=e.frequencyIndex-3):(e.audioObjectType=2,t=new Array(2),i=e.frequencyIndex):-1!==r.indexOf("android")?(e.audioObjectType=2,t=new Array(2),i=e.frequencyIndex):(e.audioObjectType=5,t=new Array(4),e.frequencyIndex>=6?i=e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,t=new Array(2)),i=e.frequencyIndex)),t[0]=e.audioObjectType<<3,t[0]|=(14&e.frequencyIndex)>>1,t[1]=(1&e.frequencyIndex)<<7,t[1]|=e.channel<<3,5===e.audioObjectType&&(t[1]|=(14&i)>>1,t[2]=(1&i)<<7,t[2]|=8,t[3]=0),e.audioConfig=t}}],i&&At(t.prototype,i),r&&At(t,r),o}(k());const Bt=Lt;function Ot(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ct=_.DEMUX_EVENTS,Ut=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.configs=Object.assign({},t),this.demuxer=null}var t,i;return t=e,(i=[{key:"init",value:function(){this.on(Ct.DEMUX_START,this.demux.bind(this))}},{key:"initDemuxer",value:function(){this.demuxer.on(Bt.EVENTS.METADATA_PARSED,this.onMetaDataParsed.bind(this)),this.demuxer.on(Bt.EVENTS.VIDEO_SAMPLE_PARSED,this.onVideoSampleParsed.bind(this)),this.demuxer.on(Bt.EVENTS.AUDIO_SAMPLE_PARSED,this.onAudioSampleParsed.bind(this)),this.demuxer.on(Bt.EVENTS.SEI_PARSED,this.emit.bind(this,Ct.SEI_PARSED))}},{key:"demux",value:function(e,t){if(this._tracks){this._tracks.audioTrack||(this._tracks.audioTrack=new Pe),this._tracks.videoTrack||(this._tracks.videoTrack=new Ie),this.demuxer||(this.demuxer=new Bt(this._tracks),this.initDemuxer());try{this.demuxer.demux(e,this.inputBuffer,t)}catch(e){this.emit(Ct.DEMUX_ERROR,this.TAG,e,!1)}var i=this._tracks.videoTrack&&this._tracks.videoTrack.samples.length?1:0,r=this._tracks.audioTrack&&this._tracks.audioTrack.samples.length?1:0;this.emit(Ct.DEMUX_COMPLETE,i,r)}}},{key:"onMetaDataParsed",value:function(e,t){var i=this._tracks,r=i.videoTrack,n=i.audioTrack,a=r;switch(e){case"video":default:a=r;break;case"audio":a=n}a.meta=t,this.emit(Ct.METADATA_PARSED,e,t)}},{key:"onVideoSampleParsed",value:function(e){e.isKeyframe&&this.emit(Ct.ISKEYFRAME,e.pts,e.pts-e.dts),this._tracks.videoTrack.samples.push(e)}},{key:"onAudioSampleParsed",value:function(e){this._tracks.audioTrack.samples.push(e)}},{key:"destroy",value:function(){this.off(Ct.DEMUX_START,this.demux),this.configs={},this.demuxer&&this.demuxer.destroy()}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}])&&Ot(t.prototype,i),e}();const xt=Ut;function Pt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const It=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}],null&&Pt(t.prototype,null),i&&Pt(t,i),e}();function Mt(e){return function(e){if(Array.isArray(e))return Gt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return Gt(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Gt(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Gt(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function Ft(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Vt=_.REMUX_EVENTS;const Nt=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this._lastSegmentId=0,this._currentSegmentId=0,this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){t.___videoLargeGap=e,P.warn(t.TAG,"videoLargGap:",e),0!==e&&t.emit(Vt.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){t.___audioLargeGap=e,P.warn(t.TAG,"audioLargeGap:",e),0!==e&&t.emit(Vt.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}var t,i,r;return t=e,r=[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:Mt(e).sort(function(e,t){return e.dts-t.dts})}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=Mt(e).sort(function(e,t){return e.dts-t.dts}),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}var a=e[0];a&&0===a.dts&&(a.dts=a.pts=1)}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,r=[],n=0,a=e.length;n<a;n++){var s=e[n];!s.options||!s.options.meta||t&&0===n||(i=!0,r.push(n))}return{changed:i,changedIdxes:r}}}],(i=[{key:"init",value:function(){this.before(Vt.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"_isSegmentsContinuous",value:function(){return 0===this._lastSegmentId||this._currentSegmentId-this._lastSegmentId===1}},{key:"doFix",value:function(){var t,i,r,n=0;this.videoTrack.samples.length&&(t=(i=this.videoTrack.samples[0]).options,P.long&&P.log(this.TAG,this.videoTrack.samples.slice())),this.audioTrack.samples.length&&(r=this.audioTrack.samples[0],P.long&&P.log(this.TAG,this.audioTrack.samples.slice())),i&&r&&(n=r.dts-i.dts),this._currentSegmentId=t&&t.id||this._currentSegmentId+1,P.log(this.TAG,"lastSeg:".concat(this._lastSegmentId," , currentSeg:").concat(this._currentSegmentId,", discontinue:").concat(t&&t.discontinue," vSamp0:").concat(i&&i.dts," aSamp0:").concat(r&&r.dts));var a=this.getFirstSample(),s=a.isFirstAudioSamples,o=a.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var u=e.detectChangeStream(this.videoTrack.samples,o),l=u.changed,c=u.changedIdxes;if(l){for(var h=!1,d=0;d<c.length;d++)this.fixChangeStreamVideo(c[d],o)&&(h=!0);h||this.doFixVideo(o)}else if(!this._isSegmentsContinuous()&&t&&void 0!==t.start){this.videoLastSample=null;var f=t.start;n<0&&(f-=n),P.log(this.TAG,"fix video for _isSegmentsContinuous()， delta:",n),this.doFixVideo(o,f),this.emit(Vt.DETECT_FRAG_ID_DISCONTINUE,t.start/1e3)}else this.doFixVideo(o);this._appendSampleForLastSegment(t&&t.isLast);var p=e.detectChangeStream(this.audioTrack.samples,s),y=p.changed,v=p.changedIdxes;if(y){for(var _=!1,g=0;g<v.length;g++)this.fixChangeStreamAudio(v[g],s)&&(_=!0);if(_)return;this.doFixAudio(s)}else{var m;!this._isSegmentsContinuous()&&t&&void 0!==t.start?(P.log(this.TAG,"fix audio for _isSegmentsContinuous()"),this.nextAudioDts=t.start||(null===(m=this.audioTrack.samples[0])||void 0===m?void 0:m.dts),this.doFixAudio(s,t.start),this.emit(Vt.DETECT_FRAG_ID_DISCONTINUE,t.start/1e3)):this.doFixAudio(s)}this.removeInvalidSamples(),this._lastSegmentId=this._currentSegmentId}},{key:"doFixVideo",value:function(t,i){for(var r=this.videoTrack,n=r.samples,a=r.meta,s=n.length,o=0;o<s;o++){var u=n[o];u.originDts=u.dts,u.originPts=u.pts}if(n&&s&&this._firstVideoSample){var l=n[0];if(P.log(this.TAG,"doFixVideo:: lastVideoDts: ".concat(this.lastVideoDts," ,  _videoLargeGap: ").concat(this._videoLargeGap," ,streamChangeStart:").concat(i,", lastVideoSample:[dts=").concat(this.videoLastSample&&this.videoLastSample.dts," , pts=").concat(this.videoLastSample&&this.videoLastSample.pts,"] ,  firstDTS:").concat(l.dts," ,firstPTS:").concat(l.pts," ,lastDTS:").concat(n[s-1].dts," , lastPTS: ").concat(n[s-1].pts)),!t&&void 0===i&&this.videoLastSample&&e.detectVideoLargeGap(this.videoLastSample?this.videoLastSample.dts:0,l.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+a.refSampleDuration-l.dts),0!==this._videoLargeGap&&(e.doFixLargeGap(n,this._videoLargeGap),this._videoLargeGap!==this.preVideoGap&&(this.preVideoGap=this._videoLargeGap,this.emit(Vt.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:this.videoLastSample&&this.videoLastSample.originDts,curDts:l.originDts}))),t||void 0===i||0===i||(this._videoLargeGap=i-l.dts,e.doFixLargeGap(n,this._videoLargeGap)),t&&this._firstAudioSample){var c=this._firstVideoSample.originDts,h=c-this._firstAudioSample.dts;if(h>2*a.refSampleDuration&&h<10*a.refSampleDuration){for(var d=Math.floor(h/a.refSampleDuration),f=0;f<d;f++){var p=Object.assign({},l);p.dts=c-(f+1)*a.refSampleDuration,p.pts=p.dts+p.cts,n.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(h)>2*a.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*h,e.doFixLargeGap(n,-1*h))}for(var y=n.length,v=1;v<y;v++){var _=n[v],g=n[v-1],m=_.dts-_.pts;Math.abs(m)<2e3&&Math.abs(_.dts-g.dts)>1e4&&(_.dts=g.dts+a.refSampleDuration,_.pts=g.pts+a.refSampleDuration)}var E=n.pop();if(n.length&&(n[n.length-1].duration=E.dts-n[n.length-1].dts),y<4){var b=n[n.length-1],k=(b=b||E).options&&b.options.duration,A=a.refSampleDuration;if(k&&A&&k/A>5)for(var T=b.pts,S=b.dts,w=0;w<3;w++){S+=A,T+=A;var D=Object.assign({},b,{dts:S,pts:T});2===w&&(D.duration=k),n.push(D)}E=null}if(this.videoLastSample){var R=this.videoLastSample;R.duration=l.dts-R.dts,n.unshift(this.videoLastSample)}this.videoLastSample=E,n[n.length-1]&&(this.lastVideoDts=n[n.length-1].dts),this.videoTrack.samples=n}}},{key:"_appendSampleForLastSegment",value:function(e){e&&this.videoLastSample&&this.videoTrack.samples.push(this.videoLastSample)}},{key:"doFixAudio",value:function(t,i){var r=this,n=this.audioTrack,a=n.samples,s=n.meta;if(a&&a.length){this.fixAudioRefSampleDuration(s);for(var o=0,u=a.length;o<u;o++){var l=a[o];l.originDts=l.dts}var c,h=a.length,d=It.getSilentFrame(s.codec,s.channelCount),f=Math.floor(s.refSampleDuration),p=this._firstAudioSample,y=a[0];if(P.log(this.TAG,"doFixAudio:: audioDtsBase:".concat(this.audioDtsBase," ,  _audioLargeGap: ").concat(this._audioLargeGap,", streamChangeStart:").concat(i," ,  nextAudioDts:").concat(this.nextAudioDts,",  audio: firstDTS:").concat(y.dts," ,firstPTS:").concat(y.pts," ,lastDTS:").concat(a[h-1].dts," , lastPTS: ").concat(a[h-1].pts)),!t&&null===this.nextAudioDts&&y.options&&y.options.start&&void 0!==i&&(i=y.options.start),!t&&void 0===i&&this.nextAudioDts&&e.detectAudioLargeGap(this.nextAudioDts||0,y.dts+this._audioLargeGap)){var v=this.nextAudioDts-y.dts;this._audioLargeGap=Math.abs(v-this._videoLargeGap)<200?this._videoLargeGap:v}if(0!==this._audioLargeGap?(e.doFixLargeGap(a,this._audioLargeGap),this._audioLargeGap!==this.preAudioGap&&(this.preAudioGap=this._audioLargeGap,this.emit(Vt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:this.lastAudioOriginDts,curDts:y.originDts}))):t||void 0===i&&!e.detectAudioLargeGap(this.nextAudioDts,y.dts)||(void 0!==i&&0!==i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-y.dts,y.options.start&&!y.options.start.isContinue&&e.doFixLargeGap(a,this._audioLargeGap)),this._firstVideoSample&&t){var _=this._firstVideoSample.originDts||this._firstVideoSample.dts,g=p.dts-_;if(g===this._videoLargeGap);else if(g>s.refSampleDuration&&g<10*s.refSampleDuration){for(var m=Math.floor((p.dts-_)/s.refSampleDuration),E=0;E<m;E++){var b={data:d,datasize:d.byteLength,dts:p.dts-(E+1)*s.refSampleDuration,filtered:0};a.unshift(b),this.filledAudioSamples.push({dts:b.dts,size:b.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else g<-1*s.refSampleDuration&&(this._audioLargeGap=-1*g,e.doFixLargeGap(a,-1*g))}var k=a[0].dts;if(this.nextAudioDts){c=k-this.nextAudioDts;var A=Math.abs(c);if(c>=f&&c<1e4&&d){for(var T=Math.ceil(c/f),S=0;S<T;S++){var w=k-(S+1)*f,D={dts:w>this.nextAudioDts?w:this.nextAudioDts,pts:w>this.nextAudioDts?w:this.nextAudioDts,datasize:d.byteLength,filtered:0,data:d};this.filledAudioSamples.push({dts:D.dts,size:D.data.byteLength}),this.audioTrack.samples.unshift(D),y=D}this.emit(Vt.DETECT_AUDIO_GAP,c,T)}else A<s.refSampleDuration&&A>0?(y.dts=this.nextAudioDts,y.pts=this.nextAudioDts):c<0&&A<f&&(e.doFixLargeGap(a,-1*c),this.emit(Vt.DETECT_AUDIO_OVERLAP,c))}for(var R=a[0].dts+f,L=1;L<a.length;){var B=a[L],O=B.dts-R;if(O<=-1*f)P.warn("drop 1 audio sample for ".concat(O," ms overlap")),a.splice(L,1);else if(O>=10*f){var C=Math.round(O/f);if(C>1e3)break;P.warn(this.TAG,"inject ".concat(C," audio frame for ").concat(O," ms gap"));for(var U=0;U<C;U++){var x={data:d,datasize:d.byteLength,dts:R,originDts:R,filtered:0};a.splice(L,0,x),R+=f,L++}B.dts=B.pts=B.originDts=R,R+=f,L++}else B.dts=B.pts=B.originDts=R,R+=f,L++}var I=s.refSampleDuration-f;a.forEach(function(e,t){if(0!==t){var i=a[t-1];e.dts=e.pts=i.dts+i.duration}e.duration=f,r.audioUnsyncTime=r.audioUnsyncTime+I,r.audioUnsyncTime>=1&&(e.duration+=1,r.audioUnsyncTime-=1)});var M=a[a.length-1];this.lastAudioDts=M.dts;var G=M.duration;this.lastAudioSamplesLen=h,this.nextAudioDts=this.lastAudioDts+(G||f),this.lastAudioOriginDts=M.originDts,this.audioTrack.samples=e.sortAudioSamples(a)}}},{key:"fixChangeStreamVideo",value:function(e){P.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack.samples,i=0===e?this.lastVideoDts?this.lastVideoDts:this.getStreamChangeStart(t[0]):t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(Vt.DETECT_CHANGE_STREAM,"video",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(Vt.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:i,curDts:r});var a,s=t.slice(0,e),o=t.slice(e),u=t[e];return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,a=u.options&&void 0!==u.options.start?u.options.start:i-this.videoDtsBase,this.videoTrack.samples=t.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=t.slice(e),this.doFixVideo(!1,a),this.videoTrack.samples=s.concat(o),!0}},{key:"fixChangeStreamAudio",value:function(e){P.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack.samples,i=0===e?this.lastAudioDts:t[e-1].dts,r=t[e].dts,n=Math.abs(i-r)<=1e4;if(this.emit(Vt.DETECT_CHANGE_STREAM,"audio",r),n)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(Vt.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:i,curDts:r}),this._audioLargeGap=0;var a=this.nextAudioDts;this.nextAudioDts=null;var s,o=t.slice(0,e),u=t.slice(e),l=t[e];return l.options&&void 0!==l.options.start?s=l.options.start:(s=a,l.options.isContinue=!0),this.audioTrack.samples=o,this.doFixAudio(!1),this.audioTrack.samples=u,this.doFixAudio(!1,s),this.audioTrack.samples=o.concat(u),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,r=!1,n=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),r=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),n=!0),{isFirstVideoSamples:r,isFirstAudioSamples:n}}},{key:"fixVideoRefSampleDuration",value:function(t,i){if(t){var r=this.allVideoSamplesCount,n=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&i.length>=5){var s=(i[i.length-1].dts-i[0].dts)/(i.length-1);if(s>0&&s<1e3){var o=Math.floor(Math.abs(t.refSampleDuration-s)<=5?t.refSampleDuration:s);e.isRefSampleDurationValid(o)&&(t.refSampleDuration=o)}}}else if(i.length>=1){var u=i[i.length-1].dts,l=Math.floor((u-n)/(r+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(t,i){return t===e||t.dts>=e.dts})),t&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(e,i){return e===t||e.dts>=t.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}])&&Ft(t.prototype,i),r&&Ft(t,r),e}();function jt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ht(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var zt=function e(){Ht(this,e),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0};const Wt=function(){function e(){Ht(this,e),this.sources={}}var t,i;return t=e,(i=[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new zt,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.clear()}}])&&jt(t.prototype,i),e}();function Xt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const Yt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}var t,i;return t=e,(i=[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var r=new Uint8Array(e),n=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);r.set(a,n),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;r.set(this.array[0].slice(this.offset,this.array[0].length),n),this.array.shift(),this.offset=0,n+=s,this.length-=s,e-=s}return r}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;){var n;r<(null===(n=this.array[0])||void 0===n?void 0:n.length)?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++}return i}}])&&Xt(t.prototype,i),e}();function Kt(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var qt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this.end=!1,this.autoclear=t.autoclear||!1,this.logger=t.logger,this.downloadedUrls=[],this._avgSegmentDuration=4}var t,i;return t=e,i=[{key:"list",get:function(){return this._list}},{key:"baseURL",get:function(){return this._baseURL},set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)}},{key:"avgSegmentDuration",get:function(){return this._avgSegmentDuration}},{key:"push",value:function(e,t,i,r,n,a){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i,id:r,cc:n,isLast:a||!1},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e,id:this._ts[e].id}),delete this._list[this._ts[e].start],delete this._ts[e],this.fragLength-=1)}},{key:"_calcAvgFrgmentDuration",value:function(e){if(!e.frags)return e.targetduration;var t=e.frags.length;return Math.floor(e.duration/t/1e3)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,this._avgSegmentDuration=Math.min(this.targetduration,this._calcAvgFrgmentDuration(e)),e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),this.end=e.end||!1,e.sequence||(e.sequence=0),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, ".concat(e.sequence));var i=e.frags.length;this.logger&&this.logger.log("PLAYLIST","new playlist [".concat(e.sequence,", ").concat(e.sequence+i-1,"]")),this.sequence=e.sequence;for(var r=[],n=0;n<i;n++){var a=e.frags[n];!this._ts[a.url]&&this.downloadedUrls.indexOf(a.url)<0&&(r.push(a.url),this.push(a.url,a.duration,a.discontinue,a.id,a.cc,a.isLast))}if(r.length<1)throw new Error("Can not read ts file list.");if(t)for(var s=this.getTsList(),o=0;o<s.length;o++)r.indexOf(s[o])<0&&this.deleteFrag(s[o])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){var i=this._ts[e];i&&(i.downloaded=t)}},{key:"downloading",value:function(e,t){var i=this._ts[e];i&&(i.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t,i=Object.keys(this._list);if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(i.length<1||e>=this.duration)){i=i.sort(function(e,t){return parseFloat(e)-parseFloat(t)});for(var r=0;r<i.length&&e>=parseInt(i[r]);r++){var n=this._list[i[r]];t={url:n,downloaded:this._ts[n].downloaded,downloading:this._ts[n].downloading,time:parseInt(i[r]),duration:parseInt(this._ts[n].duration),id:this._ts[n].id,cc:this._ts[n].cc,isLast:this._ts[n].isLast},this.autoclear&&this._lastget&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=t}return t&&this.downloadedUrls.push(t.url),t}}},{key:"getLastDownloadedTs",value:function(){for(var e,t=Object.keys(this._list).sort(function(e,t){return Number(e)-Number(t)}),i=0;i<t.length;i++){var r=this._list[t[i]],n=this._ts[r].downloaded,a=this._ts[r].downloading;if(!n)break;e={url:r,downloaded:n,downloading:a,time:parseInt(t[i]),duration:parseInt(this._ts[r].duration)}}return e}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=Object.keys(this._ts),t=0,i=e.length;t<i;t++){var r=this._ts[e[t]];r.downloaded=!1,r.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this.autoclear=!1}},{key:"resetSequence",value:function(){this.sequence=-1}}],i&&Kt(t.prototype,i),e}();const Qt=qt;const Zt={Mse:F,Tracks:xe,RemuxedBufferManager:Wt,XgBuffer:Yt,FetchLoader:Y,XhrLoader:$,Compatibility:Nt,Mp4Remuxer:be,Crypto:ie,M3U8Parser:Se,TsDemuxer:xt,Playlist:Qt};function $t(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Jt=_.LOADER_EVENTS,ei=_.REMUX_EVENTS,ti=_.DEMUX_EVENTS,ii=_.HLS_EVENTS,ri=_.CRYPTO_EVENTS,ni=_.MSE_EVENTS,ai=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,si=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.m3u8FlushDuration=4,this.firstFramePts=-1,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),300),this.m3u8Text=null,this._downloadedFragmentQueue=[],this._onWaiting=this._onWaiting.bind(this),this._onEnded=this._onEnded.bind(this)}var t,i;return t=e,i=[{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"init",value:function(){var e=this._pluginConfig,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.RemuxedBufferManager,a=e.Compatibility,s=e.FetchLoader,o=e.XhrLoader,u=e.TsDemuxer,l=e.Mp4Remuxer,c=e.Mse,h=s.isSupported()?s:o;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._track=this._context.registry("TRACKS",i)(),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0,logger:P}),this._context.registry("PRE_SOURCE_BUFFER",n),this._compat=this._context.registry("COMPATIBILITY",a)(),this._m3u8loader=this._context.registry("M3U8_LOADER",h)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",h)({buffer:"TS_BUFFER",readtype:3}),this._tsDemuxer=this._context.registry("TS_DEMUXER",u)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",l),this.mse=this._context.registry("MSE",c)({container:this._player.video,format:"hls"}),this.preloadTime=this._player.config.preloadTime||this._pluginConfig.preloadTime,this.retrytimes=this._pluginConfig.retrytimes,this.initEvents()}},{key:"initEvents",value:function(){var e=this;this.on(Jt.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(Jt.LOADER_RETRY,this._handleFetchRetry.bind(this)),this.on(Jt.LOADER_TTFB,function(t){var i;return null===(i=e._player)||void 0===i?void 0:i.emit("ttfb",t)}),this._addSourceBuffers=this.mse.addSourceBuffers.bind(this.mse),this.on(ei.INIT_SEGMENT,this._addSourceBuffers),this.on(ei.MEDIA_SEGMENT,this._onMediaSegment.bind(this)),this.on(ti.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(ti.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(ti.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(ti.ISKEYFRAME,this._handleKeyFrame.bind(this)),this.on(ni.SOURCE_UPDATE_END,this._handleSourceUpdateEnd.bind(this)),this.on(Jt.LOADER_ERROR,this._onLoadError.bind(this)),this.on(ti.DEMUX_ERROR,this._onDemuxError.bind(this)),this.on(ei.REMUX_ERROR,this._onRemuxError.bind(this)),this._player.on("waiting",this._onWaiting),this._player.on("ended",this._onEnded)}},{key:"_onError",value:function(e,t,i,r){var n={code:i.code,errorType:e,type:e,errorDetails:"[".concat(t,"]: ").concat(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",n)}},{key:"_onDemuxComplete",value:function(e,t){if(-1===this.firstFramePts){var i=this._context.getInstance("TRACKS"),r=i&&i.videoTrack&&i.videoTrack.samples[0];this.firstFramePts=r?r.purePts:-1,P.warn(this.TAG,"first frame pts: ".concat(this.firstFramePts))}this.emit(ei.REMUX_MEDIA,"ts"),this._downloadedFragmentQueue.shift();var n=this._downloadedFragmentQueue[0];n&&this.emit(ti.DEMUX_START,n,this._playlist.end)}},{key:"_handleKeyFrame",value:function(e){this._player&&this._player.emit("isKeyframe",e)}},{key:"_onWaiting",value:function(){this._throwTrackChangeError()}},{key:"_onEnded",value:function(){this._throwTrackChangeError()}},{key:"_throwTrackChangeError",value:function(){this._needRecreateMs&&(this._needRecreateMs=!1,this._player.emit("error",{code:3,errorType:"parse",type:"parse",ex:"decode error",errd:{}}),this.destroy())}},{key:"_onMetadataParsed",value:function(e){var t;P.warn(this.TAG,"meta detect or changed , ",e),"video"===e?this._context.mediaInfo.hasVideo=!0:"audio"===e&&(this._context.mediaInfo.hasAudio=!0),null===(t=this._player)||void 0===t||t.emit("metadataparsed",e,this.tracks["".concat(e,"Track")].meta),this.emit(ei.REMUX_METADATA,e)}},{key:"_onMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_onLoadError",value:function(e,t){this._player.pause&&(this._player.pause(),this._player.emit("error",{code:t.code,errorType:"network",type:"network",ex:"[".concat(e,"]: ").concat(t.message),errd:{}}),this._onError(Jt.LOADER_ERROR,e,t,!0),this.emit(ii.RETRY_TIME_EXCEEDED))}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{code:"31",errorType:"parse",type:"parse",ex:"[".concat(e,"]: ").concat(t?t.message:""),errd:{}}),this._onError(ti.DEMUX_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{code:"31",errorType:"parse",type:"parse",ex:"[".concat(e,"]: ").concat(t?t.message:""),errd:{}}),this._onError(ei.REMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{code:"31",errorType:"parse",ex:"[".concat(e,"]: ").concat(t?t.message:""),errd:{}}),this._onError(ni.MSE_ERROR,e,t,i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){var t=this._pluginConfig,i=t.M3U8Parser,r=t.XgBuffer,n=t.FetchLoader,a=t.XhrLoader,s=t.Crypto,o=n.isSupported()?n:a;if("M3U8_BUFFER"===e.TAG){var u;try{this.m3u8Text=e.shift();var l,c=ai.exec(this.m3u8Text);c&&c[2]?this.load(c[2]):(u=i.parse(this.m3u8Text,this.baseurl),null===(l=this._player)||void 0===l||l.emit("hlslevelloaded",u))}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(!u)return void(this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(ii.RETRY_TIME_EXCEEDED),this.mse.endOfStream()));try{this._playlist.pushM3U8(u,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}if(this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key){this._context.registry("DECRYPT_BUFFER",r)(),this._context.registry("KEY_BUFFER",r)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",o)({buffer:"KEY_BUFFER",readtype:3});var h=this._player.config.retry||{},d=h.count,f=h.delay,p=void 0===d?this._pluginConfig.retryCount:d,y=void 0===f?this._pluginConfig.retryDelay:f;this.emitTo("KEY_LOADER",Jt.LADER_START,this._playlist.encrypt.uri,{},{retryCount:p,retryDelay:y,loadTimeout:this._pluginConfig.loadTimeout})}else this._m3u8Loaded(u)}else if("TS_BUFFER"===e.TAG){this.retrytimes=this._pluginConfig.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0);var v=Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url]);this._downloadedFragmentQueue.push(v),0!==this._player.buffered.length&&1!==this._downloadedFragmentQueue.length||this.emit(ti.DEMUX_START,v,this._playlist.end)}else"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this._pluginConfig.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",ri.START_DECRYPTO)):"KEY_BUFFER"===e.TAG&&(this.retrytimes=this._pluginConfig.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",s)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(ri.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_handleFetchRetry",value:function(e,t){this._player.emit("retry",Object.assign({tag:e},t))}},{key:"_onDcripted",value:function(){this.emit(ti.DEMUX_START)}},{key:"_m3u8Loaded",value:function(){this.m3u8FlushDuration=this._playlist.avgSegmentDuration||this.m3u8FlushDuration,this.preloadTime||(this.preloadTime=this._playlist.targetduration?this._playlist.targetduration:5)}},{key:"_checkStatus",value:function(){var e,t=null===(e=this._player)||void 0===e?void 0:e.video;if(t){if(!t.buffered.length||!t.paused)if(t.buffered.length<1)this._preload();else{var i=t.currentTime,r=t.buffered.end(t.buffered.length-1);i<r-2*this.preloadTime&&(t.currentTime=r-this.preloadTime),this._preload()}}else clearInterval(this._timmer)}},{key:"_preload",value:function(){if(!(this._tsloader.loading||this._m3u8loader.loading||this._needRecreateMs)){var e=this._playlist.getTs(),t=this._player.config.retry||{},i=t.count,r=t.delay,n=void 0===i?this._pluginConfig.retryCount:i,a=void 0===r?this._pluginConfig.retryDelay:r,s=this._pluginConfig.fetchOptions,o=void 0===s?{}:s;!e||e.downloaded||e.downloading||(this._logDownSegment(e),this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",Jt.LADER_START,e.url,o,{retryCount:n,retryDelay:a,loadTimeout:this._pluginConfig.loadTimeout}));var u=(new Date).getTime();(u-this._m3u8lasttime)/1e3>this.m3u8FlushDuration&&(this._m3u8lasttime=u,this.emitTo("M3U8_LOADER",Jt.LADER_START,this.url,o,{retryCount:n,retryDelay:a,loadTimeout:this._pluginConfig.loadTimeout}))}}},{key:"_handleSourceUpdateEnd",value:function(){if(this._playlist.end){var e=this._playlist.list,t=e[Object.keys(e).map(function(e){return Number(e)}).sort(function(e,t){return e>t?1:-1}).pop()],i=this._playlist._ts[t];i&&i.downloaded&&(P.warn(this.TAG,"直播结束,断流"),this.mse.endOfStream())}}},{key:"_logDownSegment",value:function(e){e&&(P.groupEnd(),P.group(this.TAG,"load ".concat(e.id,": [").concat(e.time/1e3," , ").concat((e.time+e.duration)/1e3,"], downloading: ").concat(e.downloading," , donwloaded: ").concat(e.downloaded)))}},{key:"load",value:function(e){this.baseurl=this._pluginConfig.M3U8Parser.parseURL(e),this.url=e,this._playlist.resetSequence(),this._preload()}},{key:"destroy",value:function(){this._timmer&&clearInterval(this._timmer),this._player&&(this._player.off("waiting",this._onWaiting),this._player.off("ended",this._onEnded)),this.mse=null,this.m3u8Text=null}}],i&&$t(t.prototype,i),e}();const oi=si;function ui(e){return ui="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ui(e)}function li(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ci(e,t,i){return ci="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=fi(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}},ci(e,t,i||e)}function hi(e,t){return hi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},hi(e,t)}function di(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function fi(e){return fi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},fi(e)}var pi=_.HlsAllowedEvents,yi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&hi(e,t)}(l,e);var t,i,a,s,o,u=(s=l,o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=fi(s);if(o){var i=fi(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==ui(t)&&"function"!=typeof t?di(e):t}(this,e)});function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),(t=u.call(this,e)).played=!1,t.handleUrlChange=t.handleUrlChange.bind(di(t)),t.switchURL=t.switchURL.bind(di(t)),t.destroy=t.destroy.bind(di(t)),t.play=t.play.bind(di(t)),t.handleDefinitionChange=t.handleDefinitionChange.bind(di(t)),t._context=new C(t.player,t.config,pi),t.autoPlayStarted=!1,t}return t=l,a=[{key:"pluginName",get:function(){return"hlsLive"}},{key:"defaultConfig",get:function(){return Object.assign({},Zt,{loadTimeout:1e4,preloadTime:5,retryTimes:3,retryCount:3,retryDelay:1e3})}},{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}}],(i=[{key:"version",get:function(){return"3.0.0-alpha.140"}},{key:"beforePlayerInit",value:function(){var e=this;this.player.switchURL=this.switchURL;var t=this.player.config.url;this.hls=this._context.registry("HLS_LIVE_CONTROLLER",oi)(),this._context.init(),this.hls.load(t),this._initEvents(),this.emit("core_inited",this.hls);try{r.Ay.defineGetterOrSetter(this.player,{__url:{get:function(){var t,i;return null===(t=e.hls)||void 0===t||null===(i=t.mse)||void 0===i?void 0:i.url},configurable:!0}})}catch(e){}}},{key:"_initEvents",value:function(){var e=this;this.on(n.URL_CHANGE,this.handleUrlChange),this.on(n.DEFINITION_CHANGE,this.handleDefinitionChange),this.on(n.DESTROY,this.destroy);var t=this.player.useHooks&&this.player.useHooks("play",this.playForHooks.bind(this));this.playerConfig.autoplay&&this.on(n.AUTOPLAY_STARTED,function(){e.autoPlayStarted=!0}),t||this.on(n.PLAY,this.play)}},{key:"_offEvents",value:function(){this.off(n.URL_CHANGE,this.handleUrlChange),this.off(n.DEFINITION_CHANGE,this.handleDefinitionChange),this.off(n.DESTROY,this.destroy),this.off(n.PLAY,this.play)}},{key:"handleUrlChange",value:function(e){var t=this;this.player.config.url=e,(this.hls.mse?this.hls.mse.destroy():Promise.resolve()).then(function(){t._offEvents(),t._context.destroy(),t._context=null,t.player.video.currentTime=0,t.played=!1,t.player.paused?t.player.video.play():(t.player.pause(),t.once("canplay",function(){t.player.video.play()})),t.player.started=!1,t.player.hasStart=!1,t._context=new C(t.player,t.config,pi),t.player.start()})}},{key:"playForHooks",value:function(){if(!(this.playerConfig.autoplay&&!1===this.autoPlayStarted||this.playerConfig.videoInit&&0===this.player.played.length))return this._offEvents(),this.reload()}},{key:"play",value:function(){if(this.played&&this.player.played.length)return this.played=!1,this._offEvents(),this.reload();this.played=!0}},{key:"reload",value:function(){var e=this;return this._destroy().then(function(){e._context=new C(e.player,e.config,pi),e.player.hasStart=!1,e.player.start(),e.player.addClass("xgplayer-is-enter"),e.player.once("canplay",function(){e.player.video.play()})})}},{key:"handleDefinitionChange",value:function(e){var t=e.to;this.handleUrlChange(t)}},{key:"_destroy",value:function(){var e=this;return this.hls&&this.hls.mse&&this._context?this.hls.mse.destroy().then(function(){var t;null===(t=e._context)||void 0===t||t.destroy(),e.hls=null,e._context=null}).catch(function(e){}):Promise.resolve()}},{key:"destroy",value:function(){ci(fi(l.prototype),"offAll",this).call(this),this._destroy()}},{key:"switchURL",value:function(e){return this.handleUrlChange(e)}},{key:"core",get:function(){return this.hls}},{key:"loader",get:function(){var e;return null===(e=this._context)||void 0===e?void 0:e.getInstance("TS_LOADER")}},{key:"context",get:function(){return this._context}}])&&li(t.prototype,i),a&&li(t,a),l}(r.Ay),vi="metadataparsed";const _i={FetchLoader:Y,Crypto:ie,TsDemuxer:xt,M3U8Parser:Se,Playlist:Qt,XgBuffer:Yt,Tracks:xe};function gi(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var mi=_.LOADER_EVENTS,Ei=_.DEMUX_EVENTS,bi=_.HLS_EVENTS,ki=_.CRYPTO_EVENTS,Ai=/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)/g,Ti=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="HlsLiveMobile",this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.m3u8FlushDuration=4,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),50),this._lastCheck=0,this.m3u8Text=null,this.inWaiting=!1,this._downloadedFragmentQueue=[],this.setDataInterval=null}var t,i;return t=e,i=[{key:"init",value:function(){var e=this._pluginConfig,t=e.XgBuffer,i=e.Tracks,r=e.Playlist,n=e.FetchLoader,a=e.TsDemuxer;this._context.registry("M3U8_BUFFER",t),this._context.registry("TS_BUFFER",t),this._context.registry("TRACKS",i),this._playlist=this._context.registry("PLAYLIST",r)({autoclear:!0,logger:P}),this._m3u8loader=this._context.registry("M3U8_LOADER",n)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",n)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",a)({inputbuffer:"TS_BUFFER"}),this.retryTimes=this._pluginConfig.retryTimes,this.preloadTime=this._player.config.preloadTime||this._pluginConfig.preloadTime,this.initEvents()}},{key:"initEvents",value:function(){var e=this;this.on(mi.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(mi.LOADER_RETRY,function(t,i){e._player.emit("retry",Object.assign({tag:t},i))}),this.on(mi.LOADER_TTFB,function(t){var i;return null===(i=e._player)||void 0===i?void 0:i.emit("ttfb",t)}),this.on(Ei.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(Ei.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(Ei.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(Ei.ISKEYFRAME,this._handleKeyFrame.bind(this)),this.on(mi.LOADER_ERROR,this._onLoadError.bind(this)),this.on(Ei.DEMUX_ERROR,this._onDemuxError.bind(this)),this._onWaiting=this._onWaiting.bind(this),this._onPlaying=this._onPlaying.bind(this),this._player&&(this._player.on("waiting",this._onWaiting),this._player.on("playing",this._onPlaying))}},{key:"_onWaiting",value:function(){!this._player.video||this._player.video.currentTime<1||(this.inWaiting=!0)}},{key:"_onPlaying",value:function(){this.inWaiting=!1}},{key:"_onError",value:function(e,t,i,r){var n={errorType:e,type:e,errorDetails:"[".concat(t,"]: ").concat(i?i.message:""),errorFatal:r};this._player.emit("HLS_ERROR",n)}},{key:"_onDemuxComplete",value:function(){if(this._player.video){var e=this._context.getInstance("TRACKS"),t=e.videoTrack,i=e.audioTrack;if(!t)return;t.samples.forEach(function(e){if(!e.analyzed){e.analyzed=!0;var t=e.nals,i=t.reduce(function(e,t){return e+4+t.body.byteLength},0),r=new Uint8Array(i),n=0;t.forEach(function(e){r.set([0,0,0,1],n),n+=4,r.set(new Uint8Array(e.body),n),n+=e.body.byteLength}),e.nals=null,e.data=r}}),this._player.video.onDemuxComplete(t,i)}this._consumeFragment()}},{key:"_handleKeyFrame",value:function(e){this._player&&this._player.emit("isKeyframe",e)}},{key:"_onMetadataParsed",value:function(e){if(P.warn(this.TAG,"meta detect or changed , ",e),"audio"===e){var t,i=this._context.getInstance("TRACKS").audioTrack;i&&i.meta&&(null===(t=this._player)||void 0===t||t.emit(vi,e,i.meta),this._setMetaToAudio(i.meta))}else{var r,n=this._context.getInstance("TRACKS").videoTrack;n&&n.meta&&(null===(r=this._player)||void 0===r||r.emit(vi,e,n.meta),this._setMetaToVideo(n.meta))}}},{key:"_setMetaToAudio",value:function(e){this._player.video&&this._player.video.setAudioMeta(e)}},{key:"_setMetaToVideo",value:function(e){this._player.video&&this._player.video.setVideoMeta(e)}},{key:"_onLoadError",value:function(e,t){var i={code:t.code,errorType:"network",type:"network",ex:"[".concat(e,"]: ").concat(t.message),errd:{}};this._player.emit("error",i),this._onError(mi.LOADER_ERROR,e,t,!0),this.emit(bi.RETRY_TIME_EXCEEDED),this.destroy()}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._player.emit("error",{code:"31",errorType:"parse",type:"parse",ex:"[".concat(e,"]: ").concat(t?t.message:""),errd:{}}),this._onError(mi.LOADER_ERROR,e,t,i)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_onLoadComplete",value:function(e){var t=this._pluginConfig,i=t.M3U8Parser,r=t.XgBuffer,n=t.FetchLoader,a=t.Crypto;if("M3U8_BUFFER"===e.TAG){var s;try{this.m3u8Text=e.shift();var o=Ai.exec(this.m3u8Text);o&&o[2]?this.load(o[2]):s=i.parse(this.m3u8Text,this.baseurl)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(!s)return void(this.retryTimes>0?(this.retryTimes--,this._preload()):(this.emit(bi.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded()));try{this._playlist.pushM3U8(s,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}if(this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key){this._context.registry("DECRYPT_BUFFER",r)(),this._context.registry("KEY_BUFFER",r)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",n)({buffer:"KEY_BUFFER",readtype:3});var u=this._player.config.retry||{},l=u.count,c=u.delay,h=void 0===l?this._pluginConfig.retryCount:l,d=void 0===c?this._pluginConfig.retryDelay:c;this.emitTo("KEY_LOADER",mi.LADER_START,this._playlist.encrypt.uri,{},{retryCount:h,retryDelay:d,loadTimeout:this._pluginConfig.loadTimeout})}else this._m3u8Loaded(s)}else"TS_BUFFER"===e.TAG?(this.retryTimes=this._pluginConfig.retryTimes,this._playlist.downloaded(this._tsloader.url,!0),this._downloadedFragmentQueue.push(Object.assign({url:this._tsloader.url},this._playlist._ts[this._tsloader.url])),this._consumeFragment()):"DECRYPT_BUFFER"===e.TAG?(this.retryTimes=this._pluginConfig.retryTimes,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",ki.START_DECRYPTO)):"KEY_BUFFER"===e.TAG&&(this.retryTimes=this._pluginConfig.retryTimes,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",a)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(ki.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_consumeFragment",value:function(e){if(!(!e&&this.inWaiting&&this._downloadedFragmentQueue.length<2)){var t=this._downloadedFragmentQueue.shift();t&&(this.emit(Ei.DEMUX_START,t,this._playlist.end),this.inWaiting=!1)}}},{key:"_onDcripted",value:function(){this.emit(Ei.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.m3u8FlushDuration=this._playlist.avgSegmentDuration||this.m3u8FlushDuration,this._playlist.fragLength>0?this.retryTimes=this._pluginConfig.retryTimes:this.retryTimes>0?(this.retryTimes--,this._preload()):(this.emit(bi.RETRY_TIME_EXCEEDED),this._player.video&&this._player.video.handleEnded())}},{key:"_checkStatus",value:function(){if(!(this.retryTimes<1&&(new Date).getTime()-this._lastCheck<1e4))if(this._lastCheck=(new Date).getTime(),this._player.buffered.length<1)this._preload();else{var e=this._player.currentTime;this._player.readyState<=2&&this._preload(),e>this._player.buffered.end(this._player.buffered.length-1)-this.preloadTime&&this._preload()}}},{key:"_preload",value:function(){if(!(this.retryTimes<1||this._tsloader.loading||this._m3u8loader.loading)){var e=this._playlist.getTs(),t=this._player.config.retry||{},i=t.count,r=t.delay,n=void 0===i?this._pluginConfig.retryCount:i,a=void 0===r?this._pluginConfig.retryDelay:r;if(!e||e.downloaded||e.downloading){this._consumeFragment(!0);var s=(new Date).getTime();(!e||e.downloaded)&&(s-this._m3u8lasttime)/1e3>this.m3u8FlushDuration&&(this._m3u8lasttime=s,this.emitTo("M3U8_LOADER",mi.LADER_START,this.url,{},{retryCount:n,retryDelay:a,loadTimeout:this._pluginConfig.loadTimeout}))}else this._logDownSegment(e),this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",mi.LADER_START,e.url,{},{retryCount:n,retryDelay:a,loadTimeout:this._pluginConfig.loadTimeout})}}},{key:"_logDownSegment",value:function(e){e&&(P.groupEnd(),P.group(this.TAG,"load ".concat(e.id,": [").concat(e.time/1e3," , ").concat((e.time+e.duration)/1e3,"], downloading: ").concat(e.downloading," , donwloaded: ").concat(e.downloaded)))}},{key:"_isHEVC",value:function(e){return e&&"hev1.1.6.L93.B0"===e.codec}},{key:"load",value:function(e){this.baseurl=this._pluginConfig.M3U8Parser.parseURL(e),this.url=e,this._preload()}},{key:"resetLoaderIdle",value:function(){this._m3u8loader.loading=!1,this._tsloader.loading=!1}},{key:"resetPlayList",value:function(){this._playlist.clear()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(mi.LOADER_COMPLETE,this._onLoadComplete),this.off(Ei.METADATA_PARSED,this._onMetadataParsed),this.off(Ei.DEMUX_COMPLETE,this._onDemuxComplete),this._player.off("waiting",this._onWaiting),this._player.off("playing",this._onPlaying),this.m3u8Text=null}}],i&&gi(t.prototype,i),e}();const Si=Ti;function wi(e){return wi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},wi(e)}function Di(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ri(e,t,i){return Ri="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Oi(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}},Ri(e,t,i||e)}function Li(e,t){return Li=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Li(e,t)}function Bi(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Oi(e){return Oi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Oi(e)}var Ci=_.HlsAllowedEvents,Ui=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Li(e,t)}(u,e);var t,i,r,a,s,o=(a=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=Oi(a);if(s){var i=Oi(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==wi(t)&&"function"!=typeof t?Bi(e):t}(this,e)});function u(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=o.call(this,e)).play=t.play.bind(Bi(t)),t.switchURL=t.switchURL.bind(Bi(t)),t.handleDefinitionChange=t.handleDefinitionChange.bind(Bi(t)),t.lowdecode=t.lowdecode.bind(Bi(t)),t.largeavgap=t.largeavgap.bind(Bi(t)),t}return t=u,i=[{key:"version",get:function(){return"3.0.0-alpha.140"}},{key:"beforePlayerInit",value:function(){var e=this.player;e.video&&(e.video.setAttribute("preloadtime",this.player.config.preloadTime||this.config.preloadTime),!0===e.config.innerDegrade&&(e.config.innerDegrade=1),e.config.innerDegrade&&e.video.setAttribute("innerdegrade",e.config.innerDegrade)),this._initProcess(),this.initEvents()}},{key:"_initProcess",value:function(){this.player.switchURL=this.switchURL;var e=this.player;this._context=new C(this.player,this.config,Ci),this.initHls(),this._context.init(),this.loadData(),e.forceDegradeToVideo||(e.forceDegradeToVideo=this.forceDegradeToVideo.bind(this))}},{key:"afterCreate",value:function(){var e=this.player,t=e.video,i=e.config;t.width=Number.parseInt(i.width||600),t.height=Number.parseInt(i.height||337.5),t.style.outline="none"}},{key:"initEvents",value:function(){var e=this.player;this.on(n.PLAY,this.play),this.on(n.URL_CHANGE,this.switchURL),this.on(n.DEFINITION_CHANGE,this.handleDefinitionChange),e.video.addEventListener("lowdecode",this.lowdecode),e.video.addEventListener("largeavgap",this.largeavgap)}},{key:"largeavgap",value:function(){this.emit("largeavgap",this.player.video.unsyncInfo)}},{key:"lowdecode",value:function(){var e=this.player;if(this.emit("lowdecode",e.video.degradeInfo),2===e.config.innerDegrade)return this._degrade(),void this._toUseMse();1===e.config.innerDegrade&&this._degrade(e.video.src)}},{key:"_degrade",value:function(e){var t=this.player,i=t.video;if(i&&"MVideo"===i.TAG){var r=t.video.degradeVideo;this.destroy(),t.video=r,i.degrade(e),e&&(t.config.url=e);var n=t.root.firstChild;"MVideo"===n.TAG&&t.root.replaceChild(r,n),t.once("canplay",function(){t.play()})}}},{key:"_toUseMse",value:function(){var e=this.player,t=e.config,i=t.backupConstructor,r=t.backupURL;i&&(e.config.url=r,e.registerPlugin(i).beforePlayerInit(),Promise.resolve().then(function(){e.video.src=e.url;var t=u.pluginName.toLowerCase();e.plugins[t]=null}))}},{key:"forceDegradeToVideo",value:function(e){this.player.removeClass("xgplayer-is-error");var t=this.player;if(2===t.config.innerDegrade)return t.config.backupURL=e,this._degrade(),void this._toUseMse();1===t.config.innerDegrade&&this._degrade(e)}},{key:"initHls",value:function(){this.hls=this._context.registry("HLS_CONTROLLER",Si)(),this.emit("core_inited",this.hls)}},{key:"play",value:function(){this.played&&(this._destroy(),this._initProcess()),this.played=!0}},{key:"loadData",value:function(){var e=this.player;this.hls&&this.hls.load(e.config.url)}},{key:"handleDefinitionChange",value:function(e){var t=e.to;this.switchURL(t)}},{key:"switchURL",value:function(e){this.player.config.url=e,this._destroy(),this.played=!1,this._initProcess()}},{key:"destroy",value:function(){Ri(Oi(u.prototype),"offAll",this).call(this),this._destroy()}},{key:"_destroy",value:function(){this._context&&this._context.destroy(),this.hls=null,this._context=null}},{key:"core",get:function(){return this.hls}},{key:"loader",get:function(){var e;return null===(e=this._context)||void 0===e?void 0:e.getInstance("TS_LOADER")}},{key:"context",get:function(){return this._context}}],r=[{key:"pluginName",get:function(){return"hlsLiveMobile"}},{key:"defaultConfig",get:function(){return Object.assign({},_i,{loadTimeout:1e4,preloadTime:10,retryTimes:3,retryCount:3,retryDelay:1e3})}},{key:"isSupported",value:function(){return function(){var e,t=!1,i=!1;try{var r=new(window.AudioContext||window.webkitAudioContext);r.close(),r=null,t=!0}catch(e){}try{for(var n=document.createElement("canvas"),a=["webgl","experimental-webgl","moz-webgl","webkit-3d"],s=0;s<a.length;s++){var o=n.getContext(a[s]);if(o){o=null,n=null,i=!0;break}}}catch(e){}if("customElements"in window&&window.customElements.define){var u=window.customElements.get("live-video");e=u&&u.isSupported()}return t&&i&&e}()}}],i&&Di(t.prototype,i),r&&Di(t,r),u}(r.Ay);const xi=Ui,Pi=yi},43507:(e,t,i)=>{i.d(t,{A:()=>h});var r=i(65907),n=i(96865);function a(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}],null&&a(t.prototype,null),i&&a(t,i),e}();function o(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?u(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var c=r.A.REMUX_EVENTS;const h=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){t.___videoLargeGap=e,Math.abs(e)>100&&t.emit(c.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){t.___audioLargeGap=e,Math.abs(e)>100&&t.emit(c.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}var t,i,r;return t=e,r=[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:o(e).sort(function(e,t){return e.dts-t.dts})}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=o(e).sort(function(e,t){return e.dts-t.dts}),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t){if(null!==e)return e-t>=1e4||t-e>=1e4}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return e-t>=5e3||t-e>=5e3}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,r=[],n=0,a=e.length;n<a;n++){var s=e[n];!s.options||!s.options.meta||t&&0===n||(i=!0,r.push(n))}return{changed:i,changedIdxes:r}}}],(i=[{key:"init",value:function(){this.before(c.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.lastVideoDuration=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"doFix",value:function(){var t=this.getFirstSample(),i=t.isFirstAudioSamples,r=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var n=e.detectChangeStream(this.videoTrack.samples,r),a=n.changed,s=n.changedIdxes;if(a){for(var o=!1,u=0;u<s.length;u++)this.fixChangeStreamVideo(s[u],r)&&(o=!0);o||this.doFixVideo(r)}else this.doFixVideo(r);var l=e.detectChangeStream(this.audioTrack.samples,i),c=l.changed,h=l.changedIdxes;if(c){for(var d=!1,f=0;f<h.length;f++)this.fixChangeStreamAudio(h[f],i)&&(d=!0);if(d)return;this.doFixAudio(i)}else this.doFixAudio(i);this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,i){for(var r=this.videoTrack,a=r.samples,s=r.meta,o=a.length,u=0;u<o;u++){var l=a[u];l.originDts=l.dts,l.originPts=l.pts}if(a&&o&&this._firstVideoSample){var h=a[0];if(n.A.log(this.TAG,"doFixVideo:: lastVideoDts: ".concat(this.lastVideoDts," ,  _videoLargeGap: ").concat(this._videoLargeGap," ,streamChangeStart:").concat(i,", lastVideoSample:[dts=").concat(this.videoLastSample&&this.videoLastSample.dts," , pts=").concat(this.videoLastSample&&this.videoLastSample.pts,"] ,  firstDTS:").concat(h.dts," ,cts:").concat(h.cts," firstPTS:").concat(h.pts," ,lastDTS:").concat(a[o-1].dts," , lastPTS: ").concat(a[o-1].pts)),!t&&null===this.videoLastSample&&h.options&&h.options.start&&void 0!==i&&(i=h.options.start),!t&&void 0===i&&this.videoLastSample&&e.detectVideoLargeGap(this.videoLastSample?this.videoLastSample.dts:0,h.dts+this._videoLargeGap)){var d=this.audioLastSample;d&&Math.abs(d.originDts-h.originDts)<100||(this._videoLargeGap=this.videoLastSample.dts+s.refSampleDuration-h.dts)}if(0!==this._videoLargeGap&&(this.doFixLargeVideoGap(a,this._videoLargeGap),this._videoLargeGap!==this.preVideoGap&&(this.preVideoGap=this._videoLargeGap,this.emit(c.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:this.videoLastSample&&this.videoLastSample.originDts,curDts:h.originDts,duration:s.refSampleDuration}))),t||void 0===i||(this._videoLargeGap=i-h.dts,this.doFixLargeVideoGap(a,this._videoLargeGap)),t&&this._firstAudioSample){var f=this._firstVideoSample.originDts,p=f-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(p>2*s.refSampleDuration&&p<10*s.refSampleDuration){for(var y=Math.floor(p/s.refSampleDuration),v=0;v<y;v++){var _=Object.assign({},h);_.dts=f-(v+1)*s.refSampleDuration,_.pts=_.dts+_.cts,a.unshift(_),this.filledVideoSamples.push({dts:_.dts,size:_.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(p)>2*s.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*p,this.doFixLargeVideoGap(a,-1*p))}var g=a.pop();if(a.length&&(a[a.length-1].duration=g.dts-a[a.length-1].dts),this.videoLastSample){var m=this.videoLastSample;m.duration=h.dts-m.dts,a.unshift(this.videoLastSample)}this.videoLastSample=g,a[a.length-1]&&(this.lastVideoDuration=a[a.length-1].duration,this.lastVideoDts=a[a.length-1].dts),this.videoTrack.samples=a}}},{key:"doFixAudio",value:function(t,i){var r=this,a=this.audioTrack,o=a.samples,u=a.meta;if(o&&o.length){this.fixAudioRefSampleDuration(u);for(var l=0,h=o.length;l<h;l++){var d=o[l];d.originDts=d.dts}var f,p=o.length,y=s.getSilentFrame(u.codec,u.channelCount),v=Math.floor(u.refSampleDuration),_=this._firstAudioSample,g=o[0];if(n.A.log(this.TAG,"doFixAudio:: audioDtsBase:".concat(this.audioDtsBase," ,  _audioLargeGap: ").concat(this._audioLargeGap,", streamChangeStart:").concat(i," ,  nextAudioDts:").concat(this.nextAudioDts,",  audio: firstDTS:").concat(g.dts," ,firstPTS:").concat(g.pts," ,lastDTS:").concat(o[p-1].dts," , lastPTS: ").concat(o[p-1].pts)),!t&&null===this.nextAudioDts&&g.options&&g.options.start&&void 0!==i&&(i=g.options.start),!t&&void 0===i&&this.nextAudioDts&&e.detectAudioLargeGap(this.nextAudioDts||0,g.dts+this._audioLargeGap)){var m=this.videoLastSample;if(m&&Math.abs(m.originDts-this.nextAudioDts)<150)this.nextAudioDts=g.dts;else{var E=this.nextAudioDts-g.dts;this._audioLargeGap=Math.abs(E-this._videoLargeGap)<200?this._videoLargeGap:E}}if(0!==this._audioLargeGap?(e.doFixLargeGap(o,this._audioLargeGap),this._audioLargeGap!==this.preAudioGap&&(this.preAudioGap=this._audioLargeGap,this.emit(c.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:this.lastAudioOriginDts,curDts:g.originDts,duration:v}))):t||void 0===i&&!e.detectAudioLargeGap(this.nextAudioDts,g.dts)||(void 0!==i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-g.dts,g.options.start&&!g.options.start.isContinue&&e.doFixLargeGap(o,this._audioLargeGap)),this._firstVideoSample&&t){var b=this._firstVideoSample.originDts||this._firstVideoSample.dts,k=_.dts-b;if(k===this._videoLargeGap);else if(y&&k>u.refSampleDuration&&k<10*u.refSampleDuration){for(var A=Math.floor((_.dts-b)/u.refSampleDuration),T=0;T<A;T++){var S={data:y,datasize:y.byteLength,dts:_.dts-(T+1)*u.refSampleDuration,filtered:0};o.unshift(S),this.filledAudioSamples.push({dts:S.dts,size:S.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else k<-1*u.refSampleDuration&&(this._audioLargeGap=-1*k,e.doFixLargeGap(o,-1*k))}var w=o[0].dts;if(this.nextAudioDts){f=w-this.nextAudioDts;var D=Math.abs(f);if(f>=v&&f<1e4&&y){for(var R=Math.ceil(f/v),L=0;L<R;L++){var B=w-(L+1)*v,O={dts:B>this.nextAudioDts?B:this.nextAudioDts,pts:B>this.nextAudioDts?B:this.nextAudioDts,datasize:y.byteLength,filtered:0,data:y};this.filledAudioSamples.push({dts:O.dts,size:O.data.byteLength}),this.audioTrack.samples.unshift(O),g=O}this.emit(c.DETECT_AUDIO_GAP,f,R)}else D<u.refSampleDuration&&D>0?(g.dts=this.nextAudioDts,g.pts=this.nextAudioDts):f<0&&D<v&&(e.doFixLargeGap(o,-1*f),this.emit(c.DETECT_AUDIO_OVERLAP,f))}for(var C=o[0].dts+v,U=1;U<o.length;){var x=o[U],P=x.dts-C;if(P<=-1*v)n.A.warn("drop 1 audio sample for ".concat(P," ms overlap")),o.splice(U,1);else if(y&&P>=10*v){var I=Math.round(P/v);if(I>1e3)break;n.A.warn(this.TAG,"inject ".concat(I," audio frame for ").concat(P," ms gap"));for(var M=0;M<I;M++){var G={data:y,datasize:y.byteLength,dts:C,originDts:C,filtered:0};o.splice(U,0,G),C+=v,U++}x.dts=x.pts=x.originDts=C,C+=v,U++}else x.dts=x.pts=x.originDts=C,C+=v,U++}var F=u.refSampleDuration-v;o.forEach(function(e,t){if(0!==t){var i=o[t-1];e.dts=e.pts=i.dts+i.duration}e.duration=v,r.audioUnsyncTime=r.audioUnsyncTime+F,r.audioUnsyncTime>=1&&(e.duration+=1,r.audioUnsyncTime-=1)});var V=o[o.length-1];this.lastAudioDts=V.dts;var N=V.duration;this.lastAudioSamplesLen=p,this.nextAudioDts=this.lastAudioDts+(N||v),this.lastAudioOriginDts=V.originDts,this.audioTrack.samples=e.sortAudioSamples(o),this.audioLastSample=V}}},{key:"fixChangeStreamVideo",value:function(e){n.A.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack,i=t.samples,r=t.meta,a=0===e&&this.lastVideoDuration?this.lastVideoDuration:r.refSampleDuration,s=0===e?this.lastVideoDts?this.lastVideoDts:this.getStreamChangeStart(i[0]):i[e-1].dts,o=i[e].dts,u=Math.abs(s-o)<=1e4;if(this.emit(c.DETECT_CHANGE_STREAM,"video",o),u)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},!1;this.emit(c.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:s,curDts:o,duration:a});var l,h=i.slice(0,e),d=i.slice(e),f=i[e];return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,this.lastVideoDuration=null,l=f.options&&void 0!==f.options.start?f.options.start:s-this.videoDtsBase,this.videoTrack.samples=i.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=i.slice(e),this.doFixVideo(!1,l),this.videoTrack.samples=h.concat(d),!0}},{key:"fixChangeStreamAudio",value:function(e){n.A.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack,i=t.samples,r=t.meta,a=0===e?this.lastAudioDts:i[e-1].dts,s=i[e].dts,o=Math.abs(a-s)<=1e4;if(this.emit(c.DETECT_CHANGE_STREAM,"audio",s),o)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},!1;this.emit(c.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:a,curDts:s,duration:r.refSampleDuration}),this._audioLargeGap=0;var u=this.nextAudioDts;this.nextAudioDts=null;var l,h=i.slice(0,e),d=i.slice(e),f=i[e];return f.options&&void 0!==f.options.start?l=f.options.start:(l=u,f.options.isContinue=!0),this.audioTrack.samples=h,this.doFixAudio(!1),this.audioTrack.samples=d,this.doFixAudio(!1,l),this.audioTrack.samples=h.concat(d),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,r=!1,n=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),r=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),n=!0),{isFirstVideoSamples:r,isFirstAudioSamples:n}}},{key:"fixVideoRefSampleDuration",value:function(t,i){if(t){var r=this.allVideoSamplesCount,n=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&i.length>=5){var s=(i[i.length-1].dts-i[0].dts)/(i.length-1);if(s>0&&s<1e3){var o=Math.floor(Math.abs(t.refSampleDuration-s)<=5?t.refSampleDuration:s);e.isRefSampleDurationValid(o)&&(t.refSampleDuration=o)}}}else if(i.length>=1){var u=i[i.length-1].dts;if(Math.abs(u-n)<100*i.length){var l=Math.floor((u-n)/(r+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(t,i){return t===e||t.dts>=e.dts})),t&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(e,i){return e===t||e.dts>=t.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"doFixLargeVideoGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t),this._audioLargeGap&&Math.abs(this._audioLargeGap-this._videoLargeGap)>1e6&&(this._videoLargeGap=t=this._audioLargeGap,n.dts+=t,n.pts&&(n.pts+=t))}}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}])&&l(t.prototype,i),r&&l(t,r),e}()},55384:(e,t,i)=>{function r(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}i.d(t,{A:()=>n});const n=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}var t,i;return t=e,(i=[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var r=new Uint8Array(e),n=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);r.set(a,n),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;r.set(this.array[0].slice(this.offset,this.array[0].length),n),this.array.shift(),this.offset=0,n+=s,this.length-=s,e-=s}return r}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;){var n;r<(null===(n=this.array[0])||void 0===n?void 0:n.length)?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++}return i}}])&&r(t.prototype,i),e}()},57759:(e,t,i)=>{i.d(t,{A:()=>T});var r=i(65907),n=i(96865),a=i(42990),s=i.n(a),o=i(23722),u=i.n(o);function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}const c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.buffer=t||new Uint8Array(0)}var t,i,r;return t=e,i=[{key:"write",value:function(){for(var e=this,t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(function(t){e.buffer=u()(Uint8Array,e.buffer,t)})}}],r=[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach(function(e){t+=e.toString(16).padStart(2,"0")}),parseInt(t,16)}}],i&&l(t.prototype,i),r&&l(t,r),e}();function h(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?d(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function f(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"size",value:function(e){return c.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var r=new c,n=arguments.length,a=new Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return r.write.apply(r,[e.size(t),e.type(i)].concat(a)),r.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var i,r=t.type,n=t.meta,a=8,s=e.mvhd(n.duration,n.timescale);i="video"===r?e.videoTrak(n):e.audioTrak(n);var o=e.mvex(n.duration,n.timescale||1e3,n.id);return[s,i,o].forEach(function(e){a+=e.byteLength}),e.initBox(a,"moov",s,i,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+r.length,"mvhd",new Uint8Array(r))}},{key:"videoTrak",value:function(t){var i=8,r=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),n=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,vvcC:t.vvcC,hvcCConfigParsed:t.hvcCConfigParsed,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"audioTrak",value:function(t){var i=8,r=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),n=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration,n=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new c,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,r=e.mdhd(t.timescale,t.duration),n=e.hdlr(t.type),a=e.minf(t);return[r,n,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"mdia",r,n,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments.length>1?arguments[1]:void 0,r=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+r.byteLength,"mdhd",e.extension(0,0),r)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,r="video"===t.type?e.vmhd():e.smhd(),n=e.dinf(),a=e.stbl(t);return[r,n,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"minf",r,n,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new c;return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),t.buffer}},{key:"stbl",value:function(t){var i=8,r=e.stsd(t),n=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[r,n,a,s,o].forEach(function(e){i+=e.byteLength}),e.initBox(i,"stbl",r,n,a,s,o)}},{key:"stsd",value:function(t){var i;return i="audio"===t.type?e.mp4a(t):36===t.streamType||t.vvcC?e.hvc1vvc1(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),r=e.esds(t.config);return e.initBox(8+i.byteLength+r.byteLength,"mp4a",i,r)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new c,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new c,r=t.width,n=t.height,a=t.parRatio.width,s=t.parRatio.height,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>8&255,255&r,n>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),h=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),h),i.buffer}},{key:"hvc1vvc1",value:function(t){var i=new c,r=[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17],n=!!t.vvcC,a=n?e.vvcC(t):e.hvcC(t),s=[e.type(n?"vvc1":"hvc1"),new Uint8Array(r)].concat(h(a));t.parRatio&&s.push.apply(s,h(e.pasp(t.parRatio)));var o=4+s.reduce(function(e,t){return e+t.byteLength},0);return s.unshift(e.size(o)),i.write.apply(i,h(s)),i.buffer}},{key:"hvcC",value:function(t){var i;if(t.hvcCConfigParsed){var r=t.hvcCConfigParsed,n=r.vpsArr,a=r.spsArr,s=r.ppsArr,o=r.hvcC,u=o.generalProfileCompatibilityFlags,l=o.generalConstraintIndicatorFlags,c=(n.length&&1)+(a.length&&1)+(s.length&&1);i=[1,o.generalProfileSpace<<6|o.generalTierFlag<<5|o.generalProfileIdc,u>>>24,u>>>16,u>>>8,u,l[0],l[1],l[2],l[3],l[4],l[5],o.generalLevelIdc,240,0,252,252|o.chromaFormatIdc,248|o.bitDepthLumaMinus8,248|o.bitDepthChromaMinus8,0,0,o.numTemporalLayers<<3|o.temporalIdNested<<2|3,c];var d=function(e){var t;i.push(e.length>>8,e.length),(t=i).push.apply(t,h(e))};n.length&&(i.push(160,0,n.length),n.forEach(d)),a.length&&(i.push(161,0,a.length),a.forEach(d)),s.length&&(i.push(162,0,s.length),s.forEach(d))}else i=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return[e.size(8+i.length),e.type("hvcC"),new Uint8Array(i)]}},{key:"vvcC",value:function(t){var i=t.vvcC;return[e.size(8+i.byteLength),e.type("vvcC"),i]}},{key:"fiel",value:function(){return[e.size(10),e.type("fiel"),new Uint8Array([1,0])]}},{key:"pasp",value:function(t){if(t.width&&t.height){var i=t.width,r=t.height;return[e.size(16),e.type("pasp"),new Uint8Array([i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r])]}return[]}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments.length>2?arguments[2]:void 0,r=new c,n=c.writeUint32(t);return r.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(i)),r.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,r=e.mfhd(),n=e.traf(t);return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"moof",r,n)}},{key:"mfhd",value:function(){var t=c.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,r=e.tfhd(t.id),n=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[r,n,s,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"traf",r,n,s,a)}},{key:"tfhd",value:function(t){var i=c.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),c.writeUint32(t))}},{key:"trun",value:function(t,i){var r=new c,n=c.writeUint32(t.samples.length),a=c.writeUint32(92+16*t.samples.length+i);return r.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),n,a),t.samples.forEach(function(e){var t=e.flags;r.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),r.buffer}},{key:"sdtp",value:function(t){var i=new c;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,r=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([r]))}),i.buffer}},{key:"mdat",value:function(t){var i=new c,r=8;t.samples.forEach(function(e){r+=e.size}),i.write(e.size(r),e.type("mdat"));var n=new Uint8Array(r),a=0;return n.set(i.buffer,a),a+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){n.set(e,a),a+=e.byteLength})}),n}}],null&&f(t.prototype,null),i&&f(t,i),e}();p.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},p.sequence=1;const y=p;function v(e){return v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},v(e)}function _(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function g(e,t){return g=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},g(e,t)}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}var E=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&g(e,t)}(u,e);var t,i,r,a,s,o=(a=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=m(a);if(s){var i=m(this).constructor;e=Reflect.construct(t,arguments,i)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==v(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function u(e){var t,i=e.videoMeta,r=e.audioMeta,n=e.curTime;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u),(t=o.call(this)).TAG="Fmp4Remuxer",t._dtsBase=1e3*n,t._videoMeta=i,t._audioMeta=r,t._audioDtsBase=null,t._videoDtsBase=null,t._isDtsBaseInited=!1,t.isFirstVideo=!0,t.isFirstAudio=!0,t.videoAllDuration=0,t.audioAllDuration=0,t.audioRemuxed=0,t.videoRemuxed=0,t.mp4Durations={keys:[]};var a=/Chrome\/([^.]+)/.exec(navigator.userAgent);return t.forceFirstIDR=a&&Number(a[1])<50,t}return t=u,r=[{key:"EVENTS",get:function(){return{MEDIA_SEGMENT:"MEDIA_SEGMENT",INIT_SEGMENT:"INIT_SEGMENT",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",TRACK_REMUXED:"TRACK_REMUXED"}}}],(i=[{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1,this.mp4Durations={keys:[]},this.removeAllListeners()}},{key:"remux",value:function(e,t){!this._isDtsBaseInited&&this.calcDtsBase(e,t),this.remuxVideo(t),this.remuxAudio(e),n.A.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){n.A.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"remuxInitSegment",value:function(e,t){n.A.log(this.TAG,"remuxInitSegment: type=",e,t);var i=new c,r=36===t.streamType?y.ftypHEVC():y.ftyp(),a=y.moov({type:e,meta:t});return i.write(r,a),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i,r=t.samples[0];return r.options&&r.options.start&&(i=r.options.start),this._videoDtsBase=r.dts-(i||this._dtsBase),void(this._isDtsBaseInited=!0)}if(e&&e.samples.length||t&&t.samples.length){var a=null,s=null,o=null;if(e&&e.samples&&e.samples.length){var u=e.samples[0];a=u.dts,u.options&&u.options.start&&(o=u.options.start)}if(t&&t.samples&&t.samples.length){var l=t.samples[0];s=l.dts,l.options&&l.options.start&&(o=l.options.start)}var c=a-s;c<0&&null!==o&&t.samples.forEach(function(e){e.dts-=c,e.pts&&(e.pts-=c)}),this._videoDtsBase=(s||a)-(o||this._dtsBase),this._audioDtsBase=(a||s)-(o||this._dtsBase),this._dtsBase=Math.min(s,a),this._isDtsBaseInited=!0,n.A.log(this.TAG,"calcDtsBase"),n.A.log(this.TAG,"video first dts: ".concat(s," , start:").concat(o," , _videoDtsBase:").concat(this._videoDtsBase," , _dtsBase:").concat(this._dtsBase)),n.A.log(this.TAG,"audio first dts: ".concat(a," , start:").concat(o," , _audioDtsBase:").concat(this._audioDtsBase,", _dtsBase:").concat(this._dtsBase))}}},{key:"remuxVideo",value:function(e){var t=this,i=e||{};if(e&&e.samples&&e.samples.length){var r=i.samples;if(i.meta){for(var a=-1,s=null,o=[],l={samples:[]},h=1e4,d=!0;r.length&&h-- >0;){var f=r.shift(),p=f.isKeyframe,v=f.options;if(!this.isFirstVideo&&v&&v.meta){s=this.remuxInitSegment("video",v.meta),v.meta=null,r.unshift(f),v.isContinue||(this._videoDtsBase=0);break}var _=Math.max(0,f.dts-this.videoDtsBase);-1===a&&(a=_);var g=void 0,m=void 0;void 0!==f.pts&&(g=(m=f.pts-this._dtsBase)-_),void 0!==f.cts&&(m=f.cts+_,g=f.cts);var E,b={buffer:[],size:0};E=f.duration?f.duration:r.length>=1?r[0].dts-this.videoDtsBase-_:o.length>=1?o[o.length-1].duration:this._videoMeta.refSampleDuration,this.videoAllDuration+=E,n.A.long&&n.A.log(this.TAG,"video dts ".concat(_),"pts ".concat(m),"cts: ".concat(g),p,"originDts ".concat(f.originDts),"duration ".concat(E),d),E>=0&&(l.samples.push(b),b.buffer.push(f.data),b.size+=f.data.byteLength,o.push({dts:_,cts:g,pts:m,data:f.data,size:f.data.byteLength,isKeyframe:p,duration:E,flags:{isLeading:0,dependsOn:p||this.forceFirstIDR&&d?2:1,isDependedOn:p?1:0,hasRedundancy:0,isNonSync:p||this.forceFirstIDR&&d?0:1},originDts:_,type:"video"}),d=!1,this.mp4Durations[m]=E,this.mp4Durations.keys.push(m)),p&&this.emit(u.EVENTS.RANDOM_ACCESS_POINT,m)}if(this.mp4Durations.keys.length>1e4){var k=this.mp4Durations;this.mp4Durations={},this.mp4Durations.keys=k.keys.slice(-100),this.mp4Durations.keys.forEach(function(e){t.mp4Durations[e]=k[e]})}o.length&&n.A.log(this.TAG,"remux to mp4 video:",[a/1e3,o[o.length-1].dts/1e3]);var A=new c;if(o.length&&i.meta){var T=y.moof({id:i.meta.id,time:a,samples:o}),S=y.mdat(l);A.write(T,S),this.segmentRemuxed("video",A,o[o.length-1].pts-o[0].pts)}if(s&&(this.segmentRemuxed("video",s),r.length))return i.samples=r,this.remuxVideo(i);this.isFirstVideo=!1,this.emit(u.EVENTS.TRACK_REMUXED,"video",A),i.samples=[],i.length=0}}}},{key:"remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],a=null,s={samples:[]};if(t&&t.length){for(var o=1e4,l=!1;t.length&&o-- >0;){var h=t.shift(),d=h.data,f=h.options;if(!this.isFirstAudio&&f&&f.meta){a=this.remuxInitSegment("audio",f.meta),f.meta=null,t.unshift(h),f.isContinue||(this._audioDtsBase=0);break}var p=Math.max(0,h.dts-this.audioDtsBase),v=h.originDts;l||(i=p,l=!0);var _;_=h.duration?h.duration:this._audioMeta.refSampleDurationFixed?this._audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this.audioDtsBase-p:r.length>=1?r[r.length-1].duration:this._audioMeta.refSampleDuration,n.A.long&&n.A.log(this.TAG,"audio dts ".concat(p),"pts ".concat(p),"originDts ".concat(v),"duration ".concat(_)),this.audioAllDuration+=_;var g={dts:p,pts:p,cts:0,size:d.byteLength,duration:h.duration?h.duration:_,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:v,type:"audio"},m={buffer:[],size:0};_>=0&&(m.buffer.push(d),m.size+=d.byteLength,s.samples.push(m),r.push(g))}var E=new c;if(r.length&&e.meta){n.A.log(this.TAG,"remux to mp4 audio:",[i/1e3,r[r.length-1].dts/1e3]);var b=y.moof({id:e.meta.id,time:i,samples:r}),k=y.mdat(s);E.write(b,k),this.segmentRemuxed("audio",E,r[r.length-1].dts-r[0].dts)}if(a&&(this.segmentRemuxed("audio",a),t.length))return e.samples=t,this.remuxAudio(e);this.isFirstAudio=!1,this.emit(u.EVENTS.TRACK_REMUXED,"audio",E),e.samples=[],e.length=0}}},{key:"segmentRemuxed",value:function(e,t,i){this.emit(u.EVENTS.MEDIA_SEGMENT,e,t,i)}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase},set:function(e){this._videoDtsBase=e}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}])&&_(t.prototype,i),r&&_(t,r),u}(s());function b(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var k=r.A.REMUX_EVENTS,A=r.A.PLAYER_EVENTS,T=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Mp4Remuxer",this._curTime=t,this.remuxer||this.initRemuxer()}var t,i;return t=e,(i=[{key:"init",value:function(){this.on(k.REMUX_MEDIA,this.remux.bind(this)),this.on(k.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(k.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(k.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(A.SEEK,this.seek.bind(this))}},{key:"initRemuxer",value:function(){this.remuxer=new E({audioMeta:null,videoMeta:null,curTime:this._curTime}),this.remuxer.on(E.EVENTS.MEDIA_SEGMENT,this.writeToSource.bind(this)),this.remuxer.on(E.EVENTS.TRACK_REMUXED,this.onTrackRemuxed.bind(this))}},{key:"remux",value:function(){if(this.remuxer&&this.videoTrack)try{this.remuxer._videoMeta||(this.remuxer._videoMeta=this.videoMeta,this.remuxer._audioMeta=this.audioMeta);var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;this.remuxer.remux(t,i)}catch(e){console.log(e),this.emit(k.REMUX_ERROR,this.TAG,e)}}},{key:"resetDtsBase",value:function(){this.remuxer&&this.remuxer.resetDtsBase()}},{key:"seek",value:function(e){this.remuxer&&this.remuxer.seek(e)}},{key:"onMetaDataReady",value:function(e,t){var i;this.remuxer||this.initRemuxer(),i="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.mimetype=i.meta.codec,n.init=this.remuxer.remuxInitSegment(e,i.meta),t&&this.writeToSource(e,n.init,0),this.emit(k.INIT_SEGMENT,e)}},{key:"onTrackRemuxed",value:function(e){this.emit(k.MEDIA_SEGMENT,e)}},{key:"writeToSource",value:function(e,t,i){var r=this._context.getInstance("PRE_SOURCE_BUFFER"),n=r.getSource(e);n||(n=r.createSource(e)),n.data.push(t),i&&(n.bufferDuration=i+(n.bufferDuration||0))}},{key:"videoTrack",get:function(){return this._context.getInstance("TRACKS").videoTrack}},{key:"audioTrack",get:function(){return this._context.getInstance("TRACKS").audioTrack}},{key:"videoMeta",get:function(){return this.videoTrack.meta}},{key:"audioMeta",get:function(){return this.audioTrack.meta}},{key:"destroy",value:function(){this.remuxer&&this.remuxer.destroy(),this.remuxer=null}}])&&b(t.prototype,i),e}()},60877:(e,t,i)=>{i.d(t,{A:()=>_});var r=i(65907);function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.mimeType=null,this.duration=null,this.hasVideo=!1,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=!1,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}var t,i,r;return t=e,r=[{key:"isBaseInfoReady",value:function(e){return a(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||a(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||a(e.video)}}],(i=[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}])&&n(t.prototype,i),r&&n(t,r),e}(),o=i(42990),u=i.n(o);function l(e){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l(e)}function c(e,t,i){return c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}},c(e,t,i||e)}function h(e,t){return h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},h(e,t)}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,i){return t&&p(e.prototype,t),i&&p(e,i),e}var v="__TO__";const _=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];f(this,e),this._emitter=new(u()),this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new s,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=r,this._configs=i,this._player=t,this._hooks={}}return y(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],a=i[1],s=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error("".concat(e,"未在context中注册"))}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),a=this,s=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&h(e,t)}(u,t);var i,s,o=(i=u,s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}(),function(){var e,t=d(i);if(s){var r=d(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return function(e,t){return!t||"object"!==l(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(this,e)});function u(t,i,r){var n;return f(this,u),(n=o.call(this,t,i,r)).listeners={},n.onceListeners={},n.TAG=e,n._context=a,n}return y(u,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on("".concat(t).concat(v).concat(e),i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once("".concat(t).concat(v).concat(e),i),r.once(t,i)}},{key:"emit",value:function(e){n(e);for(var t=a._hooks?a._hooks[e]:null,i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];if(t)for(var u=0,l=t.length;u<l;u++)t[u].apply(void 0,s);return r.emit.apply(r,[e].concat(s))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return r.emit.apply(r,["".concat(t).concat(v).concat(e)].concat(a))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],a=0;a<n.length;a++){var s=n[a];r.off(i,s),r.off("".concat(i).concat(v).concat(e),s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var c=u[l];r.off(o,c),r.off("".concat(o).concat(v).concat(e),c)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],c(d(u.prototype),"destroy",this))return c(d(u.prototype),"destroy",this).call(this);this._context=null}},{key:"_player",get:function(){return this._context?this._context._player:null},set:function(e){this._context&&(this._context._player=e)}},{key:"_pluginConfig",get:function(){return this._context?this._context._configs:null}}]),u}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"seek",value:function(e){this._emitter.emit(r.A.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this.destroyInstances(),this._emitter&&this._emitter.removeAllListeners(),this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._hooks=null,this._player=null,this._configs=null}},{key:"_isMessageNameValid",value:function(e){if(this.allowedEvents&&this.allowedEvents.length&&!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: ".concat(e))}}]),e}()},65907:(e,t,i)=>{i.d(t,{A:()=>y});var r={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},n={SEEK:"SEEK"},a={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY",LOADER_TTFB:"LOADER_TTFB"},s={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO",ISKEYFRAME:"ISKEYFRAME"},o={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},u={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR",MSE_WRONG_TRACK_ADD:"MSE_WRONG_TRACK_ADD",MSE_CHANGE_CODEC_ERROR:"MSE_CHANGE_CODEC_ERROR"},l={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},c=Object.assign({},a,s,o,u,l,n,r),h=[],d=[];for(var f in c)c.hasOwnProperty(f)&&h.push(c[f]);for(var p in c)c.hasOwnProperty(p)&&d.push(c[p]);const y={ALLEVENTS:c,HLS_EVENTS:l,REMUX_EVENTS:o,DEMUX_EVENTS:s,MSE_EVENTS:u,LOADER_EVENTS:a,FlvAllowedEvents:h,HlsAllowedEvents:d,CRYPTO_EVENTS:{START_DECRYPTOO:"START_DECRYPTO",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:n,BROWSER_EVENTS:r}},87429:(e,t,i)=>{i.d(t,{A:()=>o});var r=i(65907),n=i(96865);function a(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=r.A.MSE_EVENTS;const o=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.TAG="MSE",this.configs=Object.assign({},t),this.container=this.configs.container,this.format=this.configs.format,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1,this.videoCodec=""}var t,i,r;return t=e,i=[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(t,i){if(this._context=t,this.emit=t._emitter.emit.bind(t._emitter),!i)for(var r=0;r<Object.keys(this.sourceBuffers).length;r++){var n=this.sourceBuffers[Object.keys(this.sourceBuffers)[r]];n.updating||e.clearBuffer(n)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(s.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e,t=this._context.getInstance("PRE_SOURCE_BUFFER"),i=this._context.getInstance("TRACKS");if(t&&i){t=t.sources;for(var r=!1,a=0,o=Object.keys(t).length;a<o;a++){var u=Object.keys(t)[a];r=!1,"audio"===u?e=i.audioTrack:"video"===u&&(e=i.videoTrack),e&&null!==t[u].init&&t[u].data.length&&(r=!0)}if(r){if(Object.keys(this.sourceBuffers).length>1)return;for(var l=0,c=Object.keys(t).length;l<c;l++){var h=Object.keys(t)[l];if(!this.sourceBuffers[h]){var d=t[h],f="video"===h?"video/mp4;codecs="+d.mimetype:"audio/mp4;codecs="+d.mimetype;try{n.A.log(this.TAG,"add sourcebuffer",f);var p=this.mediaSource.addSourceBuffer(f);this.sourceBuffers[h]=p,p.addEventListener("updateend",this.onUpdateEnd),"video"===h&&(this.videoCodec=d.mimetype)}catch(e){if(22===e.code&&Object.keys(this.sourceBuffers).length>0)return this.emit(s.MSE_WRONG_TRACK_ADD,h);this.emit(s.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){if(this.mediaSource&&"closed"!==this.mediaSource.readyState){try{this._doCleanupSourceBuffer()}catch(e){}var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e&&!(Object.keys(this.sourceBuffers).length<this.sourceBufferLen))for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i];if(!r.updating){var n=e.sources[i];if(this["no".concat(i)])n.data=[],n.init.buffer=null;else if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var a=n.data.shift();if(a)try{r.appendBuffer(a.buffer.buffer)}catch(e){n.data.unshift(a)}}}}}}},{key:"changeVideoCodecType",value:function(e){var t=this.sourceBuffers.video;if(null!=t&&t.updating)throw new Error("source buffer in updating");t.changeType("video/mp4;codecs=".concat(e)),this.videoCodec=e}},{key:"endOfStream",value:function(){try{var e;"open"===this.mediaSource.readyState&&null!==(e=this.container)&&void 0!==e&&e.readyState&&this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||e>t&&r.remove(t,e)}}catch(e){}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var r=Object.keys(this.sourceBuffers)[i],n=this.sourceBuffers[r],a=n.buffered,s=!1,o=0;o<a.length;o++){var u=a.start(o),l=a.end(o);if(u<=e&&e<l+3){if(e-u>=180){s=!0;var c=e-180;t[r].push({start:u,end:c})}}else l<e&&e-u>=180&&(s=!0,t[r].push({start:u,end:l}))}s&&!n.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],r=e[t];r.length&&!i.updating;){var n=r.shift();try{n&&n.end>n.start&&i.remove(n.start,n.end)}catch(e){}}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],r=function(r){var n,a=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n=a.updating?new Promise(function(t){a.addEventListener("updateend",function i(){var r=3;setTimeout(function i(){a.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(a),a.addEventListener("updateend",function(){t()}))},200),a.removeEventListener("updateend",i)})}):new Promise(function(t){a.buffered.length?(e.clearBuffer(a),a.addEventListener("updateend",function(){t()})):t()}).catch(function(){}),i.push(n)},n=0;n<Object.keys(this.sourceBuffers).length;n++)r(n);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var a;a=n.updating?new Promise(function(t){n.addEventListener("updateend",function i(){var r=3;setTimeout(function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",function(){t()}))},200),n.removeEventListener("updateend",i)})}):new Promise(function(t){n.buffered.length?(e.clearBuffer(n),n.addEventListener("updateend",function(){t()})):t()}).catch(function(){}),i.push(a)},n=0;n<Object.keys(this.sourceBuffers).length;n++)r(n);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then(function(){for(var t=Object.keys(e.sourceBuffers),i=0;i<t.length;i++){var r=e.sourceBuffers[t[i]];delete e.sourceBuffers[t[i]],"open"===e.mediaSource.readyState&&e.mediaSource.removeSourceBuffer(r)}e.endOfStream();try{window.URL.revokeObjectURL(e.url)}catch(e){}e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1,e.onSourceOpen=null,e.onTimeUpdate=null,e.onUpdateEnd=null,e.onWaiting=null,e.noaudio=void 0,e.novideo=void 0})):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",get:function(){if(!this._url)try{this._url=window.URL.createObjectURL(this.mediaSource)}catch(e){}return this._url},set:function(e){this._url=e}}],r=[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);e.remove(0,i)}catch(e){}}}],i&&a(t.prototype,i),r&&a(t,r),e}()},93425:(e,t,i)=>{i.d(t,{A:()=>c});var r=i(65907);function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"_sampleQueue",[]),a(this,"_speed",0),a(this,"_recentSpeed",0),a(this,"_timer",0),a(this,"_dit",0),a(this,"_contentLength",0),a(this,"_totalByteSize",0),a(this,"_speedDown",!1)}var t,i;return t=e,(i=[{key:"recordLoading",value:function(e){var t=e.get("content-length")||0,i=e.get("Accept-Ranges"),r=e.get("Content-Range");if(t&&!i&&!r){this._contentLength=t;var n=Math.floor(t/this._speed*1e3);n<50||(this._dit=performance.now(),this._startTick(t,n))}}},{key:"recordLoaded",value:function(){this._cleanTimer();var e=performance.now()-this._dit;this._addSample(Math.floor(this._contentLength/e))}},{key:"recordChunk",value:function(e){if(!this._timer)return this._dit=performance.now(),void this._startTickForStream();this._totalByteSize+=e,this._contentLength+=e}},{key:"_startTick",value:function(e,t){var i=this;this._cleanTimer(),this._timer=setInterval(function(){var t=performance.now()-i._dit;i._addSample(Math.floor(e/t))},t)}},{key:"_startTickForStream",value:function(){var e=this;this._timer=setInterval(function(){e._addSample(e._calcSampleSpeed())},1e3)}},{key:"_calcSampleSpeed",value:function(){var e=performance.now()-this._dit,t=Math.floor(this._contentLength/e);return this._contentLength=0,this._dit=performance.now(),t}},{key:"_addSample",value:function(e){this._recentSpeed=1e3*e,this._sampleQueue.length>3&&(this._sampleQueue=[]),this._sampleQueue.push(e),this._calcAvgSpeed(this._sampleQueue)}},{key:"_calcAvgSpeed",value:function(e){var t=e.length,i=e.reduce(function(e,t){return e+t},0)/t;this._speed=1e3*Math.floor(i)}},{key:"_cleanTimer",value:function(){clearTimeout(this._timer),this._timer=0}},{key:"clean",value:function(){this._cleanTimer()}},{key:"destroy",value:function(){clearTimeout(this._timer)}},{key:"totalByteSize",get:function(){return this._totalByteSize}},{key:"avgSpeed",get:function(){return this._speed||this._addSample(this._calcSampleSpeed()),8*this._speed}},{key:"recentSpeed",get:function(){return this._recentSpeed||this._addSample(this._calcSampleSpeed()),8*this._recentSpeed}}])&&n(t.prototype,i),e}();function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function u(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var l=r.A.LOADER_EVENTS;const c=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0,this._ttfbInfo=null,this._responseHeader=null,this._speed=new s,window.AbortController&&(this.abortControllerEnabled=!0)}var t,i,r;return t=e,i=[{key:"init",value:function(){this.on(l.LADER_START,this.load.bind(this))}},{key:"fetch",value:function(e){function t(t,i,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t,i){var r=this,n=null;this.abortControllerEnabled&&(this.abortController=new window.AbortController),Object.assign(t,{signal:this.abortController?this.abortController.signal:void 0});var a=(new Date).getTime();return Promise.race([fetch(e,t),new Promise(function(e,t){n=setTimeout(function(){t({code:999,message:"fetch timeout"}),r.abortController&&r.abortController.abort()},i||1e4)})]).then(function(t){var i;n&&(clearTimeout(n),n=null),null===(i=r._speed)||void 0===i||i.recordLoading(t.headers);var s=(new Date).getTime();return r._ttfbInfo={url:e,responseUrl:t.url,start:a,end:s,elapsed:s-a,ok:t.ok},r.emit(l.LOADER_TTFB,r._ttfbInfo),t})})},{key:"internalLoad",value:function(e,t,i,r){var n=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6?arguments[6]:void 0;if(!this._destroyed)return this.loading=!0,this.fetch(this.url,t,s).then(function(u){if(!n._destroyed&&n.emit(l.LOADER_RESPONSE_HEADERS,n.TAG,u.headers),n._responseHeader=u.headers,u.ok)return n.status=u.status,Promise.resolve().then(function(){n._onFetchResponse(u,o)}),Promise.resolve(u);i-- >0?n._retryTimer=setTimeout(function(){return n.emit(l.LOADER_RETRY,n.TAG,{response:u,reason:"response not ok",retryTime:r-i}),n.internalLoad(e,t,i,r,a,s,o)},a):(n.loading=!1,n.emit(l.LOADER_ERROR,n.TAG,{code:u.status||21,message:"".concat(u.status," (").concat(u.statusText,")")}))}).catch(function(u){if(n._destroyed||u&&"AbortError"===u.name)n.loading=!1;else if(i-- >0)n._retryTimer=setTimeout(function(){return n.emit(l.LOADER_RETRY,n.TAG,{error:u,reason:"fetch error",retryTime:r-i}),n.internalLoad(e,t,i,r,a,s,o)},a);else{if(n.loading=!1,u&&"AbortError"===u.name)return;n.emit(l.LOADER_ERROR,n.TAG,Object.assign({code:21},u))}})}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=i.retryCount,n=i.retryDelay,a=i.loadTimeout,s=i.maxReaderInterval;if(e){r=void 0===r?3:r,this.url=e,this._canceled=!1;var o=this.getParams(t);return this.internalLoad(e,o,r,r,n,a,s)}this.emit(l.LOADER_ERROR,this.TAG,{code:0,message:"empty url"})}},{key:"_onFetchResponse",value:function(e,t){var i=this,r=this,n=this._context.getInstance(this.buffer);this._loaderTaskNo++;var a=this._loaderTaskNo;if(!0===e.ok){var s;switch(this.readtype){case 2:s=e.json();break;case 1:s=e.text();break;case 3:s=e.arrayBuffer();break;default:return this._onReader(e.body.getReader(),a,t)}if(!s)return;s.then(function(e){var t;null===(t=i._speed)||void 0===t||t.recordLoaded(),r.loading=!1,r._canceled||r._destroyed||(n?(n.push(e instanceof ArrayBuffer?new Uint8Array(e):e),r.emit(l.LOADER_COMPLETE,n)):r.emit(l.LOADER_COMPLETE,e))}).catch(function(){})}}},{key:"_onReader",value:function(e,t,i){var r=this,n=this._context.getInstance(this.buffer);if(!n&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&(this._noDataTimer=setTimeout(function(){!1!==r.loading&&r.emit(l.LOADER_COMPLETE,"nobuffer")},i||3e3),this._reader&&this._reader.read().then(function(a){var s,o;if(clearTimeout(r._noDataTimer),!r._canceled&&!r._destroyed)return a.done?(r.loading=!1,r.status=0,null===(o=r._speed)||void 0===o||o.destroy(),void Promise.resolve().then(function(){r.emit(l.LOADER_COMPLETE,"done")})):(n.push(a.value),null===(s=r._speed)||void 0===s||s.recordChunk(a.value.byteLength),Promise.resolve().then(function(){r.emit(l.LOADER_DATALOADED,n)}),r._onReader(e,t,i));if(r._reader)try{r._reader.cancel()}catch(e){}}).catch(function(e){clearTimeout(r._noDataTimer),r.loading=!1,(!e||"AbortError"!==e.name&&"network error"!==e.message)&&r.emit(l.LOADER_ERROR,r.TAG,e)}))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,r={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===o(this.configs.headers)){var n=this.configs.headers;for(var a in n)n.hasOwnProperty(a)&&i.append(a,n[a])}if("object"===o(t.headers)){var s=t.headers;for(var u in s)s.hasOwnProperty(u)&&i.append(u,s[u])}return!1===t.cors&&(r.mode="same-origin"),t.withCredentials&&(r.credentials="include"),r}},{key:"ttfbInfo",get:function(){return this._ttfbInfo}},{key:"avgSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.avgSpeed)||0}},{key:"recentSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.recentSpeed)||0}},{key:"currentSpeed",get:function(){var e;return(null===(e=this._speed)||void 0===e?void 0:e.avgSpeed)/8e3}},{key:"totalByteSize",get:function(){var e;return null===(e=this._speed)||void 0===e?void 0:e.totalByteSize}},{key:"responseHeader",get:function(){return this._responseHeader}},{key:"cancel",value:function(){var e;if(this._reader){try{var t=this._reader.cancel();t.catch&&t.catch(function(e){})}catch(e){}this._reader=null,this.loading=!1}clearTimeout(this._noDataTimer),this._canceled=!0,this.abortController&&this.abortController.abort(),null===(e=this._speed)||void 0===e||e.clean()}},{key:"destroy",value:function(){var e;this._destroyed=!0,this._responseHeader=null,clearTimeout(this._retryTimer),clearTimeout(this._noDataTimer),this.cancel(),null===(e=this._speed)||void 0===e||e.destroy(),this._speed=null}}],r=[{key:"isSupported",value:function(){return!!window.fetch}},{key:"type",get:function(){return"loader"}}],i&&u(t.prototype,i),r&&u(t,r),e}()},96865:(e,t,i)=>{function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}i.d(t,{A:()=>a});const a=new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{var i=/xgd=(\d)/.exec(document.cookie);this._status=!!i,this._level=i&&i[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error","trace"].forEach(function(e){t[e]=function(i,n,a,s,o,u,l,c,h,d){var f,p;if(t._status){var y=i,v=[n,a,s,o,u,l,c,h,d].filter(function(e){return void 0!==e});(f=console)[e].apply(f,["["+y+"]:"].concat(function(e){if(Array.isArray(e))return r(e)}(p=v)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(p)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}(p)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))}}})}var t,i;return t=e,(i=[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}])&&n(t.prototype,i),e}())}}]);